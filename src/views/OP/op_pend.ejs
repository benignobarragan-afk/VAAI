<%- include('../partials/header'); %>

<script type="text/javascript">
	webix.ready(()=>{
		webix.ui({
			rows:[
			{
				cols:[
				{
					cols:[{
						view:"button", type:"icon", icon:"mdi mdi-sync", width:33, click:()=>{genera()}
					},
					{
						view:"button", type:"icon", icon:"mdi mdi-arrow-expand-all", tooltip:"Expandir cuadricula", width:40,
						click:()=>{
							$$(`dtable`).adjustRowHeight();
						}
					},
					]
				},
				{
					view:"label", label:"Oficios pendientes de firmar y enviar", align:"center"
				},
				{
					cols:[
					{},
					//{
					//	view:"button", label:"Vista antigua", width:150, click:()=>{location.href = '/op/op_pend_old'}
					//}
					]
				}
				]
			},
			{
				view:"datatable", id:"dtable", select:true, footer:true, editable:true, hidden:false, minHeight:500, scroll:true,
				resizeColumn: true,  navigation: true, resizeRow:true, css:"celda_compacta", 
				rightSplit:1, leftSplit:3,
				scheme: {
					$init: function (obj) {
						obj.fecha = (obj.fecha ? (obj.fecha == '01/01/1900'?'': convertDate(obj.fecha) ) : '');
					}
				},

				columns:[
				{
					id: "detalle", width: 60,sort: "int", css: { 'text-align': 'center' }, 
					header: [{text:"",css:"my_style"}, {text:""}],
					template:(obj)=>{
						return `
							<a href="#" onClick="window.parent.deta_sali('${obj.cve}',${obj.idoficio},${obj.anio},${obj.id_iden},'op_reof0.fwx');">
								<i style='font-size:26px;color:#2b96cc;' class='fa-solid fa-magnifying-glass'></i>
							</a>`
					}
				},
				{
					id: "doc", width: 80,sort: "int", css: { 'text-align': 'left' }, hidden:false,
					header: [{text:"Doc.",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
					template:(obj)=>{
						if(obj.doc != ''){
					//		return `<a href="#" onClick="window.open('${obj.doc}');">
					//			<img alt="Detalle del oficio" src="/imagenes/word.png" width="28" height="28" border="0">
					//		</a>`
                    return `<div class='webix_el_button' style='cursor: pointer;' align='center'><a href='${obj.doc}' target='_blank'><i style='font-size:32px;color:#2b96cc;' class='far fa-file-word'></i></a></div>`
						}else{
							//return ''
							return `<input type="button" name="btnGenera" id="btnGenera" value="Generar" 
								onclick="gene_gdoc('${obj.cve.trim()}','${obj.idoficio}','${obj.anio}','${obj.id}' );">`
						}
					},
				},
				{
					id: "rank", width: 70,sort: "int", css: { 'text-align': 'center' }, 
					header: [{text:"#",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
				},	
				{
					id: "oficio", width: 150,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Oficio",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
				},	
				{
					id: "fecha", header: ["Fecha", { content: "textFilter", compare:dateStringFilter }], sort: "date", width: 100, format:webix.Date.dateToStr("%d/%m/%Y")
				},	
				{
					id: "hora", header: ["Hora", { content: "textFilter"}], width: 70,
				},	
				{
					id: "centros", width: 300,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Centros",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
				},		
				{
					id: "concepto", 
					$height:160, 
					fillspace:true, minWidth:300,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Concepto",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
						
					}],
				},		
				{
					id: "referencia", width: 70,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Ref.",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
				},		
				{
					id: "anexo", width: 70,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Anexo",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
				},	
				{
					id: "solicitado", width: 70,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Solic.",css:"my_style"}, {
						content: "textFilter", placeholder:"Filtrar",
					}],
				},		
				{
					id: "stat_desc", width: 100,sort: "string", css: { 'text-align': 'left' }, 
					header: [{text:"Status",css:"my_style"}, {
						content: "selectFilter", placeholder:"Filtrar",
					}],
				},
				],
			},
			{
				height:30
			}]
		})
		webix.extend($$("dtable"), webix.ProgressBar)
		genera()
	})

	const genera = ()=>{
		$$("dtable").clearAll()
		$$("dtable").load("/api/op/op_oficx5?t=2&cve=<%=lcCVE%>")
	}

	function gene_gdoc(lcCve,lcIdoficio,lcFecha,lnIden){

		// parent.myTabbar.tabs('a1').progressOn();

		setTimeout(function()
		{
			loader = dhx4.ajax.postSync("/api/op/op_gofic.fwx", "lcCve="+lcCve+"&lcIdoficio="+lcIdoficio+"&lcFecha="+lcFecha+"&lnIden="+lnIden);

			var result1 = loader.xmlDoc.responseXML.getElementsByTagName("mensaje");
			var result2 = loader.xmlDoc.responseXML.getElementsByTagName("error");

			alert(result1[0].firstChild.nodeValue);

			if(result2[0].firstChild.nodeValue == ".F.") window.location.reload();
			else parent.myTabbar.tabs('a1').progressOff();
			
		},2000);
	}


	function acusar(lnIden){
		Swal.fire({
			title: '�Seguro de regenerar el documento?',text: "Se eliminar� el actual y se generar� uno nuevo con la informaci�n guardada",
			icon: 'warning',showCancelButton: true,confirmButtonColor: '#3085d6',cancelButtonColor: '#d33',confirmButtonText: 'Si',cancelButtonText: 'Cancelar'
		}).then((result) => {
			if (result.isConfirmed) {
				webix.ajax().post("/<%//Response.Write(config.ruta)%>/op_soficx.fwx", {lnTipo:4, lnIDIden:lnIden}).then((res)=>{
					res = res.json()
					Swal.fire({text:res.message, icon:res.status?"success":"error"}).then(()=>{
						if(res.status){
							window.location.href = '/<% //Response.Write(config.ruta)%>/op_pend.fwx?lcCVE=<% //Response.write(lcCVE)%>';
						}
					})
				})
			}
		})
	}


	// function acusar(lnIden){
	// 	if(confirm("�Marcar en acuse el oficio?")){
	// 		loader = dhx4.ajax.postSync("/<%//Response.Write(config.ruta)%>/op_soficx.fwx", "lnIDIden="+lnIden+"&lnTipo=4");

	// 		var result1 = loader.xmlDoc.responseXML.getElementsByTagName("mensaje");
	// 		var result2 = loader.xmlDoc.responseXML.getElementsByTagName("error");

	// 		alert(result1[0].firstChild.nodeValue);

	// 		if(result2[0].firstChild.nodeValue == ".F.") window.location.href = '/<% //Response.Write(config.ruta)%>/op_pend.fwx?lcCVE=<% //Response.write(lcCVE)%>';
	// 		else return false;
	// 	}
	// }
</script>
<body>

</body>
</html>



