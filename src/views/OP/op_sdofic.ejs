<!DOCTYPE html>
<html>

<head>
	<title></title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<link rel="stylesheet" href="/style.css" type="text/css" media="screen" />
	<link rel="stylesheet" type="text/css" href="/skins/web/dhtmlx.css" />
	<link rel="stylesheet" type="text/css" href="/skins/terrace/dhtmlx.css" />
	<link rel="stylesheet" type="text/css" href="/webix/codebase/webix.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.css" type="text/css" charset="utf-8">
	<link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.7.94/css/materialdesignicons.css?v=6.0.7"
	type="text/css" charset="utf-8">

	<script src="/codebase/dhtmlx.js"></script>
	<script src="/webix/codebase/webix.js"></script>
	<script src="/webix/codebase/locale.js"></script>
	<script src="/js/funciones_webix.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />

		<%
        /*
LOCAL llError, lcCentro, lcPie, llAplicar, lnOficio, lcOficio, lcPrevio, lnMens_usua
LOCAL llNBusca, lcCVE, lcIniciales, lnIden, lcRuta_tabl
LOCAL lcDiri_nomb, lnDiri_codi, lcDiri_carg, lcAten_nomb, lnAten_codi, lcAten_carg, llNBusca2, lnCant_ofic

SET PROCEDURE TO mylib
SET DATE DMY

IF !Derechos("OFICIO")
		lcRuta = ALLTRIM(config.ruta)
		SET PROCEDURE TO
		CLOSE TABLES ALL
		CLOSE DATABASES ALL
		response.redirect("/"+lcRuta+"/sin_derechos.fwx")
ENDIF
	
llEdita = Derechos("OP_EDITA")
llEdit_ofic     = Derechos("TOT_DIRE")
lcCVE	= PADR(ALLTRIM(Request.QueryString("lcCVE")),6)
lnOfic	= VAL(Request.QueryString("lnOfic"))
lcAnio	= ALLTRIM(Request.QueryString("lnAnio"))
lnIden  = VAL(Request.QueryString("lnIden"))
lcQbase_cgce = config.qbase_cgce

lnCone_cgce = &lcQbase_cgce

lcSQL = "SELECT o.*, c.clave as cclave, c.descrip as cdescrip, oc.clave as oclave, oc.descrip as odescrip "
lcSQL = lcSQL + " FROM gen_oficio o LEFT JOIN gen_centros c ON o.id_cent = c.id_cent "
lcSQL = lcSQL + " LEFT JOIN gen_otro_cent oc ON o.id_cent = oc.id_cent "
lcSQL = lcSQL + " WHERE o.id_iden = ?lnIden "

IF SQLEXEC(lnCone_cgce, lcSQL, "cOficio") != 1
	a=Aerror(Mat)
	SQLDISCONNECT(0)
	Response.write(Mat(2))
	return 
ENDIF


IF SQLEXEC(lnCone_cgce, "SELECT * FROM gen_dere_ofic WHERE user_id = ?pcUser AND cve = ?lcCVE", "dere_ofic") != 1
	a=Aerror(Mat)
	SQLDISCONNECT(0)
	Response.write(Mat(2))
	return 
ENDIF

lcSQL = "SELECT id_cent, cve, depen, clave FROM GEN_TIPO_OFIC WHERE cve in (SELECT DISTINCT cve "
	lcSQL = lcSQL + "FROM GEN_DERE_OFIC WHERE user_id = ?pcUser) ORDER BY 3"

	lcQbase_cgce = config.qbase_cgce

	lnCone_cgce = &lcQbase_cgce
	IF SQLEXEC(lnCone_cgce, lcSQL, "cSoli") != 1
		a=Aerror(Mat)
		?SQLDISCONNECT(0)
		Response.write(Mat(2) + " Linea: 79")
		return
	ENDIF



IF SQLEXEC(lnCone_cgce, "SELECT * FROM gen_ofic_stat", "ofic_stat") != 1
	a=Aerror(Mat)
	SQLDISCONNECT(0)
	sdsd
ENDIF

IF SQLEXEC(lnCone_cgce, "SELECT * FROM opc_op_config", "op_config") != 1
	a=Aerror(Mat)
	SQLDISCONNECT(0)
	sdsd
ENDIF

SQLDISCONNECT(0)
*/
%>


	<style type="text/css">
		.dhtmlx-error {
			font-weight: bold;
			color: white;
			background-color: #770000;
		}

		.webix_dtable .webix_ss_header {
			font-weight: bold;
		}

		.edited {
			font-weight: bold;
		}

		.deleted {
			text-decoration: line-through;
		}

		.footer {
			font-weight: bold;
		}

		.highlight-red {
			background-color: #FF8181;
			/*font-weight: bold;*/
			color: white;
		}

		.highlight-red.webix_row_select{
			background: #FF6C6C !important;
			color: white !important;
		}

		.highlight-green {
			background-color: #9BFFA1;
			/*font-weight: bold;*/
			color: black;
		}

		.highlight-light-yellow{
			background-color: #FFFF6E;
			color: black;
		}
	</style>
</head>

<body>
	<script>
		
		
		
		var w1;
		var mygrid;
		var section = [
		{
			rows: [
			{
				view: "radio", id: "cmbTipo_depe", name: "cmbTipo_depe", value: 1, inputWidth: 1000,
				options: [
				{ id: 1, value: "U. de G." },
				{ id: 2, value: "Ajena U. de G." },
				],
				on: {
					onChange: function (id) {
						if (id == 1) {
							$$("cmbServicio").show();
							$$("cmbAjena").hide();
						} else {
							$$("cmbServicio").hide();
							$$("cmbAjena").show();
						}
					}
				}
			},
			{
				cols: [
				{
					view: "combo", id: "cmbServicio", name: "cmbServicio", labelPosition: "top", labelAlign: "left",
					label: "Servicio", width: 300, inputWidth: 300, editable: true,
					options: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 1000,
						body: {
							yCount: 6, fitMaster: false, width: 600, template: "#value#", dataFeed: "/api/gen/cmb_depew?lnTipo=1"
						}
					},
					on: {
						onChange: function (id) {
							dirigido(id);
						}
					}
				},

				{
					view: "text", id: "cmbAjena", name: "cmbAjena", labelPosition: "top", labelAlign: "left",
					label: "Servicio", width: 300, hidden: true, editable: true,
					suggest: {
						fitMaster: false,
						width: 550,
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 1000,
						body: {
							template: "#value#",
							dataFeed: "/<% // Response.Write(config.ruta)%>/cmb_depew.fwx?lnTipo=2"
						},
						on:{
							"onValueSuggest": function (obj) {
								$$("cmbAjena").setValue(obj.value.substr(obj.value.indexOf(')') + 1).trim())
								$$('id_ajena').setValue(obj.id)
							}
						}
					},
					on: {
						onChange: function (id) {
							dirigido(id);
						},
						"onKeyPress": function(code, e){
							$$("id_ajena").setValue()
						}
					}
				},
				{
					view:"text", hidden:true, id:"id_ajena", name:"id_ajena", readonly:true
				},



				// {
				// 	view: "combo", id: "cmbAjena", name: "cmbAjena", labelPosition: "top", labelAlign: "left",
				// 	label: "Servicio", width: 300, inputWidth: 300, hidden: true, editable: true,
				// 	options: {
				// 		filter: function (item, value) {
				// 			if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
				// 				return true;
				// 			return false;
				// 		},
				// 		body: {
				// 			yCount:6 , fitMaster: false, width: 550, keyPressTimeout: 300, template: "#value#", dataFeed: "/<% // Response.Write(config.ruta)%>/cmb_depew.fwx?lnTipo=2"
				// 		}
				// 	},
				// 	on: {
				// 		onChange: function (id) {
				// 			dirigido(id);
				// 		}
				// 	}
				// },
				{ maxWidth: 60 },
				{
					view: "text", id: "txtCorr_ofic", name: "txtCorr_ofic", labelPosition: "top", labelAlign: "left",
					label: "Correo de oficial&iacute;a", width: 300, inputWidth: 300,
				},
				{ maxWidth: 60 },
				{
					view: "select", label: "Tipo", id: "cmbTipo", value: 1, width: 100, labelPosition: "top", labelAlign: "left", 
					options: [
					{ id: 1, value: "Dirigido a" },
					{ id: 2, value: "Con copia" },
					{ id: 3, value: "Autoriza" },
					{ id: 4, value: "Vo. Bo." },
					{ id: 5, value: "Atenci&oacute;n a" }
					]
				},
				{ maxWidth: 30 },
				{
					view:"richselect", id:"precargado", name:"precargado", label:"Personas precargadas (No se guarda el valor)",  width: 300,  labelPosition:"top",  options:[], 
					on:{
						onChange:(id)=>{
							if(!id)
								return
							let element =  $$("precargado").getList().getItem(id)
							$$("cmbPers").setValue(element["value"].substring(0, element["value"].indexOf('(') > 0? element["value"].indexOf('('):element["value"].length));
							$$("txtCorr_ofic").setValue(element["corr_ofic"]);
							$$("txtDiri_carg").setValue(element["cargo"])
							$$("copias").setValue(element["copias"])
						}
					}
				}
				]
			},
			{
				cols: [
				{
					view: "text", id: "cmbPers", name: "cmbPers", labelPosition: "top", labelAlign: "left",
					label: "Nombre", width: 300, inputWidth: 300,
					suggest: {
						keyPressTimeout: 1000,
						body: {
							keyPressTimeout: 100, dataFeed: "/<% // Response.Write(config.ruta)%>/cmb_persw.fwx?lnTipo=10"
						}
					}
				},
				{ maxWidth: 60 },
				{
					view: "text", id: "txtDiri_carg", name: "txtDiri_carg", labelPosition: "top", labelAlign: "left",
					label: "Ocupaci&oacute;n", width: 300, inputWidth: 300,
				},
				{ maxWidth: 60 },
				{
					view: "text", id: "copias", name: "copias", labelPosition: "top", labelAlign: "left", readonly:true, disabled:true,
					label: "Copias", width: 300, inputWidth: 300,
				}
				]
			},
			{
				cols: [
				{ view: "button", id: "refresh", type: "icon", icon: "mdi mdi-sync", label: "", width: 32, align: "left", tooltip:"Recargar el listado", click:()=>{genera()} },
				{
					view: "button", type: "icon", icon: "mdi mdi-plus", label: "Agregar al oficio", width: 170,
					//  Response.Write(IIF(ofic_stat.titular = .T. AND dere_ofic.titular = .F., "true", "false"))
                    disabled: <%=(ldDere.TITULAR ? true : false)%> ,
					on: {
						onItemClick: function () { registro(1); }
					}
				},
				{
					view: "button", type: "icon", icon: "mdi mdi-account-minus", label: "Eliminar del oficio", width: 170,
					on: {
						onItemClick: function () { registro(2); }
					}
				},
		
				{},
				{
					view: "button", id: "save", type: "icon", icon: "mdi mdi-content-save", width: 170, click:()=>{guardar()},
					align: "left", label: "Guardar cambios", disabled: true
				}
				]
			}
			]
		}
		]

		webix.ui.datafilter.rowCount = webix.extend({
			refresh: function (master, node, value) {
				node.firstChild.innerHTML = "Total: " + master.count();
			}
		}, webix.ui.datafilter.summColumn)



		webix.proxy.all = {
			$proxy: true,
			saveAll: function (view, updates, dp) {
				webix.ajax().post(this.source, { data: updates })
				.then(function (response) {
					webix.message({ type: "success", text: "Se guardaron los cambios", expire: 4000 })
					dp.reset();
					$$("dtable").clearCss("edited");
					$$("save").disable();
					genera();
				});
			}
		};


		webix.ready(()=>{
			webix.ui({
				view: "scrollview", id: "verses", scroll: "y",
				body: {
					margin: 20, 
					rows: [
					<% //  IF(cOficio.status < 2 and llEdita) OR (llEdit_ofic AND cOficio.status > 2) 
                    if ((rowso[0].STATUS < 2 && llEditar) ||  (llEdit_ofic && rowso[0].STATUS > 2)){
                    %>
					{ view: "form", elements: section },
					<%}
                     //  ENDIF %>
					{
						view: "datatable", id: "dtable", select: "row", editaction: "dblclick", rowCss: "#css#",
						footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true, editable: true, minHeight: 450,
						// scheme:{
						// 	$serialize:(obj)=>{
						// 		if(obj.edited == 1 || obj.deleted == 1 || obj.added == 1)
						// 			return obj;
						// 		else
						// 			return false;
						// 	}
						// },
						columns: [
						{ id: "servicio", hidden: true },
						{ id: "nomb_serv", header: ["Servicio", { content: "textFilter" }], width: 240, sort: "string", css: { 'text-align': 'left' } },
						{ id: "diri_nomb", editor: "popup", header: ["Nombre", { content: "textFilter" }], width: 240, sort: "string", css: { 'text-align': 'left' } },
						{ id: "corr_ofic", editor: "popup", header: ["Correo oficial&iacute;a", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' } },
						{ id: "diri_carg", editor: "popup", header: ["Ocupaci&oacute;n", { content: "textFilter" }], width: 200, sort: "string", css: { 'text-align': 'left' } },
						{
							id: "tipo", header: ["Tipo", { content: "selectFilter" }], width: 120,
							options: [
							{ id: 1, value: "Dirigido a" },
							{ id: 2, value: "Con copia" },
							{ id: 3, value: "Autoriza" },
							{ id: 4, value: "Vo. Bo." },
							{ id: 5, value: "Atenci&oacute;n a" }, 
							{ id: 9, value:"Copia automatica"}
							]
						},
						{
							id: "tipo_depe", header: ["Dependencia", { content: "selectFilter" }], width: 100,
							options: [
							{ id: 1, value: "HCG" },
							{ id: 2, value: "Ajena HCG" }
							]
						},
						{ id: "fech_tenvi", header: ["F. Env&iacute;o Autorizaci&oacute;n", { content: "dateFilter" }], width: 170, sort: "date", css: { 'text-align': 'left' } },
						{ id: "fech_auto", header: ["Fecha Autorizado.", { content: "dateFilter" }], width: 150, sort: "date", css: { 'text-align': 'left' } },
						{ id: "fech_senvi", header: ["Fecha Env&iacute;o Acuse", { content: "dateFilter" }], width: 150, sort: "date", css: { 'text-align': 'left' } },
						{ id: "fech_acus", header: ["Fecha Acuse", { content: "dateFilter" }], width: 150, sort: "date", css: { 'text-align': 'left' } },
						{ id: "copias", header: ["Copias automaticas", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' } },
						{ id: "edited", header: ["editado", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' }, hidden:true },
						{ id: "deleted", header: ["eliminado", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' }, hidden:true },
						{ id: "added", header: ["agregado", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' }, hidden:true },
						],
						on: {
							onBeforeLoad: function () { this.showOverlay("Cargando..."); },
							onAfterLoad: function () {
								this.hideOverlay();
								this.adjustRowHeight("nomb_serv", true);
								this.render();
							},
							onAfterEditStop: function (obj, editor) {
								if (obj.value !== obj.old) {
									$$("save").enable();
									this.addRowCss(editor.row, "edited");
									let item = $$("dtable").getItem(editor.row);
									item.edited = 1;
									$$("dtable").updateItem(editor.row, item);
								}
							},
						},
						// save: {
						// 	autoupdate: false, url: "all->/<% // Response.Write(config.ruta)%>/op_sdoficx2.fwx?lnIden=<% // REsponse.WritE(lnIden)%>",
						// }
					},
				{
					height:40,    
					cols: [
					<% //  IF cOficio.status >= 3 AND dere_ofic.titular = 1 
                    if (rowso[0].STATUS >= 3 && ldDere.TITULAR){
                    %>
					{
						view: "button", type: "icon", icon: "mdi mdi-send", label: "Reenviar oficio", width: 170,
						on: {
							onItemClick: function () { reenvio(1); }
						}
					},
					<%} //  ENDIF %>
					<% //  IF BETWEEN(cOficio.status, 1, 3) 
                    if ((rowso[0].STATUS >= 1) && (rowso[0].STATUS <= 3)){
                    %>
					{
						view: "button", type: "icon", icon: "mdi mdi-send", label: "Enviar para autorizaci&oacute;n", width: 230,
						tooltip: "Enviar oficio para la autorizaci�n o visto bueno del oficio",
						on: {
							onItemClick: function () { reenvio(2); }
						}
					},
					<%} //  ENDIF %>
					{
						view: "button",
						type: "icon", 
						id: "crearG",
						icon: "mdi mdi-account-group",
						label: "Hacer un grupo",
						width: 150,
						click: function () {
							makegroup();
						}
								},
				

					]
				},
				{
					height:20
				}

				]
				}

			})


			webix.extend($$("verses"), webix.ProgressBar)
			<% //  IF!EMPTY(lnIden) %>
			genera();
			<% //  ENDIF %>

		})

		function mues_grupo() {
			webix.ui({
				view: "window", id: "mues_grup",
				move: true, left: 150, top: 0, width: 900, height: 550, resize: true,
				head: {
					view: "toolbar", id: "grupo",
					cols: [
						{ view: "label", label: "Grupos" },
						{ view: "icon", icon: 'mdi mdi-close', click: "$$('mues_grup').close();" }
					]
				},
				body: {
					view: "iframe",
					src: "/<% // Response.Write(config.ruta)%>/op_grup.fwx?t=2%>"
				}
			}).show();
		}

		
		//Crear un grupo
		function makegroup(){
			
				webix.ui({
						view:"window",
						id:"popupG",
			position: "center",
			width: 400,
						height: 400,
			head:{
							align:"right", view:"button", type:"icon", icon:"mdi mdi-close", width:32, click: "$$('popupG').close();"
						},
			
				body: {
					view: "form",
									id: "form:makegroup",
								
					
								
								rows: [
				{
				view: "combo", id: "cmbOficio", value: <%=rows[0].id_cent%>, width: 300, hidden:"true",
				options: {
					fitMaster: false,width: 300,
					body: {
						data: [
						<% /*
						SELECT cSoli
						GO TOP
						SCAN
                        */
						%>
						{ id: <%=rows[0].id_cent%>, value: "(<%=rows[0].cve%>) <%=rows[0].depen%>" },
						<% //  ENDSCAN %>
						]
					}
				}
			},
										{
												view: "text",
												label: "Nombre del grupo",
												name: "name",
						id: "name",
												placeholder: "Nombre del grupo",
												labelPosition: "top",
										},
										{
												cols: [
														{
																view: "button",
																value: "Cancelar",
																click: function () {
																		$$('popupG').hide();
																}
														},
														{
																view: "button",
																value: "Crear grupo",
																click: function () {
																		GenerateGroup($$("name").getValue(), $$("cmbOficio").getValue());
																}
														},
												]
										}
								]

			
						}
				}).show();
		}

	//Genera el grupo con los registros del dtable	
	function GenerateGroup(name, cent){
		
		let dtable = $$("dtable").serialize();
		let table = JSON.stringify(dtable);
		
		$$("dtable").eachRow((row)=>{
								var item = $$("dtable").getItem(row)
				console.log(item.servicio);
		})


		var data = {}
		data.name = name;
		data.cent = cent;
		data.table = table;

		console.log(data);
		//return

		webix.ajax().post("/<% // Response.write(config.ruta)%>/op_sdoficxx.fwx", data)
				.then((res)=>{
												//console.log(res)
						res = res.json();
												//console.log(res)
						Swal.fire("", res[0].message, res[0].status ? "success":"error").then(()=>{
														
							location.reload();
						})
					})

	}


		//functions 
		function guardar() {

			Swal.fire({
				text: '', title: "Estas seguro guardar los cambios realizados?", icon: 'warning', showCancelButton: true,
				confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Si', cancelButtonText:"No",
			}).then((result) => {
				if(result.isConfirmed){
					$$("verses").disable();
					$$("verses").showProgress();

					webix.ajax().post("/api/op/op_sdoficx2", { oficio: <%=loDatos.lnIden%>, dtable:JSON.stringify($$("dtable").serialize(1,1))}).then((res)=>{
						$$("verses").enable();
						$$("verses").hideProgress();
						res = res.json();
						Swal.fire({title:"", text:res.message, icon:(res.status?"success":"error")}).then(()=>{
							if(res.status){
								genera();
								$$("save").disable();
							}
						})
					})
				}
			})
		}



				function registro(tipo) {
						
						if (tipo == 1) {
				
								var lnTipo_cont = parseInt($$("cmbTipo").getValue());
				//console.log(typeof lnTipo_cont);
								var lnDepe = (lnTipo_cont > 1 ? 0 : $$("cmbTipo_depe").getValue());
				//console.log(typeof lnDepe);
								var lnServicio = (lnDepe == 1 ? $$("cmbServicio").getValue() : lnDepe == 2 ? $$("id_ajena").getValue() : 0);
								var lcText_depe = (lnDepe == 1 ? $$("cmbServicio").getText() : lnDepe == 2 ? $$("cmbAjena").getValue() : "");
								var lcId = (lnTipo_cont == 1) ? $$("cmbServicio").getValue() : $$("txtCorr_ofic").getValue() + '_' + $$("cmbTipo").getValue();

								let lcCopias	= $$("copias").getValue();

				


								if (lnTipo_cont == 1 && ((lnDepe == 1 && $$("cmbServicio").getValue() == "") || (lnDepe == 2 && $$("cmbAjena").getValue() == "" && $$("id_ajena").getValue() == "") || $$("txtCorr_ofic").getValue() == "" || $$("cmbPers").getValue() == "" || $$("txtDiri_carg").getValue() == "")) {
										webix.alert("Tienes que llenar todos los campos para poder agregar una persona de tipo 'Dirigido a'");
										return
								}

								if (lnDepe > 0 && (lnDepe == 2 && lnServicio != 0)) {
										laId = $$("dtable").find(function (obj) {
												return obj.servicio == lnServicio;
										});

										if (laId.length > 0) {
												webix.alert("Ya ingresaste este servicio")
												return false;
										}
								} else if (lnDepe == 0) {

										laId = $$("dtable").find(function (obj) {
												console.log(obj)
												return obj.id == lcId;
										});
										if (laId.length > 0) {
												webix.alert("Ya ingresaste este correo en el tipo selecccionado")
												return false;
										}
								}

								if ((lnTipo_cont == 2 || lnTipo_cont == 3 || lnTipo_cont == 4) && ($$("txtCorr_ofic").getValue() == "" || $$("cmbPers").getValue() == "")) {
										webix.alert("Tienes que por lo menos el nombre y correo para los tipos de persona 'Con copia', 'Autoriza', 'Vo. Bo.'");
										return
								}

								if (!veri_corr($$("txtCorr_ofic").getValue())) {
										webix.alert("El correo tiene un formato invalido");
										return
								}

								$$("dtable").add({
										servicio: $$("cmbServicio").getValue() ,
										nomb_serv: $$("cmbServicio").getText(),
										corr_ofic: $$("txtCorr_ofic").getValue(),
										diri_nomb: $$("cmbPers").getValue(),
										diri_carg: $$("txtDiri_carg").getValue(),
										tipo: $$("cmbTipo").getValue(),
										tipo_depe: $$("cmbTipo_depe").getValue(),
										copias:lcCopias,
										added:1
								});

								$$("dtable").addRowCss($$("dtable").getLastId(), "edited");
								$$("cmbServicio").setValue();
								$$("txtCorr_ofic").setValue();
								$$("cmbPers").setValue();
								$$("copias").setValue();
								$$("precargado").getList().clearAll();
								$$("precargado").setValue()
								$$("txtDiri_carg").setValue();
						} else {
							let id = $$("dtable").getSelectedId()
								if (!id){
									webix.message({ type: "debug", text: "Selecciona un registro para eliminar", expire: 2500 })
									return
								}

								Swal.fire({
									text: '', title: "Estas seguro que deseas eliminar el registro?", icon: 'warning', showCancelButton: true,
									confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Si', cancelButtonText:"No",
								}).then((result) => {
									if(result.isConfirmed){
										console.log(id)
										$$("dtable").addRowCss(id, "highlight-red")
										let item = $$("dtable").getItem(id);
										item.deleted = 1;
										$$("dtable").updateItem(id, item);
									}
								})
						}
						$$("save").enable();



				}

				function dirigido(id) {

					var list = $$("precargado").getList(); 
					list.clearAll()
					$$("precargado").setValue();
					$$("cmbPers").setValue();
					$$("txtCorr_ofic").setValue();
					$$("txtDiri_carg").setValue()
					$$("copias").setValue()
					
					webix.ajax().post("/api/op/op_noficx", {txtTipo:9, centro:id}).then((res)=>{
						res = res.json();
						if(res.status){
							list.add({id:"0", value:""})
							// list.parse(res.personas)
							res.personas.forEach((element, index)=>{
								list.add(element);
								if(element["titular"] == 1 || res.personas.length == 1){
									$$("precargado").setValue(element["id"])
								}
							})
					 
							// $$("nombre:suggestList").getList().data = res.personas;
							// $$("nombre:suggestList").getList().refresh();
							// console.log($$("nombre:suggestList").getList().data )
							// $$("nombre:suggestList").getList().show()
							// console.log(
						}
					})
					return 


						var lnDepen = id;

						if (lnDepen != null && lnDepen != "" && lnDepen != undefined) {

								loader = dhx4.ajax.postSync('/<% // Response.Write(config.ruta)%>/op_noficx.fwx', 'cmbCentro=' + lnDepen);
								var result1 = loader.xmlDoc.responseXML.getElementsByTagName("mensaje");
								var result2 = loader.xmlDoc.responseXML.getElementsByTagName("error");
								var result3 = loader.xmlDoc.responseXML.getElementsByTagName("codigo");
								var result4 = loader.xmlDoc.responseXML.getElementsByTagName("nombre");
								var result5 = loader.xmlDoc.responseXML.getElementsByTagName("cargo");
								var result6 = loader.xmlDoc.responseXML.getElementsByTagName("correo");
								console.log()

								if (result2[0].firstChild.nodeValue != ".T.") {

										//$$("cmbPers").getList().clearAll()
										//$$("cmbPers").getList().parse('{"id":"' + result3[0].firstChild.nodeValue + '", "value": "' + result4[0].firstChild.nodeValue + '"}');
										$$("cmbPers").setValue(result4[0].firstChild.nodeValue)

										$$("txtCorr_ofic").setValue(result6[0].firstChild.nodeValue)
										$$("txtDiri_carg").setValue(result5[0].firstChild.nodeValue)
								}

						}
				}

				function genera() {
						$$("dtable").clearAll();
						$$("dtable").load('/api/op/op_sdoficx?lnIden=<%=loDatos.lnIden%>')
				}


				function veri_corr(correo) {
						var regex = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

						return regex.test(correo);
				}

				function countDirigido() {
						return $$("dtable").find(function (obj) { return obj.tipo == 1; });
				}

				function reenvio(tipo) {

					if ($$("dtable").getSelectedId() == undefined) {
						webix.alert("Selecciona un registro")
						return
					}


					Swal.fire({"title":"Se intentar� enviar el oficio", 
						html: `
							<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" fill="none">
								<circle cx="50" cy="50" r="45" stroke="#4caf50" stroke-width="10" stroke-dasharray="283" stroke-dashoffset="75" stroke-linecap="round">
									<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" from="0 50 50" to="360 50 50" />
								</circle>
							</svg>
						`,
						 showConfirmButton:false, allowOutsideClick :false, allowEscapeKey:false, icon:"info"
					})


					webix.ajax().post("/api/op/op_oficx", { id: $$("dtable").getSelectedId().id, iden: <%=loDatos.lnIden%>, t:tipo}).then(function (res) {
						// $$("verses").enable()
						// $$("verses").hideProgress()
						res = res.json()
						Swal.fire({text:res.message, icon:res.status?"success":"error"}).then(()=>{
							if (res.status){
								genera();
							}
						})
						// webix.message({ type: (res.status ? "success" : "error"), text: res.message })
					})
				}
		</script>
</body>


</html>