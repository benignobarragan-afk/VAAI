<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <link rel="stylesheet" href="/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/skins/web/dhtmlx.css" />
    <link rel="stylesheet" type="text/css" href="/skins/terrace/dhtmlx.css" />
    <link rel="stylesheet" type="text/css" href="/webix/codebase/webix.css" />
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.7.94/css/materialdesignicons.css?v=6.0.7"
        type="text/css" charset="utf-8">

    <script src="/codebase/dhtmlx.js"></script>
    <script src="/webix/codebase/webix.js"></script>
    <script src="/webix/codebase/locale.js"></script>

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />

    <%  
    /*
LOCAL llError, lcCentro, lcPie, llAplicar, lnOficio, lcOficio, lcPrevio, lnMens_usua
LOCAL llNBusca, lcCVE, lcIniciales, lnIden, lcRuta_tabl
LOCAL lcDiri_nomb, lnDiri_codi, lcDiri_carg, lcAten_nomb, lnAten_codi, lcAten_carg, llNBusca2, lnCant_ofic

SET PROCEDURE TO mylib
SET DATE DMY

IF !Derechos("OFICIO")
    lcRuta = ALLTRIM(config.ruta)
    SET PROCEDURE TO
    CLOSE TABLES ALL
    CLOSE DATABASES ALL
    response.redirect("/"+lcRuta+"/sin_derechos.fwx")
ENDIF
   
lcSQL = "SELECT id_cent, cve, depen, clave FROM GEN_TIPO_OFIC WHERE cve in (SELECT DISTINCT cve "
lcSQL = lcSQL + "FROM GEN_DERE_OFIC WHERE user_id = ?pcUser) ORDER BY 3"

lcQbase_cgce = config.qbase_cgce

lnCone_cgce = &lcQbase_cgce
IF SQLEXEC(lnCone_cgce, lcSQL, "cSoli") != 1
	a=Aerror(Mat)
	?SQLDISCONNECT(0)
	Response.write(Mat(2) + " Linea: 67")
	return
ENDIF


SQLDISCONNECT(0)

*/
%>


    <style type="text/css">
        .dhtmlx-error {
            font-weight: bold;
            color: white;
            background-color: #770000;
        }

        .webix_dtable .webix_ss_header {
            font-weight: bold;
        }

        .edited {
            font-weight: bold;
        }

        .footer {
            font-weight: bold;

        }

        .btnCancel.webix_el_button button span{
            color:white !important;
            margin: 0 3px;
        }

    </style>
</head>

<body onLoad="doOnLoad();">

    <script>
        var w1;
        var mygrid;

        function doOnLoad() {


            webix.ui.datafilter.rowCount = webix.extend({
                refresh: function (master, node, value) {
                    node.firstChild.innerHTML = "Total: " + master.count();
                }
            }, webix.ui.datafilter.summColumn)


            var ui = webix.ui({
                space: "wide",
                id:"myLayout",
                rows: [
                    {
                        view: "toolbar", padding: 3, borderless: true, elements: [
                            {
                                view: "button",
                                type: "icon",
                                icon: "mdi mdi-sync",
                                align: "left",
                                label: "",
                                width: 40,
                                on: {
                                    onItemClick: genera
                                }
                            },
                            {
                                view: "button",
                                type: "icon",
                                icon: "mdi mdi-plus",
                                label: "Agregar plantilla a oficio",
                                width: 220,
                                on: {
                                    onItemClick: agregar
                                }
                            },
                            {}, {},
                            {
                                view: "combo", id: "cmbOficio", value: <%=rows[0].id_cent%>,
                                width: 300,
                                options: {
                                    fitMaster: false,
                                    width: 300,
                                    body: {
                                        data: [
                                            <%for (var i = 0; i < rows.length; i++) {%>
                                            { id: "<%= rows[i].id_cent%>", value: "(<%=rows[i].cve%>) <%=rows[i].depen%>" },
                                            <%}%>
                                    <%
                                    /*
                                            SELECT cSoli
                                    GO TOP
                                    SCAN
                                    */
                                            %>
                                            //{ id: <% //  Response.Write(cSoli.id_cent) %>, value: "<% // Response.Write(ALLTRIM(cSoli.depen))%>" },
                                    <% //   ENDSCAN %>
                                ]
                                    }
                                },
                                on: {
                                    onChange: genera

                                }
                            },
                            {
                                view: "button",
                                type: "icon",
                                icon: "mdi mdi-plus",
                                label: "Crear plantilla",
                                width: 130,
                                on: {
                                    onItemClick: function () { deta_grup() }
                                }
                            },
                            {
                                view: "button", type: "icon", icon: "mdi mdi-minus", tooltip: "Crear plantilla", width: 30, css:"btnCancel",  click:()=>{eliminaRegistro();} 
                             }

                        ]
                    }
                    ,
                    {
                        view: "datatable", id: "dtable", select: "row", editaction: "dblclick", rowCss: "#css#",
                        columns: [
                            {
                                id: "nombre", header: ["Plantilla", { content: "textFilter" }], sort: "string",
                                css: { 'text-align': 'left' }
                            },
                            { id: "descrip", header: ["Plantilla", { content: "textFilter" }], sort: "string", css: { 'text-align': 'left' }, fillspace: true },
                        ],
                        footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true,
                        editable: true, height: 400,
                        on: {
                            onBeforeLoad: function () { this.showOverlay("Cargando..."); },
                            onAfterLoad: function () { this.hideOverlay(); },
                            onItemDblClick: function (id) {
                                deta_grup(id)
                            }
                        },

                    }
                ]
            });
						webix.extend($$("dtable"), webix.ProgressBar)
						webix.extend($$("myLayout"), webix.ProgressBar)
            genera();
        }

        function genera() {
            $$("dtable").clearAll();
            $$("dtable").load('/api/op/op_bplanx?lnId_cent=' + $$("cmbOficio").getValue());

        }

        function deta_grup(id) {
            window.parent.$$("tbView").addView({
                header: "<span class='webix_icon mdi mdi-file-document-outline'></span>" + (id == undefined ? "Nuevo" : "Modifica") + " grupo",
                body: {
                    view: "iframe", src: "/op/op_nplanti?lnID=" + id,
                    type: {
                        height: 60
                    }
                },
                close: true
            });
            window.parent.$$("tbView").getTabbar().setValue(window.parent.$$("tbView").getTabbar().data.options[window.parent.$$("tbView").getTabbar().data.options.length - 1].id);
        }

        function agregar() {
            if($$("dtable").getSelectedId() === undefined)
                webix.message({type: "debug", text: "Selecciona un registro de una plantilla para cargarla al concepto", expire: 2500})
            else window.parent.carg_plantilla($$("dtable").getSelectedId().id);
        }

			function eliminaRegistro(){
				let id = $$("dtable").getSelectedId();
				if (!id){
					webix.message("Selecciona el registro que quieres eliminar")
					return;
				}
				$$("myLayout").showProgress();
				$$("myLayout").disable();
				Swal.fire({
					title: '', text: "Seguro de eliminar la plantilla seleccionada?", icon: 'warning', showCancelButton: true,
				  confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Si', cancelButtonText:"No",
				}).then(res =>{
					if(res.isConfirmed){
						webix.ajax().post(`/<% // Response.write(config.ruta)%>/op_bplanx.fwx?t=1&lnId_cent=${$$("cmbOficio").getValue()}`, {plantilla:id.row}).then((res)=>{
							$$("myLayout").hideProgress();
							$$("myLayout").enable();
							res = res.json();
							webix.message(res.message, (res.status?"success":"error"), 3000)
							if(res.status){
								genera();
							}
						})
					}
				})
			}

    </script>
</body>


</html>