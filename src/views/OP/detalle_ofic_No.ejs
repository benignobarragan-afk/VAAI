<!DOCTYPE html>
<html>

<head>
	<title></title>
	<script src="/webix/codebase/webix.js"></script>
	<script src="/webix/codebase/locale.js"></script>
	<link rel="stylesheet" type="text/css" href="/webix/codebase/webix.css" />
	<link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.7.94/css/materialdesignicons.css?v=6.3.5"
		type="text/css" charset="utf-8">

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />

	<%
    /*
	LOCAL llBusca, llError, lcCentro, llAplica, lnOficio, lcOficio, lcRefe, lcRuta_tabl

	SET PROCEDURE TO mylib
	SET DATE DMY

	IF !Derechos("ASIG_OFIC")
		lcRuta = ALLTRIM(config.ruta)
		SET PROCEDURE TO
		CLOSE TABLES ALL
		CLOSE DATABASES ALL
		response.redirect("/"+lcRuta+"/sin_derechos.fwx")
	ENDIF

	llDirectorio = derechos("DIRE_RECT")

	lcQbase_cgce = config.qbase_cgce
	lnCone_cgce = &lcQbase_cgce

	lcClav_ofic = ALLTRIM(LEFT(Request.QueryString("clav_ofic"),11))
	lcURl_ofic	= ALLTRIM(Request.QueryString("clav_ofic"))

	lnTipo_docu	= VAL(Request.QueryString("tipo_docu"))

	lcURL			= ALLTRIM(Request.QueryString("lcDest"))
	lnOficio	= VAL(Request.QueryString("lnOficio"))
	lnNum_ofi	= VAL(Request.QueryString("lnNum_ofi"))


	&&Saca el id iden de la url
	lnPosition = RAT('L',lcURL)

	lnLen = VAL(SUBSTR(lcURL,lnposition+1))


	lcDest = ""
	FOR xx = 1 TO lnLen 		
		lcDest = lcDest + SUBSTR(lcURL,(xx)*5,1)
	NEXT
	lnID_doficio = VAL(lcDest)

	lnID_iden = 0


	lcLiga_sali = ' {"id": "+ CAST(o.id_iden as varchar)+" '

	IF !EMPTY(lcClav_ofic)

		lcSQL = "SELECT o.cve as cveSali,CONVERT(VARCHAR(10), o.FECHA, 103) AS fech_ofic, CONVERT(varchar(5), GETDATE(), 108) as hora_rece, 0 as	tipo_docu"
		lcSQL = lcSQL + " , o.id_iden, o.id_iden as id_oficio,	o.oficio, o.oficio as nume_ofic, o.concepto as asunto, t.nomb_firm as remi_nomb, t.carg_firm as remi_carg, 0 as remi_codi"
		lcSQL = lcSQL + " , co.id_Cent as dependen, '(' +co.clave + ') ' +LTRIM(co.dependen) as depe_nomb, CONVERT(varchar(10), GETDATE(), 103)	as fech_rece, o.tipo_depe as rbDepe"
		lcSQL = lcSQL + " , 1 AS rbLiga, IFNULL(do.diri_nomb,'') AS dest_nomb, IFNULL(do.diri_carg,'') as dest_carg, 1 as tipo_ofic, 1 as clase"
		lcSQL = lcSQL + " FROM gen_oficio o"
		lcSQL = lcSQL + " INNER JOIN GEN_CENTROS c ON c.id_cent = o.cent_soli"
		lcSQL = lcSQL + " INNER JOIN gen_tipo_ofic t ON t.cve = o.cve"
		lcSQL = lcSQL + " INNER JOIN gen_centros co ON co.id_Cent = t.id_cent"
		lcSQL = lcSQL + " INNER JOIN PASSFILE p ON p.user_id = o.solicito"
		lcSQL = lcSQL + " LEFT JOIN gen_doficio do ON do.id_iden = o.id_iden AND " + IIF(!EMPTY(lnID_doficio), ' do.id_doficio_pk = ?lnID_doficio ', ' do.tipo = 1 ')
		lcSQL = lcSQL + " WHERE o.clav_ofic = ?lcClav_ofic"



		IF SQLEXEC(lnCone_cgce, lcSQL, "ofic_sali") != 1
				a=Aerror(Mat)
				SQLDISCONNECT(0)
				Response.write(Mat(2)+"; Linea: 40; op_ningr.fwx")
				RETURN
		ENDIF

		GO TOP IN ofic_sali

		lnID_iden	= ofic_sali.id_oficio

		IF SQLEXEC(lnCone_cgce, " SELECT * FROM gen_tipo_ofic WHERE cve = ?ofic_sali.cveSali", "cOp_cargo") != 1
				a=Aerror(Mat)
				SQLDISCONNECT(0)
				Response.write(Mat(2)+"; Linea: 40; op_ningr.fwx")
			RETURN
		ENDIF

		IF SQLEXEC(lnCone_cgce, " SELECT * FROM gen_doficio WHERE id_iden = ?ofic_sali.id_iden", "ofic_dsali") != 1
				a=Aerror(Mat)
				SQLDISCONNECT(0)
				Response.write(Mat(2)+"; Linea: 40; op_ningr.fwx")
			RETURN
		ENDIF

		SELECT ofic_dsali
		INDEX ON id_cent TAG id_cent

		SELECT ofic_sali
		GO TOP

		IF SQLEXEC(lnCone_cgce, "SELECT nomb_dest FROM OPC_OFICIO WHERE descrip = ?ofic_sali.oficio AND cve = ?ofic_sali.cveSali", "cSeek") = -1
			 a=Aerror(Mat)
			SQLDISCONNECT(0)
			Response.write(Mat(2)+"; Linea: 112; op_ningr.fwx")
			RETURN
		ENDIF

	*!*	IF RECCOUNT("cSeek") > 0
    */
	%>
<!-- 	<script type="text/javascript">
		alert("Es posible que el C. <% // Response.write(ALLTRIM(cSeek.nomb_dest))%> ya haya registrado este oficio en la oficialia")
	</script> -->
	<%
    /*
	*!*	ENDIF


	ENDIF

	IF SQLEXEC(lnCone_cgce, " SELECT * FROM OPC_op_config", "op_config") != 1
		a=Aerror(Mat)
		SQLDISCONNECT(0)
		Response.write(Mat(2)+"; Linea: 103; op_ningr.fwx")
		RETURN
	ENDIF

	
		


	IF SQLEXEC(lnCone_cgce, "SELECT id_pk, descrip FROM OPC_TIPO_DOCU WHERE activo = 1 AND (dire_rect = 0" + IIF(llDirectorio, ' OR dire_rect = 1', '') + " ) ORDER BY orden", "cTipo_docu") = -1
		AERROR(laError)
		SQLDISCONNECT(0)
		Response.write(laError(2)+"; Linea: 40; op_ningr.fwx")
		RETURN 
	ENDIF
	=SQLEXEC(lnCone_cgce, "SELECT * FROM OPC_TIPO_OFIC", "cTipo_ofic")
	=SQLEXEC(lnCone_cgce, "SELECT * FROM OPC_CLAS_OFIC WHERE activo = 1 AND (dire_rect = 0" + IIF(llDirectorio, ' OR dire_rect = 1', '') + " ) ORDER BY orden", "cClase")

	lcSQL_dere	= "SELECT d.cve, CONCAT('(',TRIM(d.cve),') ', c.descrip) AS descrip"
	lcSQL_dere	= lcSQL_dere + " FROM GEN_DERE_OFIC d"
	lcSQL_dere	= lcSQL_dere + " INNER JOIN GEN_TIPO_OFIC t ON t.cve = d.cve"
	lcSQL_dere 	= lcSQL_dere + " INNER JOIN GEN_CENTROS c ON c.id_cent = t.id_cent"
	*lcSQL_dere 	= lcSQL_dere + " LEFT JOIN opc_oficio o ON o.cve = t.cve AND O.anio = YEAR(GETDATE()) AND o.tipo = ?lnTipo_docu"
	lcSQL_dere 	= lcSQL_dere + " WHERE d.user_id = ?PCUSER"
	lcSQL_dere 	= lcSQL_dere + " GROUP BY d.cve, c.descrip"

	IF SQLEXEC(lnCone_cgce, lcSQL_dere,"cOficialia") = -1 
		AERROR(laError)
		SQLDISCONNECT(0)
		ADSD
	ENDIF

	UPDATE cOficialia SET descrip = STRTRAN(descrip,'"',"'")

	lcDatos = '[]'
	IF !EMPTY(lcClav_ofic)
		lcDatos = curs_json("ofic_sali")
	ENDIF

	SQLDISCONNECT(0)
    */
	%>

	<style type="text/css">
		.add {
			font-weight: bold;
		}

		.obligatorio {
			color: red;
		}

	</style>

	<script language="JavaScript">


		//variables
		let today = new Date()

		// let hour = today.toLocaleString('en-US', {
		// 	hour12: false,
		// });


		let hour = String(today.getHours()).padStart(2, '0') + ':' + String(today.getMinutes()).padStart(2, '0');





		// hour = hour.substr(12, 5)

		//webix-components

		var form_elements = [{
			view: "label", class: { "font-weight": "bold", "font-size": 14, "text-align": "center" }, align: "center", label: "DETALLE DEL OFICIO"
		},
		<%
		if(llDirectorio && !!laQuery.lcClav_ofic){ //  IF llDirectorio AND EMPTY(lcClav_ofic) %>
		{
			cols: [

				{
					view: "select", id: "tipo_docu", name: "tipo_docu", label: "<span class='obligatorio'>*</span>Tipo documento", labelPosition: "top", value:0<% //  Response.write(lnTipo_docu) %>, 
					options: [
						<% //  SELECT cTipo_docu
						//SCAN %>
							{ id: "<% // Response.write(cTipo_docu.id_pk)%>", value: "<% // Response.write(cTipo_docu.descrip)%>" },
						<% //  ENDSCAN %>
					],
					on: {
						"onChange": function (newv, oldv) {
							buscaNume();
							if(newv == 3){
								$$("segu_pra").show();
							}else{
								$$("segu_pra").hide();
								$$("segu_pra").setValue();
							}

							if (newv == 1) {
								$$("telefono").show();
								$$("doc_firm").show();
							} else {
								$$("telefono").hide();
								$$("doc_firm").hide();

							}
						}
					}
				},
				{
					view:"combo", id:"segu_pra", name:"segu_pra", labelPosition:"top", label:"Si vas a dar seguimiento a un documento PRA seleccionalo",	 hidden:true, 
					options:{
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						//url: "/api/op/op_ningrx2?t=2"
					}
				},
				{
					view:"select", id:"doc_firm", name:"doc_firm",labelPosition:"top", label:"Define el documento", hidden:true, 
					options:[{
						id:"1", value:"Documentos firmados"
					},{
						id:"2", value:"Doc. para firma del Director"
					},{
						id:"3", value:"Doc. para firma del Srio. Particular"
					}]
				},{
					view: "text", id: "telefono", name: "telefono", label: "Tel&eacute;fono", labelPosition: "top", hidden:false
			}]

		},
		<%} //  ENDIF %>
		{
			cols: [
			{
				view:"checkbox", id:"oficio_bis", name:"oficio_bis", label:"Oficio BIS", hidden:true, width:120, borderless:false,
			},
			{
				view: "text", id: "nume_cont", name: "nume_cont", labelPosition: "top", label: "N&uacute;mero de control", value: ""
			},
			{
				view: "datepicker", id: "fech_ofic", name: "fech_ofic", labelPosition: "top", label: "<span class='obligatorio'>*</span>Fecha oficio", value: new Date()
			},
			]
		},
		{
			cols:[
			{
				view: "select", id: "info_sens", name: "info_sens", label: "<span class='obligatorio'>*</span>El documento contiene informaci&oacute;n sensible?", value:"0", labelWidth:320, width:380,
				options:[
					{id:"0", value:"No"},
					{id:"1", value:"Si"}
				]
			},
			{
				width:50
			},
			{
				view:"select", label:"La informaci&oacute;n contenida en el documento es:", labelWidth:320, width:440, id:"tipo_info", name:"tipo_info",
				options:[
					{id:"0", value:""},
					{id:"1", value:"Fundamental"},
					{id:"2", value:"Ordinaria"}
				]
			}
			]
				
		},
		{
			cols: [{
				view: "datepicker", id: "fech_rece", name: "fech_rece", labelPosition: "top", label: "<span class='obligatorio'>*</span>Fecha recepci&oacute;n", value: new Date()
			}, {
				view: "text", label: "<span class='obligatorio'>*</span>Hora recepci&oacute;n", labelPosition: "top", attributes: { maxlength: 5 }, id: "hora_rece", name: "hora_rece", placeholder: "Formato 24 hrs.", value:hour.trim(), 
				validate: function (value) {
					return /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value);
				}, invalidMessage: "El formato de la hora es invalido"

			}, {
				view: "text", id: "nume_ofic", name: "nume_ofic", label: "<span class='obligatorio'>*</span>N&uacute;mero de oficio recibido", labelPosition: "top",

				suggest: {

					filter: function (item, value) {
						if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
							return true;
						return false;
					},
					keyPressTimeout: 500,
					body: {
						fitMaster: false,
						template: "#value#",
						dataFeed: "/api/op/cmb_control2W?t=1" 
					},
				},
				on:{
					"onBlur":function(){
						buscaOficio();
					}
				}
			}]
		},  {
			view: "fieldset", label: "Procedencia",
			body: {
				rows: [{
					view: "radio", labelWidth:120, label: "<span class='obligatorio'>*</span>Dependencia", id: "rbDepe", name: "rbDepe", on: { "onChange": function (newv, oldv) { cambiaCombo(newv, 'depe') } }, value: 1, options: [{
						id: 1, value: "U. de G."
					}, {
						id: 2, value: "Ajena a U. de G."
					}]
				}, {
					view: "combo", id: "dependen", name: "dependen",editable: true, value: "<% // Response.write(IIF(USED('ofic_sali') AND !EMPTY(ofic_sali.dependen),ofic_sali.dependen, '0'))%>",
					options: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 500,
						body: {
							fitMaster: false, template: "#value#",
							dataFeed: "/api/gen/cmb_depew?lnTipo=1"
						},
						<% //  IF USED('ofic_sali') AND !EMPTY("ofic_sali.dependen")
						//GO TOP IN ofic_sali%>
						//data: [{ id: "<% // Response.write(ofic_sali.dependen)%>", value: "<% // Response.write(STRTRAN(STRCONV(ofic_sali.depe_nomb,9),'"', "'"))%>" }], 
						<% //  ENDIF %>
					},
				}, {
					view: "text", hidden: true, id: "txtDepen", name: "txtDepen", value:"<% // Response.write(	IIF(USED('ofic_sali') AND !EMPTY(ofic_sali.dependen), ofic_sali.dependen,''))%>",
					on:{
						"onKeyPress": function(code, e){
							$$("id_cent").setValue('')
						}
					},
					suggest: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 500,
						body: {
							fitMaster: false, template: "#value#",
							dataFeed: "/api/gen/cmb_depew?lnTipo=2"
						},
						on: {
							"onValueSuggest": function (obj) {
								$$("txtDepen").setValue(obj.descrip)
								$$('id_cent').setValue(obj.id)
							}
						}
					},
				}, {
					view:"text", id:"id_cent", name:"id_cent", readonly:true, hidden:true
				},{
					view: "text", hidden: true, id: "clav_proc", name: "clav_proc"
				}]
			}
		}, {
			view: "fieldset", label: "Remitente",
				body: {
				cols: [{
					view: "text", id: "remi_nomb", name: "remi_nomb", label: "<span class='obligatorio'>*</span>Nombre", labelWidth: 120, labelPosition: "top",
					attributes:{ autocomplete :"off" },
					suggest: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 500,
						body: {
							fitMaster: false,
							template: "#value#",
							dataFeed: "/api/gen/cmb_persw?lnTipo=11"
						},
						on: {
							"onValueSuggest": function (obj) {
								//cargaCargo('remi_carg', obj.id, obj.value)
								$$("remi_carg").setValue(obj.cargo);

							}
						}
					},
				}, {
					view: "text", id: "remi_carg", name: "remi_carg", label: "Cargo", labelPosition: "top",
					attributes:{ autocomplete :"off" },
					suggest: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 500,
						body: {
							fitMaster: false,
							template: "#value#",
							dataFeed: "/<% // Response.Write(config.ruta)%>/cmb_opcargo.fwx"
						},
					}
				}]
			}
		}, {
			view: "fieldset", label: "Destinatario",
				body: {
				cols: [{
					view: "text", id: "dest_nomb", name: "dest_nomb", label: "<span class='obligatorio'>*</span>Nombre", labelPosition: "top",
					attributes:{ autocomplete :"off" },
					suggest: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 500,
						body: {
							fitMaster: false,
							template: "#value#",
							dataFeed: "/api/gen/cmb_persw?lnTipo=11"
						},
						on: {
							"onValueSuggest": function (obj) {
								//cargaCargo('dest_carg', obj.id, obj.value)
								$$("dest_carg").setValue(obj.cargo);
							}
						}
					},
				}, {
					view: "text", id: "dest_carg", name: "dest_carg", label: "Cargo", labelPosition: "top",attributes:{ autocomplete :"off" },
					suggest: {
						filter: function (item, value) {
							if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
								return true;
							return false;
						},
						keyPressTimeout: 500,
						body: {
							fitMaster: false,
							template: "#value#",
							dataFeed: "/<% // Response.Write(config.ruta)%>/cmb_opcargo.fwx"
						},
					}
				}]
			}
		}, {
			cols: [{
				view: "select", id: "tipo_ofic", name: "tipo_ofic", labelPosition: "top", label: "<span class='obligatorio'>*</span>Tipo oficio", value: 1, options: [
					<% //  SELECT cTipo_ofic
					//SCAN %>
					{ id: "<% // Response.write(cTipo_ofic.id_tiof)%>", value: "<% // Response.write(cTipo_ofic.descrip)%>" },
					<% //  ENDSCAN %>
					<%for (var i = 0; i < loTipo.length; i++) {%>
						{ id: "<%=loTipo[i].id_tiof%>", value: "<%=loTipo[i].descrip%>" },
					<%}%>
				],
				on: {
					"onChange": function (newv, oldv) {
						if (newv == 5) {
							$$("fech_term").show();
						} else {
							$$("fech_term").hide();
						}
					}
				}
			}, 
			{
				view: "datepicker", id: "fech_term", minuteStep: 1, name: "fech_term", labelPosition: "top", 
				label: "<span class='obligatorio'>*</span>Fecha termino", value: new Date(), hidden: true,	
				multiselect:"touch"
			}, 
			{ view: "text", id: "txtFech_term", name: "txtFech_term",hidden: true },
			{
				view: "select", id: "clase", name: "clase", labelPosition: "top", label: "<span class='obligatorio'>*</span>Clase", value: 1,	options: [
					<% //  SELECT cClase
					//SCAN %>
					//{ id: "<% // Response.write(cClase.id_clof)%>", value: "<% // Response.write(STRCONV(cClase.descrip,11))%>" },
					<% //  ENDSCAN %>
					<%for (var i = 0; i < loClas.length; i++) {%>
						{ id: "<%=loClas[i].id_clof%>", value: "<%=loClas[i].descrip%>" },
					<%}%>
				]
			},
			{
				view:"select", label:"Enviar por:", labelWidth:320, width:440, id:"tipo_ingr", name:"tipo_ingr", 
				options:[
					{id:"0", value:""},
					{id:"1", value:"Por correo"},
					{id:"2", value:"Oficio f&iacute;sico"}
				],
				labelPosition:"top", value:"<% // Response.write(IIF(!EMPTY(lcClav_ofic), '1', '0'))%>", 
			},
			]
		}, {
			view: "textarea", id: "asunto", name: "asunto", label: "<span class='obligatorio'>*</span>Asunto", labelPosition: "top", height: 120
		},
		{
			view: "combo", id:"seccion", name:"seccion", label: "Secci&oacute;n/Subsecci&oacute;n", labelPosition:"top", labelWidth:300, width:800,
			options: {
				filter: function (item, value) {
					if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
						return true;
					return false;
				},
				keyPressTimeout: 500,
						body: {
							fitMaster: false, template: "#value#",
							dataFeed: "/api/op/cmb_seccw"
						},
				// keyPressTimeout: 1000,
				//data:[]
			}
		},
		{
			view: "textarea", id: "nota", name: "nota", label: "Nota (Seguimiento)", labelPosition: "top", height: 80
		},
		{
			view: "textarea", id: "ligado_a", name: "ligado_a", label: "Ligado a:", labelPosition: "top", height: 80, hidden:true,
		},
		<% // IF !EMPTY(lnID_doficio)%>
		{
			cols:[
			{
				view:"multicombo", 
				label:"Adjuntar archivos adjuntos al oficio",  labelWidth:250, labelPosition:"top", 
				id:"adjuntos", name:"adjuntos",
				options:{
					filter: function (item, value) {
						if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
							return true;
						return false;
					},
					body:{
						maxWidth:400,
					},
                    /*
					url:()=>{
						return webix.ajax().get("/<% // Response.write(config.ruta)%>/op_ofic_arch.fwx?oficio=<% // Response.write(ofic_sali.id_iden)%>&to=1").then((res)=>{
							res = res.json();
							let values = []
							res.data.forEach((item)=>{
								values.push(item.id);
							})
							$$("adjuntos").setValue(values.toString())
							return res.data;
						})
					}
                    */
				}
			},
			{
				view:"button", label:"Marcar todos", width:100, click:()=>{
					let list = $$("adjuntos").getList();
					let values = [];
					let currentId = list.getFirstId()
					do{
						values.push(currentId);
						currentId = list.getNextId(currentId, 1);
					}while(currentId);

					$$("adjuntos").setValue(values.toString())
				}
			},
			{
				view:"button", label:"Desmarcar todos", width:100, click:()=>{
					$$("adjuntos").setValue()
				}
			}
			]
		},
		<% // ENDIF%>
		{
			view: "fieldset", label: "Ligar oficio",
			body: {
				rows: [{
					cols: [{
						view: "radio", label: "Ligar oficio", labelWidth:120, id: "rbLiga", name: "rbLiga", value: 1, on: { "onChange": function (newv, oldv) { cambiaCombo(newv, 'liga') } }, options: [{
							id: 1, value: "Salida"
						}, {
							id: 2, value: "Entrada"
						}]
					}, {
						view: "combo", placeholder: "Buscar oficio(De acuerdo a la oficialia seleccionada)", id: "cmbLiga_ofic", name: "cmbLiga_ofic",
						options: {
							filter: function (item, value) {
								if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
									return true;
								return false;
							},
							keyPressTimeout: 500,
							body: {
								fitMaster: false, template: "#value#",
								dataFeed: "/api/op/cmb_control3W?cve=<%=rows[0].cve%>" 
							},
						},
					}, {
						view: "button", label: "Ligar", click: ligar, width: 100
					}]
				}, {
					cols: [{
						view: "multiselect", placeholder: "Ofic. salida ligados", id: "liga_sali", name: "liga_sali", labelPosition: "top", label: "Ofic. salida ligados", options: [
							<% //  IF USED("ofic_sali") %>
							//{ "id":<% //  Response.write(ofic_sali.id_iden) %> , "value": "<% // Response.write(ofic_sali.oficio)%>" }
							<% //  ENDIF %>
						],
						value: "<% // Response.write(IIF(USED("ofic_sali"),ofic_sali.id_iden,0))%>"
					}, {
						view: "multiselect", placeholder: "Ofic. entrada ligados", id: "liga_entr", name: "liga_entr", options: [], labelPosition: "top", label: "Ofic. entrada ligados"
					}, {
						view: "button", width: 100, label: "Limpiar", click: function () { var lista = $$("liga_ofic").getList(); lista.clearAll(); $$("liga_ofic").setValue(); }, hidden: true
					},]

				}]
			}
		},{
			view: "button", label: "Ingresar oficio", click: guardar, id:"btnGuardar", align: "right", width: 150
		}]

		webix.ready(function () {
			webix.ui({
				view: "layout",
				responsive: true,
				rows: [{
					view: "scrollview",
					body: {
						rows: [{
							view: "form", id: "frm1",
							elements: form_elements,
							rules: {
								<%if(llDirectorio && !!laQuery.lcClav_ofic){ // IF llDirectorio AND EMPTY(lcClav_ofic)%>
								"tipo_docu": webix.rules.isNotEmpty,
								<%} // ENDIF%>
								"cve": webix.rules.isNotEmpty,
								"fech_ofic": webix.rules.isNotEmpty,
								"fech_rece": webix.rules.isNotEmpty,
								"hora_rece": webix.rules.isNotEmpty,
								"nume_ofic": webix.rules.isNotEmpty,
								dependen: function(value){ 
									var valido = false;
									var radio = $$("rbDepe").getValue()
									if((value != "" && radio == 1) || (value != "" && radio == 2) || (value == "" && radio == 2 && $$("dependen").getText() != "") )
										valido = true;

									return valido; 
								}, 
								"remi_nomb": webix.rules.isNotEmpty,
								//"remi_carg":webix.rules.isNotEmpty,

								"dest_nomb": webix.rules.isNotEmpty,
								//"dest_carg":webix.rules.isNotEmpty,

								"tipo_ofic": webix.rules.isNotEmpty,
								"clase": webix.rules.isNotEmpty,
								"asunto": webix.rules.isNotEmpty,
							},
						}]
					}
				}]
			});
			//inicializaCombo(1);
			<% // IF !EMPTY(lcClav_ofic)%>
			buscaOficio();
			$$("frm1").parse(<% //  Response.write(lcDatos) %>)
			cargaArchivosAdjuntos()
			// if($$("tipo_docu").getValue() == 1){
			// 	$$("doc_firm").show();
			// }else{
			// 	$$("doc_firm").hide();
			// }
			// // cambiaCombo(<% // Response.write(ofic_sali.rbDepe)%>,"depe")
			<% // ENDIF%>

			$$("anio_ingr").setValue(today.getFullYear())

			<% // IF !empty(lnOficio)%>
			//openWindow("Oficio <% // Response.write(lnNum_ofi)%>", "/<% // Response.Write(config.ruta)%>/op_detalle.fwx?lnOficio=<% // Response.write(lnOficio)%>&lnAsignado=" + 0);
			<% // ENDIF%>

			// var listServicio = $$("dependen").getPopup().getList();
			// listServicio.attachEvent("onAfterSelect", function (id) {
			//   getRemitente(id, 1)
			// });
		});




		//functions

		<% // IF !EMPTY(lnID_doficio)%>
		const cargaArchivosAdjuntos = ()=>{
			$$("")
		}
		<% // ENDIF%>


		const getRemitente = (id, tipo_depe)=>{
			webix.ajax().post("/<% // Response.write(config.ruta)%>/op_noficx.fwx", {txtTipo:tipo_depe, centro:id, tipo_depe:tipo_depe}).then((res)=>{
				res = res.json();
			})
		}

		function cargaCargo(campo, id, valor) {
			webix.ajax().post("/<% // Response.write(config.ruta)%>/op_noficxw.fwx?t=1", { "codigo": id, "nombre": valor }).then(function (response) {
				var respuesta = response.json()[0];
				if (respuesta.status) {
					$$(campo).setValue(respuesta.cargo);
				}
			})
		}

		function obtenerSeccion(){
			try{
				let id = $$("cve").getValue();
				let item = $$("cve").getPopup().getList().getItem(id);
				let cve = item && item.value ? item.value : "";

				let resultado = cve.replace(/^\s*\(.*?\)\s*/, "");
				
				webix.ajax().post("/<% // Response.write(config.ruta)%>/op_combox.fwx", {
					cveOfic: resultado
				}).then(function (response) {
				 	var data = response.json();
				 	if (data.status && data.padre) {
				 		$$("seccion").getPopup().getList().clearAll();
				 		$$("seccion").getPopup().getList().parse(data.padre);
					} 
				 });
			}catch(error){
				console.log(error)
			}
		}

		function buscaOficio(){
			var valor = $$("nume_ofic").getValue();
			var cve = $$("cve").getValue();
			if(cve != '' && valor != ''){
				webix.ajax().post("/api/op/op_ningrx2",{t:1, oficio:valor, cve:$$("cve").getValue()}).then(function(response){
					var respuesta = response.json()[0];
					if(respuesta.status){
						webix.alert({
							title:"", ok:"Aceptar", text:respuesta.message,
						});
					}
				})
			}
		}

		function buscaNume() {
			webix.ajax().get("/api/op/op_ningrx2",{anio:$$("anio_ingr").getValue(),cve:$$("cve").getValue(),tipo_docu:(typeof ($$("tipo_docu")) == 'undefined' ? 0 : $$("tipo_docu").getValue())}).then(function (response) {
				if (response.json().status) {
					$$("nume_cont").setValue(response.json().nume_cont)
				}
			})
		}

		function ligar() {
			var id = $$("cmbLiga_ofic").getValue();
			var texto = $$("cmbLiga_ofic").getText();
			console.log(id)
			console.log(texto)

			if (id == '' || id == null || typeof (id) == 'undefined' || id== 0) {
				webix.message({ text: "Debes seleccionar un registro" });
			} else {
				switch ($$("rbLiga").getValue()) {
					case 1: case '1':
						var lista = $$("liga_sali").getList();
						var lista_nombre = "liga_sali"
						break;
					case 2: case '2':
						var lista = $$("liga_entr").getList();
						var lista_nombre = "liga_entr"
						break;
					default: webix.message({ text: "Selecciona el tipo de oficio", type: "error", expire: 3000 })
						return
						break;
				}

				if (!lista.exists(id)) {
					//texto = texto.substring(0, texto.indexOf(')') + 1)
					var valor = $$(lista_nombre).getValue()
					$$(lista_nombre).setValue(valor + (valor != '' && typeof (valor) != 'undefined' && valor != null ? ',' : '') + id)

					lista.add({
						id: id,
						value: texto
					});
					$$(lista_nombre).refresh();
				}

			}
		}

		function inicializaCombo() {
			$$("cmbLiga_ofic").define({
				options: {
					filter: function (item, value) {
						if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
							return true;
						return false;
					},
					keyPressTimeout: 500,
					body: {
						fitMaster: false,
						template: "#value#",
						dataFeed: (valor == 1 ? "/api/op/cmb_control3W?cve=" + $$("cve").getValue() : "/api/op/cmb_control2W?cve=" + $$("cve").getValue())
					}
				}
			});
			$$("cmbLiga_ofic").refresh();

			$$("nume_ofic").define({
				suggest: {
					filter: function (item, value) {
						if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
							return true;
						return false;
					},
					keyPressTimeout: 500,
					body: {
						fitMaster: false,
						template: "#value#",
						dataFeed: "/api/op/cmb_control2W?t=1&cve=" + $$("cve").getValue()
					},
				}
			});
			$$("nume_ofic").refresh();

		}

		function cambiaCombo(valor, combo) {

			switch (combo) {
				case "liga":
					valor = $$("rbLiga").getValue();
					console.log(valor)
					if (valor == '' || valor == null || typeof (valor) == 'undefined' || valor == 0) {
						$$("rbLiga").setValue(1)
						valor = 1
					}
					$$("cmbLiga_ofic").define({
						options: {
							filter: function (item, value) {
								if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
									return true;
								return false;
							},
							keyPressTimeout: 500,
							body: {
								fitMaster: false,
								template: "#value#",
								dataFeed: (valor == 1 ? "/api/op/cmb_control3W?cve=" + $$("cve").getValue() : "/api/op/cmb_control2W?cve=" + $$("cve").getValue())
							}
						}
					});
					$$("cmbLiga_ofic").refresh();
					break;

				case "id_oficio":
					$$("nume_ofic").define({
						suggest: {
							filter: function (item, value) {
								if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
									return true;
								return false;
							},
							keyPressTimeout: 500,
							body: {
								fitMaster: false,
								template: "#value#",
								dataFeed: "/api/op/cmb_control2W?t=1&cve=" + valor
							},
						}
					});
					$$("nume_ofic").refresh();

					break;



				case "depe":
					if (valor == '') {
						$$("rbDepe").setValue(<% //  Response.write(IIF(USED("ofic_sali"), ofic_sali.rbDepe, 1)) %>);
						valor = $$("rbDepe").getValue()
					}
					
					$$("dependen").setValue();
					$$("txtDepen").setValue();
					$$("id_cent").setValue();
					if(valor == 1){
						$$("dependen").show();
						$$("txtDepen").hide();
					}else{
						$$("dependen").hide();
						$$("txtDepen").show();
					}
				break;
			}
				

		}

		function format(obj){			
			if (obj.value){
				if (webix.isArray(obj.value))
				return obj.value.map(webix.i18n.dateFormatStr).join(",");
				return webix.i18n.dateFormatStr( obj.value );
			}
			return "";
		}


		function guardar() {
		
			var radio = $$("rbDepe").getValue();
			if(radio == '' || radio == null || typeof(radio) == 'undefined'){
				webix.message({ text: "Debes seleccionar el tipo de servicio", type: "error", expire: 3000 })
				return false
			}
			if (! $$("frm1").validate()) {
				webix.message({ text: "Los campos que se marcan en rojo son obligatorios", type: "error", expire: 3000 })
				return 
			}

			if ($$("tipo_ofic").getValue() == 5 && !webix.rules.isNotEmpty($$("fech_term").getValue())) {
				$$("frm1").markInvalid("fech_term", "Debes especificar la fecha de termino")
				return
			} else {
				$$("frm1").markInvalid("fech_term", false)
				$$("txtFech_term").setValue(format($$("fech_term").data))
			}
			
			if($$("dependen").getValue() != "" && $$("rbDepe").getValue() == 1 && $$("dependen").getText() != "") {
				var txt = $$("dependen").getText();
				$$("txtDepen").setValue(txt.substring(txt.indexOf(')')+1).trim())
			}

			
			
			//$$("hora_rece").setValue($$("dhora_rece").getText())

			Swal.fire({
				text: "", title: 'Seguro de guardar los cambios?', icon: 'question', showCancelButton: true,  confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Si', cancelButtonText:"No",
			}).then((result) => {
				if(result.isConfirmed){
					//$$("btnGuardar").disable()  MIENTRAS LO ARREGLO
					let form = $$("frm1").getValues();
					form.oficio = <% // Response.write(lnID_iden)%>
					webix.ajax().post("/api/op/op_ningrx", form).then(function (response) {
						$$("btnGuardar").enable();
						try{
							var respuesta = response.json()[0];
							Swal.fire({text:respuesta.message, icon:respuesta.status ? "success":"error"}).then(()=>{
								if (respuesta.status) {
									window.location.href = '/op/op_ningr?lnNum_ofi=' + response.oficio + '&lnOficio='+ respuesta.id;
								}
							})

						}catch(err){
							Swal.fire({text:"Ocurrio un error, intenta mas tarde", icon:"error"}).then(()=>{
							})
						}
					})
				}
			})
		}

		function openWindow(title, url){
			var wid = webix.uid();
			webix.ui({
				view: "window", id: wid, fullscreen:true, resize: true,
				move: true, left: 0, top: 0, width: 1200, height: 800, 
				on:{
					onShow:()=>{
						$$(wid).config.move = !$$(wid).config.fullscreen;
					}
				},
				head: {
					view: "toolbar",
					cols: [
						{ view: "label", label: title },
						{
							view: "icon", icon: 'mdi mdi-arrange-bring-forward', tooltip:"Abre en una nueva ventana",
							click:()=>{
								window.open(url);
							}
						},
						{ view: "icon", icon: 'mdi mdi-window-minimize', tooltip:"Minimiza la ventana",
							click:()=>{
								$$(wid).hide();
								$$("toolbarVentanas").show()
								$$("toolbarVentanas").addView({
									width:200, 
									id:"sub"+wid,
									css:"item_window",
									cols:[
									{
										label:title.substr(0, 15), view:"label", css:{"padding":"0 0 0 10px"},
										click:()=>{ 
											$$("toolbarVentanas").removeView("sub"+wid)
											$$(wid).show();
										}
									},
									{
										view:"button", type:"icon", icon:"mdi mdi-window-maximize", borderless:true, width:32, 
										click:()=>{ 
											$$("toolbarVentanas").removeView("sub"+wid)
											$$(wid).show();
										}
									},
									{
										view:"button", type:"icon", icon:"mdi mdi-window-close", borderless:true, width:32, click:()=>{
											$$(wid).close();

											$$("toolbarVentanas").removeView("sub"+wid);
											hideToolbarWindow()
										}
									}
									]
								})
							} 
						},
						{ view: "icon", icon: 'mdi mdi-fullscreen', tooltip:"Maximiza la ventana",
							click:()=>{
								var ventana = $$(wid)
								
								ventana.config.fullscreen = !ventana.config.fullscreen;
								ventana.config.move = !ventana.config.fullscreen
								ventana.setPosition((ventana.config.fullscreen? 0:50),(ventana.config.fullscreen? 0:50))
								ventana.resize();
							} 
						},
						{ 
							view: "icon", icon: 'mdi mdi-close', tooltip:"Cierra la ventana", 
							click: ()=>{
								
								$$(wid).close(); 
								hideToolbarWindow()
							}
						}
					]
				},
				body: {
					view: "iframe",
					src: url
				}
			}).show();
		}
		
	</script>
</head>

<body>
</body>

</html>

