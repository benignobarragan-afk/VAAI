<%- include('../partials/header'); %>

	<%
    /*
	LOCAL llError, lcCentro, lcPie, llAplicar, lnOficio, lcOficio, lcPrevio, lnMens_usua
	LOCAL llNBusca, lcCVE, lcIniciales, lnIden, lcRuta_tabl
	LOCAL lcDiri_nomb, lnDiri_codi, lcDiri_carg, lcAten_nomb, lnAten_codi, lcAten_carg, llNBusca2, lnCant_ofic

	  
	lnID = VAL(Request.QueryString("lnID"))



	lcCve = ALLTRIM(cSoli.cve)

	IF SQLEXEC(lnCone_cgce, "SELECT * FROM gen_op_grupo WHERE id_grupo = ?lnID", "cGrupo") != 1
		a=Aerror(Mat)
		?SQLDISCONNECT(0)
		Response.write(Mat(2) + " Linea: 67")
		return
	ENDIF

	IF SQLEXEC(lnCone_cgce, "SELECT * FROM opc_op_config", "op_config") != 1
		a=Aerror(Mat)
		SQLDISCONNECT(0)
		sdsd
	ENDIF

	lcSQL = "SELECT id_depe,cve, depen, corto FROM ser_depen c WHERE id_depe in (SELECT DISTINCT id_depe FROM ser_pers_serv WHERE user_id = ?pcUser) AND cve = 'CGRH' "

	IF SQLEXEC(lnCone_cgce, lcSQL, "cArea_rh") != 1
		a=Aerror(Mat)
		SQLDISCONNECT(0)
		Response.write(Mat(2))
		return 
	ENDIF

	SQLDISCONNECT(0)
    */
%>
</head>

<body>
	<div id="div_atencion" style="background-color: #F4F4F4;"></div>
	<script>
		const validaFecha = (text, format)=>{
			return moment(text, format,true).isValid();
		}
		webix.ready(function(){

			webix.ui.datafilter.rowCount = webix.extend({
				refresh: function (master, node, value) {
					node.firstChild.innerHTML = "Total: " + master.count();
				}
			}, webix.ui.datafilter.summColumn)

			var ui = webix.ui({
				view: "scrollview",
				id: "verses",
				scroll: "y",
				body: {
					margin: 30, rows: [
						{
							rows: [
								{
									view: "form", id: "form_busc", name: "form_busc", 
									rows: [
										{
											cols: [
												{ view: "text", id: "txtNOficio", name: "txtNOficio", label:"Número de incio", labelPosition:"top", width: 200, pattern:{ mask:"#######", allow:/[0-9]/g}},
												{ maxWidth: 15 },
												{ view: "text", id: "txtNOficio2", name: "txtNOficio2", label:"Número de fin", labelPosition:"top", width: 200, pattern:{ mask:"#######", allow:/[0-9]/g}},
												{ maxWidth: 15 },
                                                { view: "combo", id: "cmbSoli", name: "cmbSoli",
                                                    //value: "<% // Response.Write(IIF(pnId_cent = 4, 'DG HCG', ALLTRIM(cSoli.cve)))%>",
                                                    label: "Oficio de",
                                                    value:"<%=rows[0].cve%>",
                                                    labelPosition:"top",
                                                    required: true, invalidMessage: "Este campo no puede ir vacio",
                                                    options: {
                                                        fitMaster: false,
                                                        width: 500,
                                                        body: {
                                                            data: [
                                                                <%for (var i = 0; i < rows.length; i++) {%>
                                                                { id: "<%= rows[i].cve%>", value: "(<%=rows[i].cve%>) <%=rows[i].depen%>" },
                                                                <%}%>
                                                            ]
                                                        }
                                                    },
                                                },
												{ maxWidth: 15 },
                                                {view: "select", label: "Año", id: "cmbAnio", name: "cmbAnio", value: <%=new Date().getFullYear()%>, width: 100,
                                                    labelPosition: "top", labelAlign: "left", options: [
                                                        <%
                                                        for (var i = new Date().getFullYear(); i >= 2021; i--){%>
                                                            { id: <%=i%>, value: "<%=i%>" },
                                                        <%
                                                        }
                                                        %>
                                                    ],
                                                },
											]
										},
                                        {
											cols: [
												{ view: "datepicker", id: "txtFec_ini", name: "txtFec_ini", label:"Fecha incio", labelPosition:"top", width: 200},
												{ maxWidth: 15 },
												{ view: "datepicker", id: "txtFec_fin", name: "txtFec_fin", label:"Fecha fin", labelPosition:"top", width: 200},
												{ maxWidth: 15 },
                                                { view: "text", id: "txtDepen", name: "txtDepen", label:"Dependencia", labelPosition:"top"},
											]
										},
                                        {
											cols: [
												{ view: "textarea", id: "txtConcepto", name: "txtConcepto", label:"Concepto", labelPosition:"top", height:100},
												{ maxWidth: 15 },
												{ view: "textarea", id: "txtRefe", name: "txtRefe", label:"Referencia", labelPosition:"top", height:100},
												{ maxWidth: 15 },
                                                { view: "textarea", id: "txtAnexo", name: "txtAnexo", label:"Anexo", labelPosition:"top", height:100},
                                                
											]
										},
										{
											cols: [
                                                { view: "text", id: "txtPersona", name: "txtPersona", label:"Persona", labelPosition:"top"},
                                                { maxWidth: 15 },
												{
													view: "select", label: "Tipo", id: "cmbTipo", name: "cmbTipo", value: 0, width: 120,
													labelPosition: "top", labelAlign: "left", options: [
													    { id: 0, value: "TODOS" },	
                                                        { id: 1, value: "Dirigido a" },
														{ id: 2, value: "Con copia" },
														/*
														{ id: 3, value: "Autoriza" },
														{ id: 4, value: "Vo. Bo." },
														*/
														{ id: 5, value: "Atenci&oacute;n a" },
														
													]
												},
                                                { maxWidth: 15 },
                                                {
													view: "select", label: "Estatus", id: "cmbStatus", name: "cmbStatus", value: -1, width: 200,
													labelPosition: "top", labelAlign: "left", options: [
                                                        { id:-1, value: "TODOS" },
														<%for (var i = 0; i < rows2.length; i++) {%>
                                                        { id:"<%=rows2[i].STATUS%>", value: "<%=rows2[i].DESCRIP%>" },
                                                        <%}%>
														
													]
												},
											]
										},
										{
											cols: [
												{
													view: "button", type: "icon", icon: "mdi mdi-magnify", label: "Buscar", width: 170,
													on: {
														onItemClick: function () { genera(); }
													}
												},
											]
										},
										{
                                            view:"datatable", id:"dtable", select:true, footer:true, editable:true, hidden:false, minHeight:500, scroll:true, tooltip: true,
                                            resizeColumn: true,  navigation: true, resizeRow:true, css:"celda_compacta", 
                                            rightSplit:1, leftSplit:3,
                                            scheme: {
                                                $init: function (obj) {
                                                    obj.fecha = (obj.fecha ? (obj.fecha == '01/01/1900'?'': convertDate(obj.fecha) ) : '');
                                                }
                                            },

                                            columns:[
                                            {
                                                id: "detalle", width: 40,sort: "int", css: { 'text-align': 'center' }, 
                                                header: [{text:"",css:"my_style"}, {text:""}],
                                                template: (obj) => {
													// Solo el icono con una clase para identificar el clic
													return `<i style='font-size:26px;color:#2b96cc;cursor:pointer;' 
															class='fa-solid fa-magnifying-glass btn_ver_detalle'></i>`;
												},
                                            },
                                            {
                                                id: "doc", width: 80,sort: "int", css: { 'text-align': 'left' }, hidden:false,
                                                header: [{text:"Doc.",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                                template:(obj)=>{
                                                    if(obj.doc != ''){
                                                    //	return `<a href="#" onClick="window.open('${obj.doc}');">
                                                    //		<img alt="Detalle del oficio" src="/imagenes/word.png" width="28" height="28" border="0">
                                                    //	</a>`
                                                    return `<div class='webix_el_button' style='cursor: pointer;' align='center'><a href='${obj.doc}' target='_blank'><i style='font-size:32px;color:#2b96cc;' class='far fa-file-word'></i></a></div>`
                                                    }else{
                                                        return `<input type="button" name="btnGenera" id="btnGenera" value="Generar" 
                                                            onclick="gene_gdoc('${obj.cve.trim()}','${obj.idoficio}','${obj.anio}','${obj.id}' );">`
                                                    }
                                                },
                                            },
                                            {
                                                id: "rank", width: 70,sort: "int", css: { 'text-align': 'center' }, 
                                                header: [{text:"#",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                            },	
                                            {
                                                id: "oficio", width: 150,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Oficio",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                            },	
                                            {
                                                id: "fecha", header: ["Fecha", { content: "textFilter", compare:dateStringFilter }], sort: "date", width: 100, format:webix.Date.dateToStr("%d/%m/%Y")
                                            },	
                                            {
                                                id: "hora", header: ["Hora", { content: "textFilter"}], width: 70,
                                            },	
                                            {
                                                id: "centros", width: 200,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Centros",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                            },		
                                            {
                                                id: "concepto", 
                                                $height:160, 
                                                fillspace:true, minWidth:300,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Concepto",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                    
                                                }],
                                            },		
                                            {
                                                id: "referencia", width: 70,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Ref.",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                            },		
                                            {
                                                id: "anexo", width: 70,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Anexo",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                            },	
                                            {
                                                id: "solicitado", width: 70,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Solic.",css:"my_style"}, {
                                                    content: "textFilter", placeholder:"Filtrar",
                                                }],
                                            },		
                                            {
                                                id: "stat_desc", width: 100,sort: "string", css: { 'text-align': 'left' }, 
                                                header: [{text:"Status",css:"my_style"}, {
                                                    content: "selectFilter", placeholder:"Filtrar",
                                                }],
                                            },
                                            ],
											onClick: {
												// Esta función se activa cuando se hace clic en cualquier elemento con esta clase
												"btn_ver_detalle": function(ev, id) {
													// 'id' es el ID de la fila en Webix
													const obj = this.getItem(id); 
													
													// Ejecutamos tu función original de forma segura
													if (window.parent && typeof window.parent.deta_sali === "function") {
														window.parent.deta_sali(obj.cve, obj.idoficio, obj.anio, obj.id_iden, '/op/op_reof0');
													}
													
													// Evita comportamientos extraños del navegador
													return false; 
												}
											}
                                        }
									]
								}
							]
						}
					]
				}
			});
			webix.ui({
				view: "window", id: "mues_plan",
				move: true, left: 150, top: 0, width: 900, height: 550, resize: true,
				head: {
					view: "toolbar", id: "plantilla",
					cols: [
						{ view: "label", label: "Plantillas" },
						{ view: "icon", icon: 'mdi mdi-close', click: "$$('mues_plan').hide();" }
					]
				},
				body: {
					view: "iframe",
					src: "/op/op_plan"
				}
			},
			);

/* 			mues_soli();
			obtenerSeccion()
			var listServicio = $$("cmbServicio").getPopup().getList();
			listServicio.attachEvent("onAfterSelect", function (id) {
			  dirigido(id, 9)
			});
 */
		});

		function genera() {
            let form = $$("form_busc").getValues()

            //console.log(form)
			webix.extend($$("dtable"), webix.ProgressBar)
            $$("dtable").clearAll()
            $$("dtable").load("/api/op/op_reof0x?loForm=" + JSON.stringify(form))
		}

	</script>
</body>


</html>