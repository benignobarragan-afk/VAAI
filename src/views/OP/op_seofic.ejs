<!DOCTYPE html>
<html>

<head>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title></title>

	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
		integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
	</script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
	</script>

	<script src="/webix/codebase/webix.js"></script>
	<script src="/js/funciones_webix.js"></script>
	<script src="/webix/codebase/locale.js"></script>
	<link rel="stylesheet" type="text/css" href="/webix/codebase/webix.css" />
	<link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.7.94/css/materialdesignicons.css?v=6.3.5" type="text/css" charset="utf-8">

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />
	<script src="/js/momentjs.js"></script>
	<%
    /*
	LOCAL llError, lcCentro, lcPie, llAplicar, lnOficio, lcOficio, lcPrevio, lnMens_usua
	LOCAL llNBusca, lcCVE, lcIniciales, lnIden, lcRuta_tabl
	LOCAL lcDiri_nomb, lnDiri_codi, lcDiri_carg, lcAten_nomb, lnAten_codi, lcAten_carg, llNBusca2, lnCant_ofic

	  
	lnID = VAL(Request.QueryString("lnID"))



	lcCve = ALLTRIM(cSoli.cve)

	IF SQLEXEC(lnCone_cgce, "SELECT * FROM gen_op_grupo WHERE id_grupo = ?lnID", "cGrupo") != 1
		a=Aerror(Mat)
		?SQLDISCONNECT(0)
		Response.write(Mat(2) + " Linea: 67")
		return
	ENDIF

	IF SQLEXEC(lnCone_cgce, "SELECT * FROM opc_op_config", "op_config") != 1
		a=Aerror(Mat)
		SQLDISCONNECT(0)
		sdsd
	ENDIF

	lcSQL = "SELECT id_depe,cve, depen, corto FROM ser_depen c WHERE id_depe in (SELECT DISTINCT id_depe FROM ser_pers_serv WHERE user_id = ?pcUser) AND cve = 'CGRH' "

	IF SQLEXEC(lnCone_cgce, lcSQL, "cArea_rh") != 1
		a=Aerror(Mat)
		SQLDISCONNECT(0)
		Response.write(Mat(2))
		return 
	ENDIF

	SQLDISCONNECT(0)
    */
%>


	<style type="text/css">
		.dhtmlx-error {
			font-weight: bold;
			color: white;
			background-color: #770000;
		}

		.webix_dtable .webix_ss_header {
			font-weight: bold;
		}

		.edited {
			font-weight: bold;
		}

		.footer {
			font-weight: bold;

		}

		.my_style .webix_hcell {
			background: #2b96cc;
			color: white;
		}

		.my_style .webix_column {
			font-style: italic;
			background: #d5eefb;
			opacity: 0.8;
		}

		.my_style .webix_column>div {
			border-color: #d5eefb;
		}

		/* Definición del color verde para el texto */
		.archivo-verde a {
			color: #4CAF50 !important; /* Un tono de verde claro y visible */
			font-weight: bold; /* Opcional: para que resalte más */
		}

	</style>
</head>

<body onLoad="doOnLoad();">
	<div id="div_atencion" style="background-color: #F4F4F4;"></div>
	<script>
		const validaFecha = (text, format)=>{
			return moment(text, format,true).isValid();
		}
		function doOnLoad() {

			webix.ui.datafilter.rowCount = webix.extend({
				refresh: function (master, node, value) {
					node.firstChild.innerHTML = "Total: " + master.count();
				}
			}, webix.ui.datafilter.summColumn)


			var ui = webix.ui({
				view: "scrollview",
				id: "verses",
				scroll: "y",
				body: {
					margin: 30, rows: [
						{
							rows: [
								{
									view: "form", id: "form",
									rows: [
										{cols: [
										{
											label: "Concepto", view: "textarea", id: "txtConcepto", name: "txtConcepto", labelWidth: 95, labelPosition:"top", height: 120, value:`<%=rows2[0].CONCEPTO%>`, 
										},
										{width:15},
										{rows: [
											{ 
												view: "uploader", value: "Adjunta un archivo PDF", accept:"application/pdf",
												name:"filePDF", id:"filePDF", width:300,
												link:"list1",  upload:"/api/op/op_uoficio",
												formData: {
													idOficio: <%=rows2[0].ID_IDEN%>, out: 1
												},
													on:{
															onUploadComplete:(response, file)=>{

															console.log(response);
															console.log(response.message);
															webix.message({ type:"info", text:response.message, id:"loadingMsg" });
															$$("form").enable();
															carg_arch();

															//$$("formPDF").hideProgress();
														},
														onBeforeFileAdd: function (item) {
														//$$("formPDF").showProgress();

														$$("form").disable(); 
														//$$("textoPDF").setValue("Subiendo y procesando archivo...");
														webix.message({ type:"info", text:"Subiendo y procesando archivo...", id:"loadingMsg" });
										
														return true;
														},
														onUploadFail: function (item){
														$$("form").enable(); 
														},
													}
												},
												{
												view:"list",  id:"list1", type:"uploader",
												autoheight:true, borderless:true	
												},
										]},
										]},
										{
										cols: [
											{
											view: "combo", id:"seccion", name:"seccion", label: "Secci&oacute;n/Subsecci&oacute;n", labelPosition:"top",
											labelWidth:300, width:800, options: {
													filter: function (item, value) {
														if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
															return true;
														return false;
													},
													keyPressTimeout: 500,
															body: {
																fitMaster: false, template: "#value#",
																dataFeed: "/api/op/cmb_seccw"
															},
													// keyPressTimeout: 1000,
													//data:[]
												},
											},
											{},
											<%if(!!rows2[0].GDOC){%>
											{
												view: "button",
												type: "icon", 
												label: "Ver GoogleDocs", // El texto del botón
												css: "webix_primary",      // Clase para darle un estilo primario (opcional)
												icon: "mdi mdi-file-word-box",      // Ícono de PDF de la librería Webix
												width: 180,
												// icon: "fa fa-file-pdf-o", // Alternativa si usas Font Awesome
												
												// Manejador de eventos onClick
												click: function() {
													// La URL del PDF que quieres abrir
													const pdfUrl = "<%=rows2[0].GDOC%>"; 
													
													// Abrir la liga en una nueva pestaña
													window.open(pdfUrl, '_blank');
												}
											},
											<%}%>
										]
										},
										{
											cols: [
												{ label: "Referencia", view: "textarea", name: "txtRefe", labelWidth: 95, labelPosition:"top", value:`<%=rows2[0].REFERENCIA%>`},
												{width:15},
												{ label: "Anexos", view: "textarea", name: "txtAnexo", labelWidth: 95, labelPosition:"top", value:`<%=rows2[0].ANEXO%>`},
											]
										},
										{
											view:"label", 
											label: "Oficios de entrada respondidos con este oficio", 
											align:"center"
										},
										{
											view: "datatable", id: "oligado", select: "row", editaction: "dblclick", rowCss: "#css#", drag:true, 
											columns: [
												{ id: "nume_cont", header: ["No. control", { content: "textFilter" }], width: 100, sort: "string", css: { 'text-align': 'left' } },
												{ id: "descrip", header: ["Oficio", { content: "textFilter" }], width: 200, sort: "string", css: { 'text-align': 'left' } },
												{ id: "fecha", header: ["Fecha", { content: "textFilter" }], width: 200, sort: "string", css: { 'text-align': 'center' } },
												{ id: "nomb_proc", header: ["Dependencia", { content: "textFilter" }], width: 280, sort: "string", css: { 'text-align': 'left' } },
                                                { id: "nomb_remi", header: ["Remitente", { content: "textFilter" }], width: 280, sort: "string", css: { 'text-align': 'left' } },
												{ id: "nomb_dest", header: ["Dirigido", { content: "textFilter" }], width: 280, sort: "string", css: { 'text-align': 'left' } },
												{ id: "dtipo_ofic", header: ["Tipo", { content: "textFilter" }], width: 120, sort: "string", css: { 'text-align': 'center' } },
												{ id: "dclas_ofic", header: ["Clase", { content: "textFilter" }], width: 120, sort: "string", css: { 'text-align': 'center' } },
											],
											footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true,
											editable: true, height: 250,
											data:[
												<%for (var i = 0; i < rows5.length; i++) {%>
												{ nume_cont: "<%= rows5[i].NUME_CONT%>", 
												descrip: `<%=rows5[i].DESCRIP%>`,
												fecha: `<%=rows5[i].FECHA.toISOString().substring(0, 19)%>`,
												nomb_proc: `<%=rows5[i].NOMB_PROC%>`,
												nomb_remi: `<%=rows5[i].NOMB_REMI%>`,
												nomb_dest: `<%=rows5[i].NOMB_DEST%>`,
												dtipo_ofic: "<%=rows5[i].dtipo_ofic%>",
												dclas_ofic: "<%=rows5[i].dclas_ofic%>",
												},
												<%}%>
											],
											/*
											on: {
												onBeforeLoad: function () { this.showOverlay("Cargando..."); },
												onAfterLoad: function () {
													this.hideOverlay();
													//this.adjustRowHeight("nota", true);
													this.render();
												},
											},
											*/
										},
										
	 
										{
											cols: [
												{
													view: "combo", id: "cmbStatus", name: "cmbStatus",
													//value: "<% // Response.Write(IIF(pnId_cent = 4, 'DG HCG', ALLTRIM(cSoli.cve)))%>",
													label: "Próximo status", width: 200,
													value:"<%=(rows3.length>1?rows3[0].id:'')%>",
													labelPosition:"top",
													required: true, invalidMessage: "Este campo no puede ir vacio",
													options: {
														fitMaster: false,
														body: {
															data: [
																<%for (var i = 0; i < rows3.length; i++) {%>
																{ id: "<%= rows3[i].id%>", value: "<%=rows3[i].descrip%>" },
																<%}%>
															]
														}
													},
													on: {
														onChange: ()=>{
															//mues_soli();
															//obtenerSeccion();
															
														}
													}
												},
												{width: 80},
												{label: "Nota estatus", view: "textarea", id: "txtStatus", name: "txtStatus", labelWidth: 95, labelPosition:"left", },
												{ view: "button", css: "webix_primary", label: "Cambio de estatus", click: camb_stat, width: 120, id: "btncamb_stat", align: "right", disabled: <%=(rows2[0].STATUS>3 || (rows2[0].STATUS==1 && rows6[0].titular != 1)?'true':'false')%> },
											] 
											
										},
										{
										cols:[
											{
												view: "datatable", id: "dtable", select: "row", editaction: "dblclick", rowCss: "#css#", drag:true, tooltip: true,
												columns: [
													{ id: "descrip", header: ["Estatus", { content: "textFilter" }], width: 140, sort: "string", css: { 'text-align': 'left' } },
													{ id: "nota", header: ["Nota", { content: "textFilter" }], width: 340, sort: "string", css: { 'text-align': 'left' } },
													{ id: "usuario", header: ["Usuario", { content: "textFilter" }], width: 110, sort: "string", css: { 'text-align': 'left' } },
													{ id: "inicio", header: ["Inicio", { content: "textFilter" }], width: 180, sort: "string", css: { 'text-align': 'center' } },
													{ id: "fin", header: ["Fin", { content: "textFilter" }], width: 180, sort: "string", css: { 'text-align': 'center' } },
													{ id: "duracion", header: ["Duración (minutos)", { content: "textFilter" }], width: 180, sort: "string", css: { 'text-align': 'center' } },
												],
												footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true,
												editable: true, height: 250,
												data:[
													<%for (var i = 0; i < rows4.length; i++) {%>
													{ id: "<%= rows4[i].id%>", 
													descrip: `<%=rows4[i].descrip%>`,
													nota: `<%=rows4[i].nota%>`,
													usuario: "<%=rows4[i].usuario%>",
													inicio: "<%=(!rows4[i].inicio ? '' : rows4[i].inicio.toISOString().substring(0, 19))%>",
													fin: "<%=(!rows4[i].fin ? '' : rows4[i].fin.toISOString().substring(0, 19))%>",
													duracion: "<%=rows4[i].duracion%>",
													},
													<%}%>
												],
												/*
												on: {
													onBeforeLoad: function () { this.showOverlay("Cargando..."); },
													onAfterLoad: function () {
														this.hideOverlay();
														//this.adjustRowHeight("nota", true);
														this.render();
													},
												},
												*/
											},
											{ maxWidth: 15 },
											{
											rows: [
												{view:"label", label:"Archivos"},
												{
													view: "list",
													id: "archivos_adjuntos",
													width: 400,
													header: "Archivos Adjuntos",
													scroll: "y",      // Permite scroll vertical si hay muchos
													
													// **CLAVE:** Este template define cómo se verá cada archivo
													template: function(obj) {
														// obj es el objeto de datos (e.g., {id: 1, nombre: "factura.pdf", ...})
														
														let html = "<div class='file-item archivo-verde'>";
														
														// Icono basado en la extensión (ejemplo)
														html += "<span class='webix_icon wxi-trash delete-file'></span> ";
														
														// Enlace de descarga (usa el ID o la ruta)
														html += "<a href='/api/op/adownload?id=" + obj.id + "' target='_blank'>";
														html += obj.nombre; // Muestra el nombre del archivo
														html += "</a>";
														
														// Botón de eliminar (con un evento para manejar la lógica de borrado)
														html += "<span class='webix_icon wxi-file' data-id='" + obj.id + "'></span>";
														
														html += "</div>";
														return html;
														},
													on: {
														onItemClick: function(id_item, e, node) {
															
															if (e.target.className.indexOf('delete-file') !== -1) {
																
																let id_archivo_a_borrar = id_item; 
																alert("Se hizo clic en el bote de basura para el archivo con ID: " + id_archivo_a_borrar);
																
																// **Llama a la función de confirmación y eliminación**
																//confirmarYEliminarArchivo(id_archivo_a_borrar);
																
																// Prevenir que el evento se propague si es necesario
																return false; 
															}
														}
													},
													
													// Configuración para cargar datos del servidor (metadatos de MariaDB)
													data:[
													//	{ "id": 1, "nombre": "factura_compra_01.pdf", "ruta": "/uploads/a3b1c2.pdf" },
													//	{ "id": 2, "nombre": "contrato_firmado.docx", "ruta": "/uploads/x9y8z7.docx" }
														]
												}
											] 
											},
										]
										},
                                        


									]
								}
							]
						}
					]
				}
			});
			webix.ui({
				view: "window", id: "mues_plan",
				move: true, left: 150, top: 0, width: 900, height: 550, resize: true,
				head: {
					view: "toolbar", id: "plantilla",
					cols: [
						{ view: "label", label: "Plantillas" },
						{ view: "icon", icon: 'mdi mdi-close', click: "$$('mues_plan').hide();" }
					]
				},
				body: {
					view: "iframe",
					src: "/op/op_plan"
				}
			});
			carg_arch();
			/*
			mues_soli();
			obtenerSeccion()
			var listServicio = $$("cmbServicio").getPopup().getList();
			listServicio.attachEvent("onAfterSelect", function (id) {
			  dirigido(id, 9)
			});
			*/

		}

		function mues_soli() {
			var cve = $$("cmbStatus").getValue()
			if (cve == "DG HCG") {
				$$("lblSolcitud").show();
				$$("cmbSoli_ofic").show();
				$$("cmbTipoFormatoRh").hide();
				$$("txtSoli_moti").show();
				
			} else if (cve == "CGRH") {
				$$("cmbTipoFormatoRh").show();
				$$("lblSolcitud").hide();
				$$("cmbSoli_ofic").hide();
				$$("txtSoli_moti").hide();
			} else {
				$$("lblSolcitud").hide();
				$$("cmbSoli_ofic").hide();
				$$("cmbTipoFormatoRh").hide();
				$$("txtSoli_moti").hide();
			}
			if(["SP", "CA"].includes(cve))
				$$("nombramiento").show();
			else
				$$("nombramiento").hide();
			if(["SP", "CA", "DG HCG"].includes(cve)){
				$$("anteriorSpace").show()
			}else{
				$$("anteriorSpace").hide()
			}

			//buscaFirma(cve);					//la cancelo por que creo que ya no se necesita en la U. de G.  11/05/2025
			
		}

		function mues_dato(id){
			webix.ajax()
				.get("/api/op/op_noficx7", {id})
				.then(function (data) {
					let res = data.json()[0]
					
					//console.log("si entro")
					//console.log(typeof res)
					
					if (typeof res != undefined){
						$$("txtCorr_ofic").setValue(res.corr_ofic);
						$$("cmbPers").setValue(res.diri_nomb);
						$$("txtDiri_carg").setValue(res.diri_carg);
					//console.log(res.corr_ofic)
					}
				})



		}

		function buscaFirma(cve) {
			$$("firma").define({
				options: {
					filter: function (item, value) {
						if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
							return true;
						return false;
					},
					body: {
						fitMaster: false,
						keyPressTimeout: 300,
						template: "#value#  (#cargo#)",
						url: "/<% // Response.write(config.ruta)%>/op_noficx4.fwx?lnTipo=2&cve="+cve
					}
				}
			});
			$$("firma").render();

		}

		function mues_grupo() {
			webix.ui({
				view: "window", id: "mues_grup",
				move: true, left: 150, top: 0, width: 900, height: 550, resize: true,
				head: {
					view: "toolbar", id: "grupo",
					cols: [
						{ view: "label", label: "Grupos" },
						{ view: "icon", icon: 'mdi mdi-close', click: "$$('mues_grup').close();" }
					]
				},
				body: {
					view: "iframe",
					src: "/op/op_grup"
				}
			}).show();
		}

		function plantilla() {
			if(!$$("mues_plan").isVisible())
				$$("mues_plan").show()
		}

		function genera() {
			
			if (!$$("tree").isVisible()) {
				$$("tree").show();
				$$("clearTree").show();
			}


			//
			$$("tree").load("/<% // Response.write(config.ruta)%>/op_noficx6.fwx?lnSalida=0&lnOfic=" + $$("cmb_Control").getValue())

		}

		function clearTree() {
			$$("tree").clearAll();
			$$("tree").hide();
			$$("clearTree").hide();
		}

		function camb_stat() {

			

			if (!$$("form").validate()) {
				webix.alert("Los campos con * son obligatorios")
				return false;
			}

			//console.log($$("cmbStatus").getValue());
			webix.ajax()
				.post("/api/op/op_soficx", {lnIDIden:<%=rows2[0].ID_IDEN%>, lnTipo:1, lnStatus:$$("cmbStatus").getValue(), lcStatus:$$("txtStatus").getValue()})
				.then(function (data) {
					$$("btncamb_stat").enable();
					let res = data.json()
					console.log(res)
					Swal.fire({
						title:res.message, icon:res.status?"success":"error"
					}).then(()=>{
						if(res.status)
							window.location.reload();
					})
					// webix.alert({ type: (data.json()[0].status ? "" : "alert-error"), text:  })
					// if (data.json()[0].status)
						

				})

		}

		function carg_grupo(aGrupo) {
			console.log(typeof aGrupo)
			if (aGrupo != ""){
				$$("dtable").load("/api/op/op_noficx4?lnTipo=1&laId=" + aGrupo);
			}
			else{
				Swal.fire({
				icon: "error",
				title: "Falta seleccionar",
				text: "Por lo menos selecciona un grupo",
				timer: 3500
				});
			} 

		}

		function carg_arch() {
			
			$$("archivos_adjuntos").clearAll()
			$$("archivos_adjuntos").load("/api/op/recu_arch?lnOficio=<%=rows2[0].ID_IDEN%>&out=1");
		}

		function carg_plantilla(plantilla) {
			webix.ajax()
				.get("/api/op/op_noficx4?lnTipo=3&laId=" + plantilla)
				.then(function (res) {
					lcDescrip = res.json()[0].descrip.replace(/\\n/g, '\n')
					lcDescrip = lcDescrip.replace(/\\n/g, '\n')

					$$("txtConcepto").setValue(res.json()[0].descrip.replace(/\\n/g, '\n'));
				})

		}

		function obtenerSeccion(){
			return false;			//lo canselo por que no hay series 
			try{
				let id = $$("cmbStatus").getValue();
				let item = $$("cmbStatus").getPopup().getList().getItem(id);
				let cve = item && item.value ? item.value : "";

				let resultado = cve.replace(/^\s*\(.*?\)\s*/, "");
				
				webix.ajax().post("/<% // Response.write(config.ruta)%>/op_combox.fwx", {
					cveOfic: resultado
				}).then(function (response) {
				 	var data = response.json();
				 	if (data.status && data.padre) {
				 		$$("seccion").getPopup().getList().clearAll();
				 		$$("seccion").getPopup().getList().parse(data.padre);
					} 
				 });
			}catch(error){
				console.log(error)
			}

			// let id = $$("cmbStatus").getValue();
			// let item = $$("cmbStatus").getPopup().getList().getItem(id);
			// //console.log(id, item);
			
			// let cve = item && item.value ? item.value : "";

			// let resultado = cve.replace(/^\s*\(.*?\)\s*/, "");

			// //console.log(resultado);
			
			// webix.ajax().post("/<% // Response.write(config.ruta)%>/op_combox.fwx", {
			// 	cveOfic: resultado
			// })
			
			//  .then(function (response) {
			// // 	console.log(response);
				
			//  	var data = response.json();
		
			//  	if (data.status && data.padre) {
					
			//  		$$("combHijos").getPopup().getList().clearAll();
			//  		$$("combHijos").getPopup().getList().parse(data.padre);
			// 	} 
			// 	// else {
			//  	// 	webix.message("No se encontraron opciones");
			//  	// }
			//  });
		}

		function liga_ofic() {


			if ($$("cmb_Control").getValue() != "") {
				if ($$("txtOfic_refe").getValue() == "") lcSepara = "";
				else lcSepara = ",";

				$$("txtOfic_refe").setValue($$("txtOfic_refe").getValue() + lcSepara + $$("cmb_Control").getValue());
				$$("txtOfic_liga").setValue($$("txtOfic_liga").getValue() + lcSepara + $$("cmb_Control").getText());
			}
			else {
				alert("Selecciona un oficio para ligarlos");
				return false;
			}

		}

		function liga_ofic2() {

			if ($$("cmb_Control").getValue() != "") {
				if ($$("txtOfic_refe").getValue() == "") lcSepara = "";
				else lcSepara = ",";

				$$("txtOfic_refe").setValue($$("txtOfic_refe").getValue() + lcSepara + $$("cmb_Control").getValue());
				$$("txtOfic_liga").setValue($$("txtOfic_liga").getValue() + lcSepara + $$("cmb_Control").getText());
			}
			else {
				alert("Selecciona un oficio para ligarlos");
				return false;
			}

		}

		function veri_corr(correo) {
			var regex = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

			return regex.test(correo.trim());
		}

		function registro(tipo) {
			if (tipo == 1) {
				var lnTipo_cont = $$("cmbTipo").getValue();
				// var lnDepe = (lnTipo_cont > 1 ? 0 : $$("cmbTipo_depe").getValue());
				var lnDepe = $$("cmbTipo_depe").getValue();
				var lnServicio = (lnDepe == 1 ? $$("cmbServicio").getValue() : lnDepe == 2 ? $$("id_ajena").getValue() : 0);
				var lcText_depe = (lnDepe == 1 ? $$("cmbServicio").getText() : lnDepe == 2 ? $$("cmbAjena").getValue() : "");
				var lcCorreo = substrMail($$("txtCorr_ofic").getValue())


				if (lnTipo_cont == 1 && ((lnDepe == 1 && $$("cmbServicio").getValue() == "") || (lnDepe == 2 && $$("cmbAjena").getValue() == "" && $$("id_ajena").getText() == "") || ($$("txtCorr_ofic").getValue() == "" && !['DG HCG', 'SP'].includes($$("cmbStatus").getValue())) || $$("cmbPers").getValue() == "" || $$("txtDiri_carg").getValue() == "")) {
					webix.alert("Tienes que llenar todos los campos para poder agregar una persona de tipo 'Dirigido a'");
					return
				}

				if (lnDepe > 0) {
					// laId = $$("dtable").find(function (obj) {
					// 	return obj.id == lnServicio;
					// });
					// if (laId.length > 0) {
					// 	alert("Ya ingresaste este servicio")
					// 	return false;
					// }
				}

				if ((lnTipo_cont == 2 || lnTipo_cont == 3 || lnTipo_cont == 4) && ($$("txtCorr_ofic").getValue() == "" || $$("cmbPers").getValue() == "")) {
					webix.alert("Tienes que por lo menos el nombre y correo para los tipos de persona 'Con copia', 'Autoriza', 'Vo. Bo.'");
					return
				}

				if ((lnTipo_cont == 5) && ($$("txtDiri_carg").getValue() == "" || $$("cmbPers").getValue() == "")) {
					webix.alert("El nombre y puesto deben ser llenados para el tipo 'Atenci�n a'");
					return
				}

				if (!veri_corr(lcCorreo) && !['DG HCG', 'SP'].includes($$("cmbStatus").getValue()) ) {
					webix.alert("El correo tiene un formato invalido");
					return
				}

				$$("dtable").add({
					// id: lnServicio,
					servicio: lnServicio,
					nomb_serv: lcText_depe,
					correo: lcCorreo,
					nombre: $$("cmbPers").getValue(),
					ocupacion: $$("txtDiri_carg").getValue(),
					tipo: $$("cmbTipo").getValue(),
					tipo_depe: lnDepe,
					copias:$$("copias").getValue()
				});
				$$("cmbServicio").setValue();
				$$("txtCorr_ofic").setValue();
				$$("cmbPers").setValue();
				$$("copias").setValue();
				$$("precargado").getList().clearAll();
				$$("precargado").setValue()

				$$("txtDiri_carg").setValue();
			} else {

				if ($$("dtable").getSelectedId() == undefined)
					//webix.message({ type: "debug", text: "Selecciona un registro para eliminar", expire: 2500 })
					Swal.fire({
						position: "top-end",
						icon: "warning",
						title: "Selecciona un registro para eliminar",
						showConfirmButton: false,
						timer: 2500
						});
				else
//					if (confirm("Estas seguro que deseas eliminar el registro?"))
//						$$("dtable").remove($$("dtable").getSelectedId());
					Swal.fire({
					title: "Eliminar",
					text: "¿Estas seguro que deseas eliminar el registro?",
					icon: "question",
					showCancelButton: true,
					confirmButtonColor: "#b58a3b",
					cancelButtonColor: "#893935",
					confirmButtonText: "Si, eliminar!",
					cancelButtonText: "No",
					}).then((result) => {
					if (result.isConfirmed) {
						$$("dtable").remove($$("dtable").getSelectedId());
						Swal.fire({
						title: "Eliminado!",
						text: "Registro eliminado.",
						icon: "success"
						});
					}
					});
			}

		}

		function substrMail(correo) {
			if (correo.indexOf("-") === -1) return correo;

			return correo.substring(0, correo.indexOf("-") - 1)
		}

		function dirigido(id, tipo_depe) {
			var list = $$("precargado").getList(); 
			list.clearAll()
			$$("precargado").setValue();
			$$("cmbPers").setValue();
			$$("txtCorr_ofic").setValue();
			$$("txtDiri_carg").setValue()
			$$("copias").setValue()
			
			webix.ajax().post("/<% // Response.write(config.ruta)%>/op_noficx.fwx", {txtTipo:tipo_depe, centro:id, tipo_depe:tipo_depe}).then((res)=>{
				res = res.json();
				if(res.status){
					if (tipo_depe == 9){
						list.add({id:"0", value:""})
						// list.parse(res.personas)
						res.personas.forEach((element, index)=>{
							list.add(element);
							if(element["titular"] == 1 || res.personas.length == 1){
								$$("precargado").setValue(element["id"])
							}
						})
					}else{

						// nombre, cargo, usuario, corr_ofic
						$$("cmbPers").setValue(res.personas[0].nombre);
						$$("txtCorr_ofic").setValue(res.personas[0].corr_ofic);
						$$("txtDiri_carg").setValue(res.personas[0].cargo)
					}
					// $$("nombre:suggestList").getList().data = res.personas;
					// $$("nombre:suggestList").getList().refresh();
					// console.log($$("nombre:suggestList").getList().data )
					// $$("nombre:suggestList").getList().show()
				}
			})
			return 
			// $$("txtCorr_ofic").enable();
			// var lnDepen = id;

			// if (lnDepen != null && lnDepen != "" && lnDepen != undefined) {

			// 	loader = dhx4.ajax.postSync('/<% // Response.Write(config.ruta)%>/op_noficx.fwx', 'cmbCentro=' + lnDepen);
			// 	var result1 = loader.xmlDoc.responseXML.getElementsByTagName("mensaje");
			// 	var result2 = loader.xmlDoc.responseXML.getElementsByTagName("error");
			// 	var result3 = loader.xmlDoc.responseXML.getElementsByTagName("codigo");
			// 	var result4 = loader.xmlDoc.responseXML.getElementsByTagName("nombre");
			// 	var result5 = loader.xmlDoc.responseXML.getElementsByTagName("cargo");
			// 	var result6 = loader.xmlDoc.responseXML.getElementsByTagName("correo");
			// 	var result7 = loader.xmlDoc.responseXML.getElementsByTagName("correo_copia");
			// 	var correo_copia = result7[0].firstChild.nodeValue.trim();

			// 	if (lnDepen == 4 || lnDepen == 5 || lnDepen == 874) {
			// 		$$("txtCorr_ofic").setValue('dg_oficialia@hcg.gob.mx')
			// 		$$("txtCorr_ofic").disable();
			// 	}

			// 	if (result2[0].firstChild.nodeValue != ".T.") {

			// 		//$$("cmbPers").getList().clearAll()
			// 		//$$("cmbPers").getList().parse('{"id":"' + result3[0].firstChild.nodeValue + '", "value": "' + result4[0].firstChild.nodeValue + '"}');
			// 		$$("cmbPers").setValue(result4[0].firstChild.nodeValue)

			// 		$$("cmbPers").define({"suggest":[{id:"sadsdadsa", value:"sasaddsaasd"}]})
			// 		$$("cmbPers").refresh()
			// 		//$$("txtCorr_ofic").getList().clearAll()
			// 		//$$("txtCorr_ofic").getList().parse('{"id":"' + result6[0].firstChild.nodeValue + '", "value": "' + result6[0].firstChild.nodeValue + '"}');
			// 		if (lnDepen != 4 && lnDepen != 5 && lnDepen != 874 && result6[0].firstChild.nodeValue != "jegonzalez@hcg.gob.mx") {
			// 			$$("txtCorr_ofic").setValue(result6[0].firstChild.nodeValue)
			// 		}

			// 		$$("txtDiri_carg").setValue(result5[0].firstChild.nodeValue)

			// 		if (correo_copia != "") {
			// 			$$("lblCopia").show();
			// 			$$("lblCopia2").show();
			// 			$$("lblCopia2").define("label", "<strong>" + correo_copia + " </strong>");
			// 			$$("lblCopia2").render();
			// 		} else {
			// 			if ($$("lblCopia").isVisible()){
			// 				$$("lblCopia").hide()
			// 				$$("lblCopia2").hide()
			// 			}
			// 		}
			// 	}

			// }
		}

		function countDirigido() {
			return $$("dtable").find(function (obj) { return obj.tipo == 1; });
		}
	</script>
</body>


</html>