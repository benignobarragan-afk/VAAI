<%- include('partials/header'); %>

	<style>
	/* Forzamos el color de fondo de cada botón */
		.tema_azul_btn button { background-color: #497aac !important; border-radius: 4px; }
		.tema_claro_btn button { background-color: #EBEDF0 !important; border-radius: 4px; }
		.tema_gris_btn button { background-color: #3c3c3e !important; border-radius: 4px; }
		.tema_gold_btn button { background-color: #b58a3b !important; border-radius: 4px; }
		

		/* Ponemos el círculo (icono) en blanco para que contraste */
		.tema_azul_btn .webix_icon, 
		.tema_verde_btn .webix_icon, 
		.tema_gris_btn .webix_icon, 
		.tema_naranja_btn .webix_icon { 
			color: white !important; 
		}

		/* Quitamos sombras y bordes extraños de Webix */
		.tema_azul_btn button, .tema_verde_btn button, .tema_gris_btn button, .tema_naranja_btn button {
			border: none !important;
			box-shadow: none !important;
		}

		html,
		body {
			width: 100%;
			height: 100%;
			margin: 0px;
			padding: 0px;
			overflow: hidden;
		}

		.mainphoto {
			border-radius: 25px;
			width: 42px;
			height: 42px;
			cursor: pointer;
		}

		.mainnoti {
			border-radius: 25px;
			width: 42px;
			height: 42px;
			cursor: pointer;
		}

		.mainphoto:hover {
			opacity: 0.8;
		}

		.noVisto{

			background-color:#DFF4FF;
		}

		.tooltip::after {
			background: rgba(0, 0, 0, 0.8);
			border-radius: 0px 8px 8px 8px;
			box-shadow: 1px 1px 10px rgba(0, 0, 0, 0.5);
			color: #FFF;
			content: attr(data-tooltip);
			margin-top: 24px;
			opacity: 0;
			padding: 3px 7px;
			position: absolute;
			visibility: hidden;

			transition: all 0.4s ease-in-out;
		}

		.tooltip:hover::after {
			opacity: 1;
			visibility: visible;
		}

		.cursor:hover {
			cursor: pointer;
			opacity: 0.8;
		}

		.titu_noti{
			font-weight: bold;
			color: #16819a;
		}

		.text_mensaje{
			margin-top: 4px;
    	margin-bottom: 0px !important;
		}

		.miclase.webix_icon {
			font-size:55px;
		}

	</style> 

</head>

<body">
	<form id="form1" name="form1" method="post" action="">
		<div id="principal" style="position: relative; border: #B5CDE4 1px solid;"></div>
		<script>
			var xx = 1;
			var estilo = 1;

			let preguntar_cambio = false;
			let selected = '';



			webix.ready(function () {
				var popup = webix.ui({
					view: "popup",
					id: "config_menu",
					body: {
						view: "form", width: 200,
						borderless: true,
						rows: [
							{
								preguntar:false,view: "label", label: "Usuario", css: "cursor", id: "usuarios",
								on: {
									onItemClick: function (id) {
										change_page(id, false);
										$$("config_menu").hide(this.$view);
									}
								}
							},
							{
								view: "label", label: "Nuevo usuario", css: "cursor", id: "usua_nuev",
								on: {		
									onItemClick: function (id) {
										change_page(id, false);
										$$("config_menu").hide(this.$view);						
//										onItemClick: function (id) {
//											Swal.fire({title: "A continuación se te abrirá una ventana nueva, puede que te pida iniciar sesión de nuevo.", icon: 'warning'}).then(()=>{
//												window.open('http://10.2.1.135/usua_nuev.fwx')
//											})
//	
//											return 
//											change_page(id, false);
//											$$("config_menu").hide(this.$view);
									}
								}
								
								// on: {
								// 	onItemClick: function (id) {
								// 		change_page(id, false);
								// 		$$("config_menu").hide(this.$view);
								// 	}
								// }
							},
							/*
							{
								view: "label", label: "Cuenta pasnet", css: "cursor", id: "cuen_pasnet.fwx",
								on: {
									onItemClick: function (id) {
										showWindow(id);
										$$("config_menu").hide(this.$view);
									}
								}
							},
							{
								view: "label", label: "Cuenta Synapse", css: "cursor", id: "cuen_synapse.fwx",
								on: {
									onItemClick: function (id) {
										showWindow(id, "Cuenta Synapse");
										$$("config_menu").hide(this.$view);
									}
								}
							},
							{
								view: "label", label: "Cuenta TS JIM", css: "cursor", id: "cuen_tsjim.fwx",
								on: {
									onItemClick: function (id) {
										showWindow(id, "Cuenta TSJIM");
										$$("config_menu").hide(this.$view);
									}
								}
							},
							{
								view: "label", label: "Cuenta Empleado", css: "cursor", id: "cuen_empl.fwx",
								on: {
									onItemClick: function (id) {
										showWindow(id, "Cuenta Portal Empleado");
										$$("config_menu").hide(this.$view);
									}
								}
							},
							*/
							{
								view: "label", label: "Cambiar password", css: "cursor", id: "prin_ca_pa",
								on: {
									onItemClick: function (id) {
//										Swal.fire({title: "A continuación se te abrirá una ventana nueva, puede que te pida iniciar sesión de nuevo.", icon: 'warning'}).then(()=>{
//											window.open('http://10.2.1.135/prin_ca_pa.fwx')
//										})
//
//										return 
//										change_page(id, false);
//										$$("config_menu").hide(this.$view);
										showWindow(id, "Cuenta Portal Empleado");
										$$("config_menu").hide(this.$view);
									}
								}
							},
							{
								view: "label", label: "Subir foto de perfil", css: "cursor",
								on: {
									onItemClick: function () {
										sube_foto();
										$$("config_menu").hide(this.$view);
									}
								}
							},
							/*
							{
								cols: [
									{ view: "button", type: "icon", width: 45, css: "app_button", icon: "mdi mdi-invert-colors", click: camb_esti },
									{ view: "button", type: "icon", width: 45, css: "app_button", icon: "mdi mdi-invert-colors", click: camb_esti },
									{ view: "button", type: "icon", width: 45, css: "app_button", icon: "mdi mdi-invert-colors", click: camb_esti },
								]
							},

							{
								view: "label", label: "Admin. reportes", css: "cursor", id: "repo_admi.fwx",
								on: {
									onItemClick: function (id) {
										change_page(id, false);
										$$("config_menu").hide(this.$view);
									}
								}
							},
							{
								view: "label", label: "Herramientas", css: "cursor", id: "usua_herr.fwx",
								on: {
									onItemClick: function (id) {
										change_page(id, false);
										$$("config_menu").hide(this.$view);
									}
								}
							},
							*/
							{
								view: "label", label: "Elegir Tema:", css: "menu_seccion_label" 
							},
							{
								cols: [
									{ 
										view: "button", type: "icon", icon: "mdi mdi-format-color-fill", 
										css: "tema_gris_btn", tooltip: "VAAI", 
										click: function(){ cambiar_tema_servidor("0"); } 
									},	
									{ 
										view: "button", type: "icon", icon: "mdi mdi-format-color-fill", 
										css: "tema_azul_btn", tooltip: "Azul", 
										click: function(){ cambiar_tema_servidor("2"); } 
									}, 
/* 									{ 
										view: "button", type: "icon", icon: "mdi mdi-circle", 
										css: "tema_naranja_btn", tooltip: "Material", 
										click: function(){ cambiar_tema_servidor("material.css"); } 
									} */
								]
							},
							{
								cols: [
									{ 
										view: "button", type: "icon", icon: "mdi mdi-format-color-fill", 
										css: "tema_claro_btn", tooltip: "Claro", 
										click: function(){ cambiar_tema_servidor("3"); } 
									},
									{ 
										view: "button", type: "icon", icon: "mdi mdi-format-color-fill", 
										css: "tema_gold_btn", tooltip: "Dorado", 
										click: function(){ cambiar_tema_servidor("4"); } 
									},	
								]
							},
							{
								view: "label", label: "Cerrar sesi&oacute;n", css: "cursor", id: "cerr_sesi.fwx",
								on: {
									onItemClick: function () {
										cerrarSesion();
										$$("config_menu").hide(this.$view);
									}
								}
							},
						]
					}
				});
				webix.Touch.enable();

				if (!webix.env.touch && webix.env.scrollSize)
					webix.CustomScroll.init();


				webix.type(webix.ui.tree, {
					baseType: "sideBar",			// inherit everything else from sidebar type
					name: "customIcons",
					icon: function (obj, common) {	// custom rendering pattern for icons
						if (obj.icon)
							return "<img width='24' height='24' src='/imagenes/boton/" + obj.icon + "'></span>";
						return "";
					}
				});

				
				webix.ui({
					rows: [
						{
							id: "prueba2",
							template: "<a id='prueba' onclick='window.open(\"http://logout@10.2.1.135/desarrollo/\")'></a>",
							hidden:true
						},
						{
							view: "toolbar", padding: 3, height: 56, 
							css: "webix_dark",
							elements: [
							{
								id: "menu:button",
								view: "button",
								type: "icon",
								icon: "mdi mdi-wrap-disabled",
								autowidth: true,
								align: "left",
								css: "app_button",
								click: function () {

									if ($$("sidebar").config.collapsed)
										$$("menu:button").config.icon = "mdi mdi-wrap";
									else
										$$("menu:button").config.icon = "mdi mdi-wrap-disabled";

									$$("menu:button").refresh();
									$$("sidebar").toggle()
								}
							},
								{ view: "label", label: "Usuario: <%=lcNombre%> / SIVA (Sistema Integral de la Vicerrectoría Académica)" },
								//{ view: "button", id: "cmbComent", type: "icon", width: 45, css: "app_button", icon: "mdi mdi-invert-colors", click: camb_esti },
								/*
								
								*/
								{
									view:"button", type:"icon",
									icon:"mdi mdi-bell-ring",
									tooltip:"Notificaciones",
									id:"btnNotifica",
									width:45,
									on:{
										onItemClick:(id,e)=>{
											notificacion(e)
										}
									},
								},
								{
									view:"button", type:"icon",
									icon:"mdi mdi-video",
									tooltip:"Videotutoriales",
									click:function(){
										$$("frame-body").load("/tutoriales.fwx");
									}, width:45
								},
								{
									view:"button", type:"icon",
									icon:"mdi mdi-barcode-scan",
									tooltip:"Recepcion de documentos mediante codigo de barras",
									click:function(){
										$$("frame-body").load("/rece_docu.fwx");
									}, width:45
								},
								//{
								//	view:"button", type:"icon", icon:"mdi mdi-bell-ring", click:function(){notificacion();}, width:45
								//},
								{
									template: '<img id="imagen" class="mainphoto" src="/imagenes/boton/anonimo.png">',
									width: 60, popup: popup, borderless: true, batch: "default", id: "avatar",
									onClick: {
										"mainphoto": function (ev, id) {
											if (!$$("config_menu").isVisible())
												$$("config_menu").show(this.$view);
											else
												$$("config_menu").hide(this.$view);
										}
									}
								},
							]
						},
						{
							cols: [
								{
									view: "sidebar",
									id: "sidebar",
									scroll: "y",
									collapsed: true,
									tooltip:true,
									css: "webix_dark",
									//type: "customIcons",
									//data: menu_data,
									url: "/api/gene_menu",
									// tooltip: function (obj) {
									// 	return obj.value;
									// },
									on: {
										onAfterSelect: function (id) {
											change_page(id);
										},
										// onMouseMove:()=>{
										// 	$$("sidebar").getPopup().hide();
										// },
										"onMouseOut":function(){
											if(this.config.collapsed){
												setTimeout(function(){
													$$("sidebar").getPopup().hide();
												}, 2800);
											}
										},
									}
								},
								{									
									view: "iframe",
									id: "frame-body",
								}
							]
						}
					]

				});
				
				
				

			$$("frame-body").load("principal");


			webix.ui({
			  view:"popup",
			  id:"popupNoti",
			  height:1,
			  width:400, hidden:true,
			  body:{
			  	rows:[{
			  		view:"toolbar", id:"tbNotifica",borderless:true, 
			  		cols:[{
			  			view:"label", label:"Notificaciones"
			  		},{

			  		},{
			  			view:"button", type:"icon", icon:"mdi mdi-message-text", tooltip:"Mostrar mas resultados", width:40, click:()=>{verTodoNoti()}

			  		},{
			  			view:"button", type:"icon", icon:"mdi mdi-message-cog", tooltip:"Configurar notificaciones", width:40, click:()=>{menuNoti()}
			  		}]
			  	},{
			  		view:"dataview",  xCount:1, select:true,
				    id:"myDV_noti",
				    type: {
				    	height: 135,
				    	width:400, 
				    },
				    template:(obj)=>{
				    	return '<table>'+
								'	<tr >'+
								'		<td style="width: 55px;">'+
								'    <span class="webix_icon '+obj.img+' miclase" style="width:55px; height:55px"></span>'+
								'		</td>'+
								'		<td>'+
								'			<p class="titu_noti text_mensaje">' + obj.titulo + '</p>'+
								'			<p class="text_mensaje"><b>' + obj.mensaje + '</b></p>'+
								'			<p class="timeAgo text_mensaje">Hace '+ timeAgo(obj.fecha, obj.hora)+'</p>'+
								'		</td>'+
								'		<td style="width:30px; top:30px" align="right">'+
								'			' + (obj.visto == 0?'<div style="width:12px;height:12px; border-radius:10px; background-color:green"></div>':'')+
								'		</td>'+
								'	</tr>'+
								'</table>'
				    },
				    data:[],
				    on:{
				    	"onItemClick":(id, e, node)=>{
				    		cargaVista(id);
				    		$$("popupNoti").hide();
				    	},

				    }
			  	}]
			  },
			  on:{
			  	onShow:()=>{
			  		$$("myDV_noti").clearAll();
			  		$$("myDV_noti").load("/otificax.fwx");
			  	}
			  }
			})

		$$("myDV_noti").attachEvent("onAfterLoad", function () { 
			var count = $$("myDV_noti").count();
			if(count == 0){
				count = 1;
			}else if(count > 5){
				count = 5
			}
			$$("popupNoti").define("height", count * 110 + 40);
			
			$$("popupNoti").resize();
		});

//		buscaNoti();


		setInterval(()=>{
//			buscaNoti();
		},5*60*1000)

		var popup = $$("sidebar").getPopup();
				popup.attachEvent("onBeforeShow", function () { return false });
	});

// '			<img style="width: 55px; height: 55px;" src="/imagenes/boton/anonimo.png">'+

	function menuNoti(){
		change_page(`/notificac.fwx`, false);

		$$("popupNoti").hide();
	}

	function verTodoNoti(){
		change_page(`/notificat.fwx`, false);
		$$("popupNoti").hide();
	}

 	
 	function cargaVista(id){
 		var item = $$("myDV_noti").getItem(id);
 		if(item.visto == 0 ){
 			webix.ajax().post("/notificax2.fwx", {id:id}).then((res)=>{
 				res = res.json();
 				if(res.status){
 					cambiaItem(id, 1)
 				}
 			});
 		}

 		change_page(`/${item.pagina}.fwx?seccion=${item.seccion}&id=${item.id_documento}`, false);
 		//$$("frame-body").load();
 	}

 	function cambiaItem(id, visto){
 		var item = $$("myDV_noti").getItem(id);
 		item.visto = 1
 		$$("myDV_noti").removeCss(id, 'noVisto');
 		$$("myDV_noti").updateItem(id, item);
 	}


 	function cambiaNoti(cambiar, mensajes){
 		if(cambiar){
 			$$("btnNotifica").config.badge = mensajes;
 		}else{
 			delete $$("btnNotifica").config.badge;
 		}
 		$$("btnNotifica").refresh();
 	}
	
	function notificacion(event){
		webix.ajax().post("/notificax2.fwx",{t:2}).then((res)=>{
			res = res.json();
			if(res.status){
				cambiaNoti(false);
			}
		})
		// $$("popupNoti").define({
		// 	top:event.clientY,
		// 	left:event.clientX - 400
		// });
		if(!$$("popupNoti").isVisible()){
			$$("popupNoti").show($$("btnNotifica").$view);
			// $$("popupNoti").show();
		}else{
			$$("popupNoti").hide();
		}
	}

	function buscaNoti(){
		webix.ajax().post("/notificax.fwx?", {t:2}).then((res)=>{
			res = res.json();
			cambiaNoti(res.status,  res.mensajes)
		})
	}

	function timeAgo(fecha, hora) {
		var date = new Date(fecha.substring(6,10),Number(fecha.substring(3,5))-1,fecha.substring(0,2), hora.substr(0,2), hora.substr(3,2), hora.substr(6,2))


	  var seconds = Math.floor((new Date() - date) / 1000);

	  var interval = seconds / 31536000;

	  if (interval > 1) {
	    return Math.floor(interval) + " a�os";
	  }
	  interval = seconds / 2592000;
	  if (interval > 1) {
	    return Math.floor(interval) + " meses";
	  }
	  interval = seconds / 86400;
	  if (interval > 1) {
	    return Math.floor(interval) + " d&iacute;as";
	  }
	  interval = seconds / 3600;
	  if (interval > 1) {
	    return Math.floor(interval) + " horas";
	  }
	  interval = seconds / 60;
	  if (interval > 1) {
	    return Math.floor(interval) + " minutos";
	  }
	  return Math.floor(seconds) + " segundos";
	}

			function sube_foto() {
				
				webix.ui({
					view: "window", id: "sube_foto",
					move: true, left: 150, top: 10, width: Math.min(600, screen.width - 250), height: Math.min(200, screen.height - 250), resize: true,
					head: {
						view: "toolbar", id: "toolbar4",
						cols: [
							{ view: "label", label: "Subir foto de perfil" },
							{ view: "icon", icon: 'mdi mdi-close', click: "$$('sube_foto').close();" }
						]
					},
					body: {
						view: "iframe",
						src: "/foto_perfil.fwx"
					}
				}).show();
			}

			function change_page(id, sidebar = true) {
				$$('sidebar').unselect(id);
				if(sidebar){
					if(preguntar_cambio){
						Swal.fire({
						 	title: "&iquest;Seguro de cambiar de apartado?", icon: 'warning', showCancelButton: true,
						  confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Si', cancelButtonText:"No",
						  // input:"text", 
						  html:
						    '<label style="display:"inline-block" for="swal-input1">No volver a mostrar: <input id="swal-input1" type="checkbox" value="0" class="swal2-checkbox"></label>',
						  focusConfirm: false,
						  preConfirm: () => {
						    return [
						      document.getElementById('swal-input1').checked?1:0,
						    ]
						  }

						}).then((result) => {
							// webix.storage.local.put(selected, grid.getState());
							if(result.isConfirmed){
								preguntar_cambio = $$("sidebar").getItem(id).preguntar
								let item = $$("sidebar").getItem(selected)
								item.preguntar = !(result.value[0] == 1)
								$$("sidebar").updateItem(selected, item)
								
								if (id == "salir")
									window.location.href = "/logout";
								else
									if (id.substr(0,5) == "Qlik:")
										$$("frame-body").load("https://10.2.1.170/single/?appid=" + id.substr(5));
										// $$("frame-body").load("https://10.2.1.170/hub/");
									else if(id == 'op_cucs'){
										$$("frame-body").load('/'+id);
										// oficialia.hcg.gob.mx
									} else
										$$("frame-body").load(id);
								selected = id;
							}
						})
					}else{
						selected = id;
						preguntar_cambio = $$("sidebar").getItem(id).preguntar
						if (id == "salir")
							window.location.href = "/logout";
						else
							if (id.substr(0,5) == "Qlik:")
														//$$("frame-body").load("https://10.2.1.170/single/?appid=" + id.substr(5));
								$$("frame-body").load("https://10.2.1.170/hub/");
							else if(id == 'op_cucs'){
								$$("frame-body").load('/op_cucs');
								// oficialia.hcg.gob.mx
							} else
								$$("frame-body").load(id);
					}
				}else
					$$("frame-body").load(id);
					

				// if($$("sidebar").getItem("finanzas_old.fwx").preguntar){

				// }

			}

			function camb_esti(id) {

				estilo = (estilo == 3) ? 1 : estilo + 1;
				if (estilo == 1) {
					webix.html.removeCss($$("$sidebar1").getNode(), 'webix_dark')
					webix.html.removeCss($$("$toolbar1").getNode(), 'webix_dark')
				}
				else if (estilo == 2) {
					$$("sidebar").define("css", "webix_dark");
					$$("$toolbar1").define("css", "webix_dark");

				} else {
					webix.html.removeCss($$("sidebar").getNode(), 'webix_dark');
					$$("$toolbar1").define("css", "webix_dark");
				}
			}


			function showWindow(pagina, nombreHeader) {
                    
                    xx++;
                    var window = webix.ui({
                        view: "window",
                        id: "my_win" + xx,
						left: 150,
                        top: 20,
                        width: 920,
                        height: 450,
                        head: {
                            view: "toolbar", id: "toolbar" + xx,
                            cols: [
                                { view: "label", label: nombreHeader, align: 'center' },
                                { view: "icon", icon: 'mdi mdi-close', click: "$$('my_win" + xx + "').close();" }
                            ]
                        },
                        close: true, 
                        body: {
                            view: "iframe",
                            id: "frame-body" + xx,
                            src: "/" + pagina + "?winId=my_win" + xx
                        }
                    }).show();
                }

			function cerrarSesion() {
				location.href = "logout"
			}

			function cambiar_tema_servidor(tema) {
				webix.ajax().post("api/camb_skin", {tema}).then(function(res) {
					webix.message("Cambiando estilo...");
					location.reload(); // Recarga para que EJS aplique el cambio en el <link>
				});
			}
		</script>

		<!-- '<table>'+
		'	<tr>'+
		'		<td style="width: 55px;">'+
		'			<img style="width: 55px; height: 55px;" src="/imagenes/boton/anonimo.png">'+
		'		</td>'+
		'		<td>'+
		'			<p>' + obj.titulo + '</p>'+
		'			<p>' + obj.mensaje + '</p>'+
		'		</td>'+
		'	</tr>'+
		'</table>'+
 -->
		<!-- '<div>'+
		'	<div style="display: inline-block;">'+
		'		<img style="width: 55px; height: 55px;" src="/imagenes/boton/anonimo.png">'+
		'	</div>'+
		'	<div style="display: inline-block;">'+
		'		<p>' + obj.titulo + '</p>'+
		'		<p>' + obj.mensaje + '</p>'+
		'	</div>'+
		'</div>'
		 -->
	</form>
	</body>

</html>