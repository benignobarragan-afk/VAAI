<%- include('../partials/header'); %>

<style>
  /* Clase base para los círculos */
  .tree_badge {
    border-radius: 12px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    color: white;
    margin-left: 5px;
    min-width: 18px;
    display: inline-block;
    text-align: center;
  }
  .bg_azul { background: #2a8dff; }
  .bg_rojo { background: #f34a4a; }
</style>

<script>
webix.ready(function(){
webix.ui({  
    view:"accordion",
    multi:true, // Permite tener varios paneles abiertos o cerrados
    cols:[
    { 
        header:"Menu Oficialía", 
        width:300,
        // El body debe ser un objeto directo, no un array []
        body:{
        rows:[
            {
            view:"toolbar", height:66,
            cols:[
                { view:"button", type:"iconTop", icon:"mdi mdi-file-document-arrow-right-outline", label:"Ofic. sal.", click: function() {
					cargarPagina('2a');
					var header = $$("columna_principal"); 

					if (header) {
						header.setHTML("Oficialía: Nuevo oficio");
					}
				} },
                { view:"button", type:"iconTop", icon:"mdi mdi-inbox-arrow-down-outline", label:"Ofic ent.", click: function() {
					cargarPagina('3a');
					var header = $$("columna_principal"); 

					if (header) {
						header.setHTML("Oficialía: Ingresar documento");
					}
				} },
                { view:"button", type:"iconTop", icon:"mdi mdi-account-cog-outline", label:"Administrar", click: function() {
					cargarPagina('5a');
					var header = $$("columna_principal"); 

					if (header) {
						header.setHTML("Oficialía: Administra las oficialias");
					}
				} },
            ]
            },
            {
			view:"toolbar", height:66,
            cols:[
                { view:"button", type:"iconTop", icon:"mdi mdi-text-box-search-outline", label:"Buscar sal.", click: function() {
					cargarPagina('4a');
					var header = $$("columna_principal"); 

					if (header) {
						header.setHTML("Oficialía: Buscar oficios salida");
					}
				} },
                { view:"button", type:"iconTop", icon:"mdi mdi-clipboard-text-search-outline", label:"Buscar ent.", click: function() {
					cargarPagina('4c');
					var header = $$("columna_principal"); 

					if (header) {
						header.setHTML("Oficialía: Buscar oficios entrada");
					}
				} },
                { view:"button", type:"iconTop", icon:"mdi mdi-video", label:"Videos", click: function() {
					cargarPagina('5b');
					var header = $$("columna_principal"); 

					if (header) {
						header.setHTML("Oficialía: Videos tutoriales");
					}
				} },
			]
            },
            {
            // Aquí podrías agregar el Tree que teníamos antes
            view:"tree",
            id: "myTree",
            //width:300,
            type: {
                template: function(obj, common) {
                // 1. Iconos de control (+/-) e icono de la rama
                let html = common.icon(obj, common);
                
                if (obj.icon) {
                    html += "<span class='webix_icon " + obj.icon + "' style='color:#2b96cc; margin-right:5px;'></span>";
                } else {
                    html += "<span class='webix_icon fas fa-folder' style='color:#f1c40f; margin-right:5px;'></span>";
                }

                // 2. Lógica de Colores: Rojo si > 0, Azul si es 0
                if (obj.cant !== undefined) {
                    let colorCant = (parseInt(obj.cant) > 0) ? "bg_rojo" : "bg_azul";
                    html += `<span class="tree_badge ${colorCant}">${obj.cant}</span>`;
                }

                if (obj.modi !== undefined) {
                    let colorModi = (parseInt(obj.modi) > 0) ? "bg_rojo" : "bg_azul";
                    html += `<span class="tree_badge ${colorModi}">${obj.modi}</span>`;
                }

                // 3. Texto del nodo
                html += "<span style='margin-left:3px; vertical-align:middle;'>" + obj.value + "</span>";

                return html;
                }
            },
            data: [
				//{ id: "1", value: "Oficialía de partes", icon: "mdi mdi-book-open-outline", open: true, data: [
                    { id: "2", value: "Oficialía de salida", icon:"mdi mdi-file-document-arrow-right-outline", open: true, data: [
                        { id: "2a", icon:"mdi mdi-plus-circle-outline", value: "Nuevo oficio" },
                        { id: "2b", icon:"mdi mdi-history", value: "Histórico de oficio" },
                        { id: "2c", icon:"mdi mdi-account-multiple", value: "Gurpos" },
                        { id: "2d", value: "Pendientes de enviar", icon:"mdi mdi-send-clock-outline", open: true, data: [
                        <%for(i=0; i<rows.length; i++){%>
                            { id: "<%=rows[i].cve%>", icon:"mdi mdi-home-city-outline", value: "(<%=rows[i].cve%>) <%=rows[i].descrip%>", cant:<%=rows[i].cant%>, modi:<%=rows[i].modificado%>},
                        <%}%>
						]},
                    ]},
					{ id: "3", icon:"mdi mdi-inbox-arrow-down-outline", value: "Oficialía de entrada", open: true, data:[
                        { id: "3a", icon:"mdi mdi-location-enter", value: "Ingresar documento" },
                        { id: "3b", icon:"mdi mdi-content-cut", value: "Corte de entrega" },
                        { id: "3c", icon:"mdi mdi-clipboard-account-outline", value: "Oficios asignados" },
					]},
					{ id: "4", icon:"mdi mdi-inbox-arrow-down-outline", value: "Reportes", open: true, data:[
                        { id: "4a", icon:"mdi mdi-text-box-search-outline", value: "Buscar oficios salida" },
                        { id: "4b", icon:"mdi mdi-hand-back-left-outline", value: "Oficios Solicitados" },
                        { id: "4c", icon:"mdi mdi-clipboard-text-search-outline", value: "Buscar oficios entrada" },
                        { id: "4d", icon:"mdi mdi-chart-bar", value: "Estadísticos" },
					]}
				//]}
            ],
            on: {
                onItemClick: function(id) {
                        
                    var item = this.getItem(id);
                    // Verificamos que no sea una "carpeta" madre sin ruta
                    if (this.getItem(id).$count) {
                        this.open(id); // Si tiene hijos, solo lo abrimos
                    } else {
                        //console.log(item.value)
                        cargarPagina(id); // Si es un nodo final, cargamos la página

                        // Localiza el componente por su ID (asegúrate de que el header tenga este ID)
						var header = $$("columna_principal"); 

						if (header) {
							header.setHTML("Oficialía: " + item.value);
						}
                    }
                }}
            }
		]
        }
    },
      { view:"resizer" }, // Opcional: para ajustar el ancho manualmente
    {
		// Esta parte es un layout normal, NO tiene flechas de cierre
		rows: [
			{ 
				view: "template", 
				template: "Oficialía de partes", 
				type: "header",
				id: "columna_principal", // Usaremos este ID para cambiar el título
			},
			{ 
				view: "iframe", 
				id: "frame_principal", 
				src: "/op/op_ofic" 
			}
		]
	}
    ]
});
<%if(lnOficio>0){%>
deta_ingr(<%=lnOficio%>);
<%}%>

});

// Mapa de navegación
const rutasSistema = {
    "2a": "/op/op_nofic",
    "2b": "/op/op_hofic",
    "2c": "/op/op_grup?t=2",
    "3a": "/op/op_ningr",
    "3b": "/op/op_cort",
    "3c": "/op/op_aingr",
    "4a": "/op/op_reof0",
    "4b": "/op/op_reof2",
    "4c": "/op/busc_ofic",
    "4d": "/op/op_rgraf",
    "5a": "/op/op_admi",
    "5b": "/op/op_vide",
    "default": "/op/op_pend?lcCVE="   // Página inicial
};

let xx = 0;


function cargarPagina(id) {
    // 1. Buscamos la URL en nuestro mapa
    let url = rutasSistema[id] || rutasSistema["default"] + (/^\d/.test(id)?'':id);
    
    //console.log(url + (/^\d/.test(id)?'':id))
    if ($$("frame_principal")) {
        $$("frame_principal").load(url);
    }
}

function deta_ingr(oficio, asignado = 0) {	
		xx++;
		webix.ui({
			view: "window", id: "w3" + xx,
			move: true, left: 0, top: 0, width: 1000, height: 550, resize: true, fullscreen:true,
			head: {
				view: "toolbar", id: "toolbar3" + xx,
				cols: [
					{ view: "label", label: "Detalle del oficio" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
						var ventana = $$('w3' + xx)
						ventana.config.move = !ventana.config.move
						ventana.config.fullscreen = !ventana.config.fullscreen;
						ventana.setPosition(0,0)
						ventana.resize();
					} },
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('w3" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: "/op/op_detalle?xx=" + xx + "&lnOficio=" + oficio + "&lnAsignado=" + asignado
			},
		}).show();
	}
	function deta_sali(cve, oficio, anio, id_iden, padre) {
		xx++;
		webix.ui({
			view: "window", id: "w4" + xx,
			move: false, left: 0, top: 0, width: 1000, height: 600, resize: true, fullscreen:true,
			head: {
				view: "toolbar", id: "toolbar4" + xx, css: "mi_toolbar_color",
				cols: [
					{ view: "label", label: "Detalle del oficio" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
						var ventana = $$('w4' + xx)
						ventana.config.move = !ventana.config.move
						ventana.config.fullscreen = !ventana.config.fullscreen;
						ventana.setPosition(0,0)
						ventana.resize();
					} },
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('w4" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: "/op/op_sofic?lcCVE=" + cve + "&lnOfic=" + oficio + "&lnAnio=" + anio + "&lnIden=" + id_iden + "&pd=" + padre
			}
		}).show();
	}
	function deta_libr(libro) {
		xx++;
		webix.ui({
			view: "window", id: "w5" + xx,
			move: true, left: 150, top: 0, width: 1250, height: 650, resize: true,
			head: {
				view: "toolbar", id: "toolbar5" + xx,
				cols: [
					{ view: "label", label: "Detalle del libro" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
						var ventana = $$('w5' + xx)
						ventana.config.move = !ventana.config.move
						ventana.config.fullscreen = !ventana.config.fullscreen;
						ventana.setPosition(0,0)
						ventana.resize();
					} },
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('w5" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: "/op_dlibr.fwx?lnLibro=" + libro
			}
		}).show();
	}

	function nuev_cont(lcID) {
		xx++;
		var w6 = webix.ui({
			view: "window", id: "w6" + xx,
			move: true, left: 150, top: 0, width: 1250, height: 650, resize: true,
			head: {
				view: "toolbar", id: "toolbar6" + xx,
				cols: [
					{ view: "label", label: (lcID != 0) ? "Modifica Registro" : "Nuevo Registro" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
						var ventana = $$('w6' + xx)
						ventana.config.move = !ventana.config.move
						ventana.config.fullscreen = !ventana.config.fullscreen;
						ventana.setPosition(0,0)
						ventana.resize();
					} },
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('w6" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: '/rect_llam.fwx?lnVisi=' + lcID
			}
		}).show();
	}

	function mues_grupo(cent) {
		xx++;
		webix.ui({
			view: "window", id: "mues_grup" + xx,
			move: true, left: 150, top: 0, width: 1250, height: 650, resize: true,
			head: {
				view: "toolbar", id: "grupo" + xx,
				cols: [
					{ view: "label", label: "Detalle del libro" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
							var ventana = $$('mues_grup' + xx)
							ventana.config.move = !ventana.config.move
							ventana.config.fullscreen = !ventana.config.fullscreen;
							ventana.setPosition(0,0)
							ventana.resize();
						} },
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('w5" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: "/op_dlibr.fwx?lnLibro=" + libro
			}
		}).show();
	}

	function deta_ofic(cve) {
		xx++;
		webix.ui({
			view: "window", id: "op_admi" + xx,
			move: true, left: 150, top: 0, width: 800, height: 600, 
			head: {
				view: "toolbar", id: "admi" + xx,
				cols: [
					{ view: "label", label: "Detalle de la oficialia" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
						var ventana = $$('op_admi' + xx)
						ventana.config.move = !ventana.config.move
						ventana.config.fullscreen = !ventana.config.fullscreen;
						ventana.setPosition(0,0)
						ventana.resize();
						} 
					},
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('op_admi" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: "/op_nadmi.fwx?lcID=" + cve
			}
		}).show();
	}

	function nuev_llam(id) {
		xx++;
		var w7 = webix.ui({
			view: "window", id: "w7" + xx,
			move: true, left: 80, top: 0, width: 1250, height: 650, resize: true,
			head: {
				view: "toolbar", id: "toolbar7" ,
				cols: [
					{ view: "label", label: (id != 0 && id != undefined) ? "Modifica Registro" : "Nuevo Registro" },
					{ view: "icon", icon: 'mdi mdi-fullscreen', click:() => {
						
						var ventana = $$('w7' + xx)
						ventana.config.move = !ventana.config.move
						ventana.config.fullscreen = !ventana.config.fullscreen;
						ventana.setPosition(0,0)
						ventana.resize();
					} },
					{ view: "icon", icon: 'mdi mdi-close', click: "$$('w7" + xx + "').close();" }
				]
			},
			body: {
				view: "iframe",
				src: "/rect_adire.fwx?lnDire=" + id
			}
		}).show();

	}

	function cierra_ventana(id) {
		$$("toolbar" + id).getParentView().close()

	}


	function mues_noti() {

		webix.ajax()
			.post('/op_notix.fwx', { clave: '<%// Response.Write(pnId_cent)%>' })
			.then(function (result) {

				if (result.json().status == 'server') {
					webix.ui({
						view: "window",
						id: "w1",
						move: true,
						left: 350,
						top: 100,
						width: 800,
						height: 550,
						resize: true,
						head: {
							view: "toolbar",
							cols: [{
								view: "label",
								label: "Vencimientos de folios",
								css: { "color": "#D90416 !important" }
							},
							{ 
								view: "icon", icon: 'mdi mdi-fullscreen', click:()=>{
									var ventana = $$('w1')
									ventana.config.move = !ventana.config.move
									ventana.config.fullscreen = !ventana.config.fullscreen;
									ventana.setPosition(0,0)
									ventana.resize();
								} 
							},
							{
								view: "icon",
								icon: 'mdi mdi-close',
								click: "$$('w1').close();"
							}
							]
						},
						body: {
							view: "iframe",
							id:"ifrm1", 
							src: "/op_noti.fwx"
						}
					}).show();
				}

			});

	}

	function veri_vent() {
		if ($$('w1') != undefined)
			$$('w1').close();
	}
</script>
</body>

</html>