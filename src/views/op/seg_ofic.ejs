<%- include('../partials/header'); %>

	<style type="text/css">
		.dhtmlx-error {
			font-weight: bold;
			color: white;
			background-color: #770000;
		}

		.webix_dtable .webix_ss_header {
			font-weight: bold;
		}

		.edited {
			font-weight: bold;
		}

		.deleted {
			text-decoration: line-through;
		}

		.footer {
			font-weight: bold;
		}

		.highlight-red {
			background-color: #FF8181;
			/*font-weight: bold;*/
			color: white;
		}

		.highlight-red.webix_row_select{
			background: #FF6C6C !important;
			color: white !important;
		}

		.highlight-green {
			background-color: #9BFFA1;
			/*font-weight: bold;*/
			color: black;
		}

		.highlight-light-yellow{
			background-color: #FFFF6E;
			color: black;
		}
	</style>
</head>

<body>
	<script>
		
		
		
		var w1;
		var mygrid;
		var section = [
        {cols: [
		{
			rows: [
			{
				cols: [
				
				{
					view: "text", id: "txtTramite", name: "txtTramite", labelPosition: "top", labelAlign: "left", pattern:{ mask:"##########", allow:/[0-9]/g},
					label: "Tr&aacute;mite", width: 300, inputWidth: 300,
				},
				{ maxWidth: 60 },
				{
					view: "select", label: "Estatus", id: "cmbStatus", name: "cmbStatus", value: 1, width: 160, labelPosition: "top", labelAlign: "left", 
					options: [
					{ id: 1, value: "En proceso" },
					{ id: 8, value: "Aplicado" },
					{ id: 9, value: "Cancelado" },
					]
				},
				]
			},
			{
                view: "textarea", id: "txtNota", name: "txtNota", labelPosition: "top", labelAlign: "left", height: 220, 
                label: "Seguimiento",
			},
			{
                view: "button", id: "save", type: "icon", icon: "mdi mdi-content-save", width: 190, click:()=>{guardar()},
                align: "left", label: "Guardar seguimiento"
			}
			]
		},
        { maxWidth: 30 },
        {
            view: "datatable", id: "dstatus", name: "dstatus", select: "row", editaction: "dblclick", rowCss: "#css#", tooltop: true, 
            footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true, editable: true, 
            columns: [
            { id: "STATUS", header: ["Estatus", { content: "textFilter" }], width: 140, sort: "string", css: { 'text-align': 'left' } },
            { id: "FECHA", editor: "popup", header: ["Fecha", { content: "textFilter" }], width: 140, sort: "string", css: { 'text-align': 'left' } },
            { id: "NOMBRE", editor: "popup", header: ["Usuario", { content: "textFilter" }], width: 240, sort: "string", css: { 'text-align': 'left' } },
			{ id: "ID_TRAM", editor: "popup", header: ["Tr&aacute;mite", { content: "textFilter" }], width: 100, sort: "string", css: { 'text-align': 'left' } },
            { id: "NOTA", editor: "popup", header: ["Seguimiento", { content: "textFilter" }], sort: "string", css: { 'text-align': 'left' }, fillspace:true },
            ],
            url:"/api/op/seg_oficx?lnOficio=<%=lnOficio%>"
		},
        ]}
		]

		webix.ui.datafilter.rowCount = webix.extend({
			refresh: function (master, node, value) {
				node.firstChild.innerHTML = "Total: " + master.count();
			}
		}, webix.ui.datafilter.summColumn)



		webix.proxy.all = {
			$proxy: true,
			saveAll: function (view, updates, dp) {
				webix.ajax().post(this.source, { data: updates })
				.then(function (response) {
					webix.message({ type: "success", text: "Se guardaron los cambios", expire: 4000 })
					dp.reset();
					$$("dtable").clearCss("edited");
					$$("save").disable();
					//genera();
				});
			}
		};


		webix.ready(()=>{
			webix.ui({
				view: "scrollview", id: "verses", scroll: "y",
				body: {
					margin: 20, 
					rows: [
                    { view: "form", id:"frm1", name:"frm1", elements: section },
					{
						view: "datatable", id: "dtable", select: "row", editaction: "dblclick", rowCss: "#css#", tooltop: true,
						footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true, editable: true, minHeight: 450,
						// scheme:{
						// 	$serialize:(obj)=>{
						// 		if(obj.edited == 1 || obj.deleted == 1 || obj.added == 1)
						// 			return obj;
						// 		else
						// 			return false;
						// 	}
						// },
						columns: [
						{ id: "servicio", hidden: true },
						{ id: "nomb_serv", header: ["Servicio", { content: "textFilter" }], width: 240, sort: "string", css: { 'text-align': 'left' } },
						{ id: "diri_nomb", editor: "popup", header: ["Nombre", { content: "textFilter" }], width: 240, sort: "string", css: { 'text-align': 'left' } },
						{ id: "corr_ofic", editor: "popup", header: ["Correo oficial&iacute;a", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' } },
						{ id: "diri_carg", editor: "popup", header: ["Ocupaci&oacute;n", { content: "textFilter" }], width: 200, sort: "string", css: { 'text-align': 'left' } },
						{
							id: "tipo", header: ["Tipo", { content: "selectFilter" }], width: 120,
							options: [
							{ id: 1, value: "Dirigido a" },
							{ id: 2, value: "Con copia" },
							{ id: 3, value: "Autoriza" },
							{ id: 4, value: "Vo. Bo." },
							{ id: 5, value: "Atenci&oacute;n a" }, 
							{ id: 9, value:"Copia automatica"}
							]
						},
						{
							id: "tipo_depe", header: ["Dependencia", { content: "selectFilter" }], width: 100,
							options: [
							{ id: 1, value: "HCG" },
							{ id: 2, value: "Ajena HCG" }
							]
						},
						{ id: "fech_tenvi", header: ["F. Env&iacute;o Autorizaci&oacute;n", { content: "dateFilter" }], width: 170, sort: "date", css: { 'text-align': 'left' } },
						{ id: "fech_auto", header: ["Fecha Autorizado.", { content: "dateFilter" }], width: 150, sort: "date", css: { 'text-align': 'left' } },
						{ id: "fech_senvi", header: ["Fecha Env&iacute;o Acuse", { content: "dateFilter" }], width: 150, sort: "date", css: { 'text-align': 'left' } },
						{ id: "fech_acus", header: ["Fecha Acuse", { content: "dateFilter" }], width: 150, sort: "date", css: { 'text-align': 'left' } },
						{ id: "copias", header: ["Copias automaticas", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' } },
						{ id: "edited", header: ["editado", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' }, hidden:true },
						{ id: "deleted", header: ["eliminado", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' }, hidden:true },
						{ id: "added", header: ["agregado", { content: "textFilter" }], width: 210, sort: "string", css: { 'text-align': 'left' }, hidden:true },
						],
						on: {
							onBeforeLoad: function () { this.showOverlay("Cargando..."); },
							onAfterLoad: function () {
								this.hideOverlay();
								this.adjustRowHeight("nomb_serv", true);
								this.render();
							},
							onAfterEditStop: function (obj, editor) {
								if (obj.value !== obj.old) {
									$$("save").enable();
									this.addRowCss(editor.row, "edited");
									let item = $$("dtable").getItem(editor.row);
									item.edited = 1;
									$$("dtable").updateItem(editor.row, item);
								}
							},
						},
						// save: {
						// 	autoupdate: false, url: "all->/api/op/op_sdoficx2.fwx?lnIden=",
						// }
					},
				{
					height:40,    
					cols: [
					{
						view: "button", type: "icon", icon: "mdi mdi-send", label: "Reenviar oficio", width: 170,
						on: {
							onItemClick: function () { reenvio(1); }
						}
					},
					{
						view: "button", type: "icon", icon: "mdi mdi-send", label: "Enviar para autorizaci&oacute;n", width: 230,
						tooltip: "Enviar oficio para la autorizaciï¿½n o visto bueno del oficio",
						on: {
							onItemClick: function () { reenvio(2); }
						}
					},
					{
						view: "button",
						type: "icon", 
						id: "crearG",
						icon: "mdi mdi-account-group",
						label: "Hacer un grupo",
						width: 150,
						click: function () {
							makegroup();
						}
								},
				

					]
				},
				{
					height:20
				}

				]
				}

			})


			webix.extend($$("verses"), webix.ProgressBar)
			genera();

		})

		function mues_grupo() {
			webix.ui({
				view: "window", id: "mues_grup",
				move: true, left: 150, top: 0, width: 900, height: 550, resize: true,
				head: {
					view: "toolbar", id: "grupo",
					cols: [
						{ view: "label", label: "Grupos" },
						{ view: "icon", icon: 'mdi mdi-close', click: "$$('mues_grup').close();" }
					]
				},
				body: {
					view: "iframe",
					src: "/api/op/op_grup.fwx?t=2"
				}
			}).show();
		}

		
		//Crear un grupo
		function makegroup(){
			
				webix.ui({
						view:"window",
						id:"popupG",
			position: "center",
			width: 400,
						height: 400,
			head:{
							align:"right", view:"button", type:"icon", icon:"mdi mdi-close", width:32, click: "$$('popupG').close();"
						},
			
				body: {
					view: "form",
									id: "form:makegroup",
								
					
								
								rows: [
										{
												view: "text",
												label: "Nombre del grupo",
												name: "name",
						id: "name",
												placeholder: "Nombre del grupo",
												labelPosition: "top",
										},
										{
												cols: [
														{
																view: "button",
																value: "Cancelar",
																click: function () {
																		$$('popupG').hide();
																}
														},
														{
																view: "button",
																value: "Crear grupo",
																click: function () {
																		GenerateGroup($$("name").getValue(), $$("cmbOficio").getValue());
																}
														},
												]
										}
								]

			
						}
				}).show();
		}

		//functions 
		function guardar() {

/*             if (! $$("frm1").validate()) {

				webix.message({ text: "Los campos que se marcan en rojo son obligatorios", type: "error", expire: 3000 })
				return 
			}
 */
			Swal.fire({
				text: '', title: "Estas seguro guardar los cambios realizados?", icon: 'warning', showCancelButton: true,
				confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Si', cancelButtonText:"No",
			}).then((result) => {
				if(result.isConfirmed){
                    let form = $$("frm1").getValues();
					$$("verses").disable();
					$$("verses").showProgress();

					webix.ajax().post("/api/op/seg_oficx2", {lnOficio: <%=lnOficio%>, form}).then((res)=>{
						$$("verses").enable();
						$$("verses").hideProgress();
						res = res.json();
						Swal.fire({title:"", text:res.mensage, icon:(!res.error?"success":"error")}).then(()=>{
							if(!res.error){
								genera();
								if($$("cmbStatus").getValue() > 1){
									$$("save").disable();
								}
							}
						})
					})
				}
			})
		}



				
				function genera() {
						$$("dstatus").clearAll();
						$$("dstatus").load('/api/op/seg_oficx?lnOficio=<%=lnOficio%>')
				}

		</script>
</body>


</html>