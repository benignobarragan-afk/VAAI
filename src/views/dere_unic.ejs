<%- include('partials/header'); %>

<style>
    .mi-boton-azul .webix_button {
        background-color: #0dc8ee !important;
        color: white !important;
        border-radius: 5px;
    }

    /* Opcional: Color al pasar el mouse (hover) */
    .mi-boton-azul .webix_button:hover {
        background-color: #16acce !important;
    }

</style>

<body>
    <script>
        var tip = 0;
        var w1;
        var mygrid;

		const loDere = <%- JSON.stringify(rows) %>


        //alert(tip);

        //function doOnLoad() {
        webix.ready(function(){


            webix.ui.datafilter.rowCount = webix.extend({
                refresh: function (master, node, value) {
                    node.firstChild.innerHTML = "Total: " + master.count();
                }
            }, webix.ui.datafilter.summColumn)


            var ui = webix.ui({
                space: "wide",
                rows: [
                    {
                        view: "datatable", id: "dtable", name: "dtable", select: "row", editaction: "dblclick", rowCss: "#css#", drag:true, 
                        columns: [
                            { id: "id", header: ["ID"], css: { 'text-align': 'center'}, hidden: true },    
                            { id: "marcado", template:"{common.checkbox()}", header: ["Clave"], css: { 'text-align': 'center' }  },
                            { id: "depen", header: ["Dependencia", { content: "textFilter" }], width: 580, sort: "string", css: { 'text-align': 'left' } },
                            { id: "titular", header: ["Titular", { content: "textFilter" }], width: 100, sort: "string", css: { 'text-align': 'left' }, <%=(lcDere!='oficio'?'hidden: true':'') %> },
                        ],
                        footer: true, scrollY: true, scrollX: true, resizeColumn: true, resizeRow: true, navigation: true,
                        editable: true, 
                        data:loDere,
                        on: {
                            onBeforeLoad: function () { this.showOverlay("Cargando..."); },
                            onAfterLoad: function () {
                                this.hideOverlay();
                                //this.adjustRowHeight("nomb_serv", true);
                                this.render();
                            },
                            
                        },
                        onClick: {
                            // Esta función se dispara solo cuando haces clic en la clase CSS que definimos arriba
                            "buscar_detalles": function(ev, id) {
                                var item = this.getItem(id); // Obtenemos el registro completo
                                
                                // Aquí pones la lógica de lo que quieras que haga la lupa
                                webix.message("Buscando detalles de: " + item.MODI_GROU);
                                
                                // Ejemplo: Abrir una ventana o cargar datos en un formulario
                                //abrirVentanaDetalles(item.MODI_GROU);
                                showWindow(item.MODI_GROU, item.DESCRIP);
                                
                                return false; // Evita que se disparen otros eventos de la fila
                            }
                        }
                    },
                    {
				        view: "button", label: "Aplicar derechos", click: guardar, id:"btnGuardar", align: "right", width: 250
			        }
                ]
            });

						webix.ui({
	            view:"contextmenu", id:"cmenu", master:$$("dtable"), width:220,
	            data:[
	              {value:"Eliminar grupo", id:"eliminaGrupo"},
	              
	            ],
	            on:{
	              "onItemClick":function(id){
	                var id_grup = $$("dtable").getSelectedId();
	                if(id === "eliminaGrupo"){
	                	console.log(id_grup)
	                  eliminaGrupo(id_grup.id)
	                }
	                
	              }
	            }
	          });

            //genera();
        });

        


        function guardar() {

            var checked = [];
            $$("dtable").data.each(function (obj) {
                if (obj.marcado == 1) checked.push(obj.id);
            });
            console.log('<%=lcDere%>');
            console.log(checked);

            $$("btnGuardar").disable();

            webix.ajax()
                .post("/api/dere_unicx", {lcDere:'<%=lcDere%>', checked, userSerch:'<%=userSerch%>'})
                .then(function (data) {
                    $$("btnGuardar").enable();
                    let res = data.json();
                    console.log(res);
                    // Usamos SweetAlert para mostrar el resultado
                    Swal.fire({
                        title: res.error ? "Error" : "¡Éxito!",
                        text: res.mensage,
                        icon: res.error ? "error" : "success",
                        confirmButtonColor: "#3085d6",
                        confirmButtonText: "Aceptar"
                    }).then((result) => {
                        // Si todo salió bien y el servidor no marcó error lógico
                        if (!res.error) {
                            window.parent.$$('<%=winId%>').close();
                        }
                    });
                })
                .fail(function (xhr) {
                    // Este bloque maneja errores de red, 404 o 500 del servidor
                    $$("btnGuardar").enable();
                    
                    Swal.fire({
                        title: "Error de servidor",
                        text: "No se pudo conectar con el servidor SIVA. Intente más tarde.",
                        icon: "error"
                    });
                    console.error("Detalle del error:", xhr.status, xhr.statusText);
                });

            /* $$("dtable").remove(checked);
            window.parent.parent.carg_grupo(checked.toString()); */
        }

    </script>
</body>


</html>