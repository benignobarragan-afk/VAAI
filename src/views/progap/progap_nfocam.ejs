<%- include('../partials/header'); %>

<style type="text/css">
		/* Definición del color verde para el texto */
		.archivo-verde a {
			color: #4CAF50 !important; /* Un tono de verde claro y visible */
			font-weight: bold; /* Opcional: para que resalte más */
		}
	</style>

<script>

<%if(usuario.length>0){%>
var datosIniciales = <%- JSON.stringify(usuario) %>;
<%}%>

webix.ready(function(){
    webix.ui({
        view:"form",
        id:"form_registro",
        scroll: "y",
        elementsConfig:{
            labelPosition:"top",
            labelWidth:140,
            bottomPadding: 15
        },
        elements:[
            { view:"template", type:"header", template:"<%=(usuario.length<1?'Añadir Nuevo Registro':'Modificar a: ' + usuario[0].nombre)%>", css:"header_form" },
            
            // Fila: Código y Contraseña
            { cols:[
                { view:"text", name:"id", label:"id", hidden: true },
                { view:"text", name:"codigo", label:"Código de Estudiante *", placeholder:"Código de Estudiante", required:true, invalidMessage:"Requerido" },
                // CURP
                { cols:[
                    {
                        view: "text",
                        id: "curp",
                        name: "curp",
                        label: "CURP *",
                        placeholder: "Escribe tu CURP",
                        required: true,
                        attributes: { maxlength: 18 },
                        // Definimos la validación
                        validate: function(value) {
                            return validarCURP(value);
                        },
                        invalidMessage: "Formato de CURP incorrecto",
                        on: {
                            // Convertir automáticamente a mayúsculas mientras el usuario escribe
                            onTimedKeyPress: function() {
                                var value = this.getValue().toUpperCase();
                                this.setValue(value);

                                if($$("contador")){
                                    $$("contador").setHTML(value.length + " / 18");
                                    //$$("contador").setHTML(val.length + " / 18");
                                }

                                // 3. Opcional: Cambiar el color si se pasa de 18 (por seguridad)
                                if (value.length < 18) {
                                    $$("contador").$view.style.color = "red";
                                } else {
                                    $$("contador").$view.style.color = ""; // Color original
                                }
                            }
                        }
                    },
                    { 
                        view: "template", // Cambiado de label a template para mejor manejo de HTML
                        id: "contador", 
                        name: "contador", 
                        template: "0 / 18", 
                        borderless: true, // Para que no se vea el recuadro del template
                        css: "char_counter", 
                        height: 25,
                        width: 50,

                    },
                ]},
                
            ]},

            
            // Nombre Completo (3 columnas)
            { label:"Nombre completo *", view:"label" },
            { cols:[
                { view:"text", name:"nombre", placeholder:"Nombre:", required:true },
                { view:"text", name:"apellido_paterno", placeholder:"Apellido paterno:", required:true },
                { view:"text", name:"apellido_materno", placeholder:"Apellido materno:", required:true }
            ]},

            // Selects
            { view:"combo", id:"centro", name:"centro", label:"Centro Universitario de Adscripción *", 
            options: {
                fitMaster: false,
                width: 550,
                keyPressTimeout: 300,
                filter: function (item, value) {
                    if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
                        return true;
                    return false;
                },
                body: {
                    template: "#value#",
                    dataFeed: "/api/gen/cmb_progap_depe",
                    // AGREGA ESTA LÍNEA:
                    // Inyectamos el valor que ya traes del servidor para que Webix lo reconozca
                    <%if(depe_id > 0){%>
                    data: [ { id: <%=depe_id%>, value: "<%=depe_value%>" } ]
                    <%}%>
                }
            }, placeholder:"-- Seleccione un centro universitario --", required:true },

            { view:"combo", name:"programa", label:"Clave y nombre del programa académico *", 
            options: {
                fitMaster: false,
                width: 550,
                keyPressTimeout: 300,
                filter: function (item, value) {
                    if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
                        return true;
                    return false;
                },
                body: {
                    template: "#value#",
                    dataFeed: "/api/gen/cmb_progap_prog",
                    // AGREGA ESTA LÍNEA:
                    // Inyectamos el valor que ya traes del servidor para que Webix lo reconozca
                    <%if(prog_id > 0){%>
                    data: [ { id: <%=prog_id%>, value: "<%=prog_value%>" } ]
                    <%}%>
                }
            }, placeholder:"-- Seleccione --", required:true },
            { cols:[
            { view:"richselect", name:"id_ciclo_ingreso", label:"Ciclo Escolar de Ingreso *", 
            options:[
                <%for (var i = 0; i < rows.length; i++) {%>
                { id: "<%= rows[i].id%>", value: "<%=rows[i].nombre%>" },
                <%}%>
            ], placeholder:"-- Seleccione --", required:true },

            { view:"richselect", name:"id_ciclo_curso", label:"Ciclo Escolar en Curso *", options:[
                <%for (var i = 0; i < rows.length; i++) {%>
                { id: "<%= rows[i].id%>", value: "<%=rows[i].nombre%>" },
                <%}%>
            ], placeholder:"-- Seleccione --", required:true },

            { view:"richselect", name:"id_ciclo_condonar", label:"Ciclo Escolar por Condonar *", options:[
                <%for (var i = 0; i < rows.length; i++) {%>
                { id: "<%= rows[i].id%>", value: "<%=rows[i].nombre%>" },
                <%
                if (i > 2)
                    break;
                }%>
            ], placeholder:"-- Seleccione --", required:true },
            ]},
            { cols:[
            // Correo
            { view:"text", name:"correo_institucional", label:"Correo Institucional *", placeholder:"Correo Institucional", validate:webix.rules.isEmail, required:true, invalidMessage:"Correo no válido" },

            // Estado
            { view:"combo", name:"id_estado", label:"Estado *", value:"1", options:[
                { id:"1", value:"Activo" }, { id:"0", value:"Inactivo" }
            ]},
            ]},
            // Botón Centrado
            <%if(!!prog_id)%>
            { margin:20, cols:[
                <%if(!!prog_id){%>
                {rows: [
					{ 
						view: "uploader", value: "Adjunta un archivo PDF", accept:"application/pdf",
						name:"filePDF", id:"filePDF", width:300,
						link:"list1",  upload:"/api/progap/progap_nfocamx",
						formData: {
							idFocam: <%=usuario[0].id%>,
						},
							on:{
									onUploadComplete:(response, file)=>{

									console.log(response);
									console.log(response.message);
									webix.message({ type:"info", text:response.message, id:"loadingMsg" });
									$$("form_registro").enable();
									carg_arch();

									//$$("formPDF").hideProgress();
								},
								onBeforeFileAdd: function (item) {
								//$$("formPDF").showProgress();

								$$("form_registro").disable(); 
								//$$("textoPDF").setValue("Subiendo y procesando archivo...");
								webix.message({ type:"info", text:"Subiendo y procesando archivo...", id:"loadingMsg" });
				
								return true;
								},
								onUploadFail: function (item){
								$$("form_registro").enable(); 
								},
							}
						},
						{
						view:"list",  id:"list1", type:"uploader",
						autoheight:true, borderless:true	
						},
				]},
                <%}%>
                {rows: [
                { view:"button", value:"<%=(usuario.length<1?'Crear usuario de estudiante':'Modificar estudiante')%>", css:"webix_primary", width:250, click:guardarEstudiante }
                ],
                },
                {
                rows: [
                    {view:"label", label:"Archivos"},
                    {
                        view: "list",
                        id: "archivos_adjuntos", name: "archivos_adjuntos",
                        height: 100,
                        header: "Archivos Adjuntos",
                        scroll: "y",      // Permite scroll vertical si hay muchos
                        
                        // **CLAVE:** Este template define cómo se verá cada archivo
                        template: function(obj) {
                            // obj es el objeto de datos (e.g., {id: 1, nombre: "factura.pdf", ...})
                            
                            let html = "<div class='file-item archivo-verde'>";
                            
                            // Icono basado en la extensión (ejemplo)
                            html += "<span class='webix_icon wxi-trash delete-file'></span> ";
                            
                            // Enlace de descarga (usa el ID o la ruta)
                            html += "<a href='/api/progap/pdownload?id=" + obj.id + "' target='_blank'>";
                            html += obj.nombre; // Muestra el nombre del archivo
                            html += "</a>";
                            
                            // Botón de eliminar (con un evento para manejar la lógica de borrado)
                            html += "<span class='webix_icon wxi-file' data-id='" + obj.id + "'></span>";
                            
                            html += "</div>";
                            return html;
                            },
                        on: {
                            onItemClick: function(id_item, e, node) {
                                
                                if (e.target.className.indexOf('delete-file') !== -1) {
                                    
                                    let id_archivo_a_borrar = id_item; 
                                    alert("Se hizo clic en el bote de basura para el archivo con ID: " + id_archivo_a_borrar);
                                    
                                    // **Llama a la función de confirmación y eliminación**
                                    //confirmarYEliminarArchivo(id_archivo_a_borrar);
                                    
                                    // Prevenir que el evento se propague si es necesario
                                    return false; 
                                }
                            }
                        },
                        
                        // Configuración para cargar datos del servidor (metadatos de MariaDB)
                        /* data:[
                            { "id": 1, "nombre": "factura_compra_01.pdf", "ruta": "/uploads/a3b1c2.pdf" },
                            { "id": 2, "nombre": "contrato_firmado.docx", "ruta": "/uploads/x9y8z7.docx" }
                            ] */
                        url: "/api/progap/progap_recu_arch?lnTram=<%=usuario[0].id%>"
                    }
                ] 
                },
                
            ]}
        ],
        <%if(usuario.length>0){%>
        data: datosIniciales,
        <%}%>
    });
});

function guardarEstudiante(){
    var form = $$("form_registro");
    if(form.validate()){
        var datos = form.getValues();
        console.log("Datos listos para enviar:", datos);
        
        // Aquí usarías tu webix.ajax().post("/api/...", datos)
        webix.message("Procesando registro...");
        webix.ajax()
				.post("/api/progap/progap_nestudiax", datos)
				.then(function (data) {
					//$$("btnGuardar").enable();
					let res = data.json()
					console.log(res)
					Swal.fire({
						title:res.message, icon:res.status=='error'?"error":"success"
					}).then(()=>{
						if(res.status=='server'){
//							window.location = "/op/op_ofic";
                        }
					})
					// webix.alert({ type: (data.json()[0].status ? "" : "alert-error"), text:  })
					// if (data.json()[0].status)
				})
    } else {
        webix.message({ type:"error", text:"Por favor llene los campos marcados en rojo" });
    }
}

function validarCURP(valor) {
    const regexCURP = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9A-Z]{1}[0-9]{1}$/;
    return regexCURP.test(valor.toUpperCase());
}

function carg_arch() {
			
    $$("archivos_adjuntos").clearAll()
    $$("archivos_adjuntos").load("/api/progap/progap_recu_arch?lnTram=<%=usuario[0].id%>");
}

</script>