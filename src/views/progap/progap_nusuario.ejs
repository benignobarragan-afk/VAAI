<%- include('../partials/header'); %>

<style>
.char_counter {
    text-align: right;
    font-size: 11px;
    color: #666;
    padding-top: 2px;
    padding-right: 5px;
    line-height: 15px; /* Ajusta la altura de línea para que pegue al input */
}
</style>

<script>

<%if(usuario.length>0){%>
var datosIniciales = <%- JSON.stringify(usuario) %>;
<%}%>

webix.ready(function(){
    webix.ui({
        view:"form",
        id:"form_registro",
        scroll: "y",
        elementsConfig:{
            labelPosition:"top",
            labelWidth:140,
            bottomPadding: 15
        },
        elements:[
            { view:"template", type:"header", template:"<%=(usuario.length<1?'Añadir Nuevo Registro':'Modificar a: ' + usuario[0].nombre)%>", css:"header_form" },
            
            // Fila: Código y Contraseña
            { cols:[
                { view:"text", name:"id", label:"id", hidden: true },
                { view:"text", name:"usuario", label:"Usuario *", placeholder:"Usuario", required:true, invalidMessage:"Requerido" },
                { view:"text", type:"password", name:"contrasena", label:"Contraseña *", placeholder:"Contraseña:", required:true, invalidMessage:"Requerido" }
            ]},
            // Nombre Completo (3 columnas)
            { label:"Nombre completo *", view:"label" },
            { cols:[
                { view:"text", name:"nombre", placeholder:"Nombre:", required:true },
                { view:"text", name:"apellido_paterno", placeholder:"Apellido paterno:", required:true },
                { view:"text", name:"apellido_materno", placeholder:"Apellido materno:", required:true }
            ]},
            { cols:[
                { view:"combo", name:"genero", label:"Genero *", value:"0", options:[
                    { id:"0", value:"Masculino" }, { id:"1", value:"Femenino" }
                ]},
                { view:"combo", name:"id_nivel_estudios", label:"Nivel de estudios *", value:"1", options:[
                    { id:"1", value:"Preparatoria o Bachillerato" }, { id:"2", value:"Licenciatura" }, { id:"3", value:"Maestría" }, { id:"4", value:"Especialidad" }, { id:"5", value:"Doctorado" }
                ]},
            ]},
            // Selects
            { view:"combo", id:"id_centro_universitario", name:"id_centro_universitario", label:"Centro Universitario de Adscripción *", 
            options: {
                fitMaster: false,
                width: 550,
                keyPressTimeout: 300,
                filter: function (item, value) {
                    if (item.value.toString().toLowerCase().indexOf(value.toLowerCase()) != -1)
                        return true;
                    return false;
                },
                body: {
                    template: "#value#",
                    dataFeed: "/api/gen/cmb_progap_depe",
                    // AGREGA ESTA LÍNEA:
                    // Inyectamos el valor que ya traes del servidor para que Webix lo reconozca
                    <%if(depe_id > 0){%>
                    data: [ { id: <%=depe_id%>, value: "<%=depe_value%>" } ]
                    <%}%>
                }
            }, placeholder:"-- Seleccione un centro universitario --", required:true },
            { cols:[
                { view:"text", name:"telefonos", label:"Teléfono:" ,placeholder:"Teléfono:", required:true },
                { view:"text", name:"extension", label:"Extensión:", placeholder:"Extensión:", required:true },
            ]},
            { cols:[
                { view:"text", name:"celular", label:"Celular:" ,placeholder:"Celular:", required:true },
                // Correo
            { view:"text", name:"correo", label:"Correo *", placeholder:"Correo:", validate:webix.rules.isEmail, required:true, invalidMessage:"Correo no válido" },
            ]},

            { cols:[
            { view:"combo", name:"id_tipo_usuario", label:"Tipo de usuario *", value:"5", options:[
                { id:"1", value:"Administrador" }, { id:"2", value:"Revisor" }, { id:"3", value:"Secretario Académico" }, { id:"4", value:"Coordinador de posgrado" }, { id:"5", value:"Estudiante" }
            ]},

            // Estado
            { view:"combo", name:"estado", label:"Estado *", value:"1", options:[
                { id:"1", value:"Activo" }, { id:"0", value:"Inactivo" }
            ]},
            {
                view: "combo", id: "id_convocatoria", label:"Convocatoria:", name: "id_convocatoria", value: "<%=rows[0].id%>",
                options: [
                    <%for (var i = 0; i < rows.length; i++) {%>
                    { id: "<%= rows[i].id%>", value: "<%=rows[i].anio%>" },
                    <%}%>
                ]
            },
            ]},
            // Botón Centrado
            { margin:20, cols:[
                {},
                { view:"button", value:"<%=(usuario.length<1?'Crear usuario':'Modificar usuario')%>", css:"webix_primary", width:250, click:guardarEstudiante },
                {}
            ]}
        ],
        <%if(usuario.length>0){%>
        data: datosIniciales,
        <%}%>
    });
});

function guardarEstudiante(){
    var form = $$("form_registro");
    if(form.validate()){
        var datos = form.getValues();
        console.log("Datos listos para enviar:", datos);
        
        // Aquí usarías tu webix.ajax().post("/api/...", datos)
        webix.message("Procesando registro...");
        webix.ajax()
				.post("/api/progap/progap_nusuariox", datos)
				.then(function (data) {
					//$$("btnGuardar").enable();
					let res = data.json()
					console.log(res)
					Swal.fire({
						title:res.message, icon:res.status=='error'?"error":"success"
					}).then(()=>{
						if(res.status=='server'){
//							window.location = "/op/op_ofic";
                        }
					})
					// webix.alert({ type: (data.json()[0].status ? "" : "alert-error"), text:  })
					// if (data.json()[0].status)
				})
    } else {
        webix.message({ type:"error", text:"Por favor llene los campos marcados en rojo" });
    }
}

function validarCURP(valor) {
    const regexCURP = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9A-Z]{1}[0-9]{1}$/;
    return regexCURP.test(valor.toUpperCase());
}

</script>