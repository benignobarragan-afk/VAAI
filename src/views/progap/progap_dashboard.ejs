<%- include('../partials/header'); %>

<script>

var data = [
  { val:"70", color1: "#2ECC71", color2:"#AAB7B8" },
  { val:"30", color1: "#AAB7B8", color2:"#E74C3C" },
];     

</script>

<body>
	<form id="form1" name="form1" method="post" action="">
		<div id="principal" style="position: relative; border: #B5CDE4 1px solid;"></div>
		<script>
			var cells = [
				{
					header: "<span class='webix_icon mdi mdi-file-document-outline'></span>Ingreso/Egreso", body: {
						view: "iframe", id: "re_graf01", src: "op_rgraf01.fwx",
						type: {
							height: 60
						},
						select: true,
					}
				}

			];

			webix.ready(function () {
				webix.ui({
					rows: [
						{
							cols:[
								  	{
										view: "combo", id: "cmbConvo", name: "cmbConvo",
										label: "Convocatoria: ", 
										labelWidth: 100,
										width: 220,
										value:"<%=rows[0].id%>",
										labelPosition:"left",
										options: {
											fitMaster: false,
											width: 200,
											body: {
												data: [
													<%for (var i = 0; i < rows.length; i++) {%>
													{ id: "<%= rows[i].id%>", value: "<%=rows[i].anio%>" },
													<%}%>
												]
											}
										},
										on: {
											onChange: ()=>{
												genera();
												
											}
										}
									},
									{
										view: "combo", id: "cmbDepe", name: "cmbDepe",
										label: "Dependencia: ", 
										labelWidth: 100,
										value:"0",
										labelPosition:"left",
										options: {
											//fitMaster: true,
											width: 600,
											body: {
												data: [
													{id:"0", value:"Todos"},
													<%for (var i = 0; i < rows2.length; i++) {%>
													{ id: "<%= rows2[i].id%>", value: "(<%=rows2[i].siglas%>) <%=rows2[i].dependencia%>" },
													<%}%>
												]
											},
											filter: function(item, value) {
											// Retorna true si el texto del combo contiene lo que el usuario escribió
											// Usamos .toLowerCase() para que no importe si es MAYÚSCULA o minúscula
											return item.value.toString().toLowerCase().indexOf(value.toLowerCase()) !== -1;
											},
										},
										on: {
											onChange: ()=>{
												genera();
												
											},
											onFocus: function() {
											// Usamos un pequeño delay para asegurar que el input ya esté listo
											setTimeout(() => {
												this.getInputNode().select();
											}, 50);
											}
										}
									},
							]
						},
						{
							cols:[
							{	
							view:"chart",
							type:"bar",
							id:"chaConce",
							name:"chaConce",
							barWidth:60,
							radius:2,
							gradient:"rising",
							xAxis:{
								template:"#mes#"
							},
							yAxis:{
								// start:0,
								// step:10,
								// end:100
							},
							legend:{
								values:[{text:"Completas",color:"#58dccd"},{text:"Rechazos",color:"#f08080"},{text:"Pendientes",color:"#36abee"}],
								valign:"middle",
								align:"right",
								width:120,
								layout:"y"
							},
							series:[
								{
								value:"#completa#",
								color: "#58dccd",
								tooltip:{
									template:"#completa#"
								}
								},
								{
								value:"#rechazada#",
								//label:"#rechazada#",
								color:"#f08080",
								tooltip:{
									template:"#rechazada#"
								}
								},
								{
								value:"#pendiente#",
								color:"#36abee",
								tooltip:{
									template:"#pendiente#"
								}
								}
							],
							},
							{ maxWidth: 5 },
							{ 
								rows: [
								{view:"fieldset", label:"Total Maestría", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato01", name:"lblDato01", width:150, height: 90, 
											template: "<div style='font-size: 45px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								{view:"fieldset", label:"Maestría completos", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato02", name:"lblDato02", width:150, height: 60, 
											template: "<div style='font-size: 30px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								{view:"fieldset", label:"Maestría Pen/rech", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato03", name:"lblDato03", width:150, height: 60, 
											template: "<div style='font-size: 30px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								{view:"fieldset", label:"Total completos", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato04", name:"lblDato04", width:150, height: 60, 
											template: "<div style='font-size: 30px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								]
							},
							{ maxWidth: 5 },
							{ 
								rows: [
								{view:"fieldset", label:"Total Doctorados", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato11", name:"lblDato11", width:150, height: 90, 
											template: "<div style='font-size: 45px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								{view:"fieldset", label:"Doctorados completos", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato12", name:"lblDato12", width:150, height: 60, 
											template: "<div style='font-size: 30px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								{view:"fieldset", label:"Doctorados pen/rech", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato13", name:"lblDato13", width:150, height: 60, 
											template: "<div style='font-size: 30px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								{view:"fieldset", label:"Total pen/rech", body:{
									rows:[
										{ view:"label", align:"right", label:"", id:"lblDato14", name:"lblDato14", width:150, height: 60, 
											template: "<div style='font-size: 30px; color: #FFFFFF;'>#label#</div>",
										},
									]
									}
								},
								]
							},
						]},
						{
							cols:[
							{

								view: "chart",
								type:"donut",
								id:"chaTotal",
								naem:"chaTotal",
								width:700,
								value:"#valor#",
								tooltip:{
									template: function(obj) {
									// obj contiene todos los datos de la fila/punto
									const formatoMoneda = Number(obj.valor).toLocaleString('en-US', { 
										currency: 'USD',
									});
									return obj.mes + ": " + formatoMoneda;
									}
								},
								//color:"#color#",
								legend:{
									width: 130,
									align:"right",
									valign:"middle",
									template:"#mes#"
								},
								pieInnerText:"#porcen# %",
								shadow:0,
								gradient:true,
								//data:month_dataset
							},
							{
								rows: [
                                    {
                                        view:"label", 
                                        label: "Maestría revisada", 
                                        align:"center" 
                                    },
									{
										view: "chart",
										id:"chaEgreF",
										name:"chaEgreF",
										donutInnerText: function(data, total) {
										return "<span style='font-size:20px; color: black;'>Fin:<br>"+data[0].val+"%</span>";
										},
										type:"donut",
										innerRadius:40, 
										value:"#val#",  
										color:"#color1#",
										width:200,
										data
									},
									{
										view: "chart",
										id:"chaEgreP",
										name:"chaEgreP",
										donutInnerText: function(data, total) {
										return "<span style='font-size:20px; color: black;'>Pen:<br>"+data[1].val+"%</span>";
										},
										type:"donut",
										innerRadius:40, 
										value:"#val#",  
										color:"#color2#",
										data
									}
								]
							},
                            {
								rows: [
                                    {
                                        view:"label", 
                                        label: "Doctorado revisado", 
                                        align:"center" 
                                    },
									{
										view: "chart",
										id:"chaIngreF",
										name:"chaIngreF",
										donutInnerText: function(data, total) {
										return "<span style='font-size:20px; color: black;'>Fin:<br>"+data[0].val+"%</span>";
										},
										type:"donut",
										innerRadius:40, 
										value:"#val#",  
										color:"#color1#",
										width:200,
										data
									},
									{
										view: "chart",
										id:"chaIngreP",
										name:"chaIngreP",
										donutInnerText: function(data, total) {
										return "<span style='font-size:20px; color: black;'>Pen:<br>"+data[1].val+"%</span>";
										},
										type:"donut",
										innerRadius:40, 
										value:"#val#",  
										color:"#color2#",
										data
									}
								]
							},
							{
							view:"treemap",
							select: true,
							id:"chaDeman",
							name:"chaDeman",
							headerTemplate: "#label#",
							template: function(item){
								return item.label || "";
							},
							type:{
								cssClass: getCss
							},
							value: "#value#",
							on: {
									onItemClick: function(id){
									if(this.isBranch(id)){
										this.showBranch(id);
									}
									else{
										var item = this.getItem(id);
										webix.message("Cantidad: "+ item.value);
									}
									}
								},
							}
							
							]
						},

					]
				})
				genera();
			});

			function genera(){

				$$("chaConce").clearAll();
				$$("chaConce").load("/api/progap/progap_dashboardx?lnConvo=" + $$("cmbConvo").getValue() + "&lnDepe=" + $$("cmbDepe").getValue() );

				$$("chaTotal").clearAll();
				$$("chaTotal").load("/api/progap/progap_dashboardx2?lnConvo=" + $$("cmbConvo").getValue() + "&lnDepe=" + $$("cmbDepe").getValue() );

				$$("chaDeman").clearAll();
				$$("chaDeman").load("/api/progap/progap_dashboardx3?lnConvo=" + $$("cmbConvo").getValue() + "&lnDepe=" + $$("cmbDepe").getValue() );

				webix.ajax().get("/api/progap/progap_dashboardx4?lnConvo=" + $$("cmbConvo").getValue() + "&lnDepe=" + $$("cmbDepe").getValue()).then((res)=>{
				res = res.json()
					//console.log(res);
					//console.log(res[0].value)

					const formatterMXN = new Intl.NumberFormat('es-MX', {
						style: 'decimal',
						currency: 'MXN',
					});
					$$("lblDato01").define("label", formatterMXN.format(res[0].mtotal));
					$$("lblDato01").refresh();
					$$("lblDato02").define("label", formatterMXN.format(res[0].mcompleta));
					$$("lblDato02").refresh();
					$$("lblDato03").define("label", formatterMXN.format(res[0].mpendienter));
					$$("lblDato03").refresh();
					$$("lblDato04").define("label", formatterMXN.format(parseInt(res[0].mcompleta)+parseInt(res[0].dcompleta)));
					$$("lblDato04").refresh();
					$$("lblDato11").define("label", formatterMXN.format(res[0].dtotal));
					$$("lblDato11").refresh();
					$$("lblDato12").define("label", formatterMXN.format(res[0].dcompleta));
					$$("lblDato12").refresh();
					$$("lblDato13").define("label", formatterMXN.format(res[0].dpendienter));
					$$("lblDato13").refresh();
					$$("lblDato14").define("label", formatterMXN.format(parseInt(res[0].dpendienter)+parseInt(res[0].mpendienter)));
					$$("lblDato14").refresh();

					
					//$$("chaEgreF").setValue(res[0].etotal);
					//$$("chaEgreF").refresh();
					$$("chaEgreF").clearAll()
					$$("chaEgreP").clearAll()
					$$("chaIngreF").clearAll()
					$$("chaIngreP").clearAll()
					
					const lnPendiM = Math.round((res[0].mpendiente * 100) / (res[0].mtotal-res[0].mcompleta))
					const lnComplM = 100 - lnPendiM
					const lnPendiD = Math.round((res[0].dpendiente * 100) / (res[0].dtotal-res[0].dcompleta))
					const lnComplD = 100 - lnPendiD

					//console.log(lnPendiM)
					//console.log(lnComplM)

					const loNewDatoE = [
						{ val:lnComplM, color1: "#26a69a", color2:"#AAB7B8" },
						{ val:lnPendiM, color1: "#AAB7B8", color2:"#42a5f5" },
						];
					$$("chaEgreF").parse(loNewDatoE)
					$$("chaEgreP").parse(loNewDatoE)

					const loNewDatoI = [
						{ val:lnComplD, color1: "#26a69a", color2:"#AAB7B8" },
						{ val:lnPendiD, color1: "#AAB7B8", color2:"#42a5f5" },
						];
					$$("chaIngreF").parse(loNewDatoI)
					$$("chaIngreP").parse(loNewDatoI)
					
					
				})
			}

			function getCss(item){
				var color = "",
					id = item.id,
					comments = item.tipo;
				
				if(!this.isBranch(id)){
					if(comments == 1)
					color ="#b2dfdb";
					else if(comments == 2)
					color ="#80cbc4";
					else if(comments == 3)
					color ="#4db6ac";
					else if(comments == 5)
					color ="#26a69a";
					else if(comments == 4)
					color ="#f08080";
					else 
					color ="#42a5f5";
				}
				return { background: color};
			}
		</script>
	</form>
</body>

</html>