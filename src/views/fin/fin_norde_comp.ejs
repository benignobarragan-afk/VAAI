<%- include('../partials/header'); %>

<body>
    <script>

        <%if(rows2.length>0){%>
        var datosIniciales = <%- JSON.stringify(rows2) %>;
        <%}%>

        <%if(rows3.length>0){%>
        var detaIniciales = <%- JSON.stringify(rows3) %>;
        <%}%>

        var tip = 0
        var w1;
        var mygrid;

        //alert(tip);

        //function doOnLoad() {
    webix.ready(function()
    {
        webix.ui(

        {
            view: "form",
            id: "form_orden",
            labelPosition:"top",
            rules: {
                "corr_prov": webix.rules.isEmail // Valida formato de correo
            },
            elements: [
                {
                    view: "tabview",
                    cells: [
                        {
                            header: "Datos orden de compra",
                            body: {margin: 20,
                                rows: [
                                    {height:5},
                                    {
                                        cols: [
                                            {view: "text", id: "id_orde_comp", name: "id_orde_comp", value:'0', hidden: true},
                                            { view: "combo", name: "tipo_orde", label: "Tipo", labelWidth: 80, options: [{id:1, value:"Compra"}, {id:2, value:"Servicio"}], width: 400, required: true, 
                                            on: {
                                                    onChange: function(newv, oldv) {
                                                        // newv contiene el ID del elemento seleccionado (1 o 2)
                                                        if (newv) {
                                                            //console.log("ID seleccionado:", newv);
                                                            tipo(newv);
                                                        }
                                                    }
                                                }
                                            },
                                            {width: 20},
                                            {view: "checkbox", id: "apli_resico", name: "apli_resico", label: "¿Aplica RESICO?", labelWidth: 120, value: 0, checkValue: 1, uncheckValue: 0,
                                                on: {
                                                    onChange: function(newVal, oldVal) {
                                                        actu_resico(newVal); 
                                                    }
                                                }    
                                            },
                                            {},
                                            <%if(rows2.length>0){%>
                                            { view: "datepicker", name: "fech_emis", label: "Fecha", labelWidth: 80, stringResult: true, width: 400, required: true, readonly: true},
                                            <%}%>
                                        ]
                                    },
                                    {
                                        cols: [
                                            {
                                                view: "combo", name: "proyecto", value:"<%=rows[0].proyecto%>", label:"Proyecto", labelWidth: 80, required: true,
                                                options: {
                                                    fitMaster: false,
                                                    width: 1000,
                                                    body: {
                                                        data: [
                                                    <%for (var i = 0; i < rows.length; i++) {%>
                                                    { id: "<%=rows[i].proyecto%>", value: "(<%=rows[i].campus%>-<%=rows[i].fondo%>) <%=rows[i].proyecto%>-<%=rows[i].nombre%>" },
                                                    <%}%>

                                                ]
                                                    }
                                                },
                                                on: {
                                                    onChange: function(newv, oldv) {
                                                        // newv contiene el ID del elemento seleccionado (1 o 2)
                                                        if (newv) {
                                                            //console.log("ID seleccionado:", newv);
                                                            busc_depe(newv);
                                                        }
                                                    }
                                                    

                                                }
                                            },
                                        ]
                                    },
                                    {view:"fieldset", label:"Datos proveedor",  
                                        body:{
                                            rows: [
                                            {
                                            
                                                cols: [
                                                    { 
                                                        view: "text", 
                                                        id: "rfc", 
                                                        name: "rfc", 
                                                        label: "RFC", 
                                                        width: 280, required: true,
                                                        attributes: { maxlength: 20 },
                                                        suggest: {
                                                            id: "rfc:suggestList",
                                                            view: "suggest",
                                                            keyPressTimeout: 1000,
                                                            body: {
                                                                template: "#value#",
                                                                dataFeed: "/api/gen/cmb_prov?lnTipo=1",
                                                                select: true
                                                            },
                                                            on: {
                                                                "onValueSuggest": function (obj) {
                                                                    if (obj) {
                                                                        if($$("tele_prov")) $$("tele_prov").setValue(obj.tele_prov || "");
                                                                        if($$("corr_prov")) $$("corr_prov").setValue(obj.corr_prov || "");
                                                                        if($$("rfc"))       $$("rfc").setValue(obj.rfc || "");
                                                                        if($$("proveedor")) $$("proveedor").setValue(obj.proveedor || "");
                                                                        if($$("domi_prov")) $$("domi_prov").setValue(obj.domi_prov || "");
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                    {width: 20},
                                                    { 
                                                        view: "text", 
                                                        id: "proveedor", 
                                                        name: "proveedor", 
                                                        label: "Nombre proveedor", 
                                                        labelWidth: 150, required: true,
                                                        attributes: { maxlength: 255 },
                                                        suggest: {
                                                            id: "proveedor:suggestList",
                                                            view: "suggest",
                                                            keyPressTimeout: 1000,
                                                            body: {
                                                                template: "#value#",
                                                                dataFeed: "/api/gen/cmb_prov?lnTipo=2", // Tipo 2 para búsqueda por nombre
                                                                select: true
                                                            },
                                                            on: {
                                                                "onValueSuggest": function (obj) {

                                                                    if (obj) {
                                                                        // Llenado masivo de los campos del proveedor
                                                                        if($$("tele_prov")) $$("tele_prov").setValue(obj.tele_prov || "");
                                                                        if($$("corr_prov")) $$("corr_prov").setValue(obj.corr_prov || "");
                                                                        if($$("rfc"))       $$("rfc").setValue(obj.rfc || "");
                                                                        if($$("proveedor")) $$("proveedor").setValue(obj.proveedor || "");
                                                                        if($$("domi_prov")) $$("domi_prov").setValue(obj.domi_prov || "");
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                ]
                                            },
                                            {height: 10},
                                            {
                                            
                                                cols: [
                                                    { view: "text", id: "tele_prov", name: "tele_prov", label: "Teléfono proveedor", labelWidth: 150, placeholder: "  -    -    ", required: true, attributes: { maxlength: 30 },},
                                                    {width: 20},
                                                    { view: "text", id: "corr_prov", name: "corr_prov", label: "Correo proveedor", labelWidth: 150, placeholder: "correo@correo.com", required: true, invalidMessage: "El Correo es invalido", attributes: { maxlength: 50 },}
                                                ]
                                            }]
                                        },
                                    },
                                    {view:"fieldset", label:"Datos entrega y forma de pago",  
									body:{ 
                                        rows: [
                                            {
                                                cols: [
                                                    { view: "datepicker", id: "fech_entr", name: "fech_entr", label: "Fecha de entrega", labelWidth: 130, width: 250, required: true },
                                                    {width: 20},
                                                    { view: "radio", name: "forma_pago", label: "Forma Pago", labelWidth: 100, options: [{id:1, value:"Contado"},{id:2, value:"Parcialidades"}], vertical: false, required: true,
                                                        on: {
                                                    onChange: function(newv, oldv) {
                                                                // newv contiene el ID del elemento seleccionado (1 o 2)
                                                                if (newv) {
                                                                    //console.log("ID seleccionado:", newv);
                                                                    parcialidad(newv);
                                                                }
                                                            }
                                                        }
                                                    },
                                                    {width: 20},
                                                    { view: "counter", id: "nume_parc", name: "nume_parc", label: "Parcialidades", labelWidth: 100, min: 0, max: 100, hidden: true },
                                                    {width: 20},
                                                    { view: "counter", name: "porc_anti", label: "% Anticipo", min: 0, max: 100 }
                                                ]
                                            }, 
                                            { id:"fech_serv", hidden: true, 
                                                cols: [
                                                    { view: "datepicker", id: "fech_inic", name: "fech_inic", label: "Fecha de incio del servicio", labelWidth: 200},
                                                    {width: 20},
                                                    { view: "datepicker", id: "fech_fin", name: "fech_fin", label: "Fecha de fin del servicio", labelWidth: 200},
                                                ]
                                            },                                  
                                            {
                                                cols: [
                                                    { view: "textarea", id: "domi_prov", name: "domi_prov", label: "Dirección del proveedor", labelPosition: "top", height: 120, required: true, attributes: { maxlength: 1000 },},
                                                    {width: 20},
                                                    { view: "textarea", id: "luga_entr", name: "luga_entr", label: "Lugar de entrega", labelPosition: "top", height: 120, required: true , attributes: { maxlength: 1000 }},
                                                    {width: 20},
                                                    { view: "textarea", name: "observaciones", label: "Observaciones", labelPosition: "top", height: 120, attributes: { maxlength: 1000 }},
                                                ]
                                            },
                                        ]}
                                    }
                                ]
                            }
                        },
                        {
                            header: "Artículos y costos",
                            body: {
                                rows: [
                                    {height:5},
                                    {
                                        cols: [
                                            { view: "textarea", name: "articulo", label: "Artículo o servicio", labelPosition: "top", height: 80, attributes: { maxlength: 1000 }},
                                            {width: 20},
                                            { view: "combo", name: "unidad", label: "Unidad", labelWidth: 80, options: ["N/A","CAJA","KG","LITRO","METRO","OTRA","PIEZA"], width: 100, labelPosition: "top"},
                                            {width: 20},
                                            { view: "text", name: "cantidad", label: "Cantidad", labelPosition: "top", width: 130, attributes: { maxlength: 20}, 
                                                pattern: { mask: "####################", allow: /[0-9]/g },
                                                // Esta línea le dice: "Si está vacío, está BIEN (true)"
                                                validate: function(value){ return value === "" || value.length > 0; }
                                            },
                                            {width: 20},
                                            { 
                                                view: "text", 
                                                name: "cost_unit", 
                                                label: "Costo unitario", 
                                                labelPosition: "top", 
                                                width: 130, 
                                                attributes: { maxlength: 20 },
                                                // Esta propiedad es mágica: solo permite los caracteres que pongas aquí
                                                keyPressTimeout: 1, 
                                                on: {
                                                    onTimedKeyPress: function() {
                                                        let value = this.getValue();
                                                        // Eliminamos cualquier cosa que no sea número o punto
                                                        let fixed = value.replace(/[^0-9.]/g, "");
                                                        
                                                        // Si hay más de un punto, dejamos solo el primero
                                                        if (fixed.split(".").length > 2) {
                                                            fixed = fixed.substring(0, fixed.lastIndexOf("."));
                                                        }
                                                        
                                                        if (value !== fixed) this.setValue(fixed);
                                                    },
                                                    onBlur: function() {
                                                        let val = this.getValue();
                                                        if (val !== "" && !isNaN(val)) {
                                                            this.setValue(parseFloat(val).toFixed(2));
                                                        }
                                                    }
                                                }
                                            },
                                            {width: 20},
                                            { view: "text", name: "tasa_iva", label: "Tasa IVA", labelPosition: "top", width: 130, attributes: { maxlength: 2}, 
                                                pattern: { mask: "##", allow: /[0-9]/g },
                                                // Esta línea le dice: "Si está vacío, está BIEN (true)"
                                                validate: function(value){ return value === "" || value.length > 0; }
                                            },
                                            
                                        ]
                                    },
                                    {
                                        cols: [
                                            {},
                                            { view: "button", value: "Agregar artículo", css: "webix_primary", click: agregarArticulo, width: 150, <%=(rows2[0]?.estatus > 1?' disabled: true':'')%>},
                                            { view: "button", value: "Elimina artículo", click: eliminarArticulo, width: 150, <%=(rows2[0]?.estatus > 1?' disabled: true':'')%>}
                                        ]
                                    },
                                    {
                                        view: "datatable",
                                        id: "detalles_tabla",
                                        autoheight: true,
                                        minHeight: 200,
                                        select: true,
                                        footer: true, // 1. Habilitamos el pie de página
                                        columns: [
                                            { 
                                                id: "articulo", 
                                                header: "Producto", 
                                                fillspace: true,
                                                footer: { text: "Totales:", css: "footer_total_text" } // Etiqueta en el pie
                                            },
                                            { id: "cantidad", header: "Cantidad", width: 130, css: { "text-align": "right" } },
                                            { id: "cost_unit", header: "Costo", width: 150, css: { "text-align": "right" }, format: webix.i18n.priceFormat },
                                            { id: "tasa_iva", header: "IVA", width: 100, css: { "text-align": "right" } },
                                            { 
                                                id: "subtotal", 
                                                header: "Subtotal", 
                                                width: 200, css: { "text-align": "right" },
                                                format: webix.i18n.priceFormat,
                                                footer: { content: "summColumn", css: { "text-align": "right" } } // 2. Sumatoria automática
                                            },
                                            { 
                                                id: "montoiva", 
                                                header: "Monto IVA", 
                                                width: 120, css: { "text-align": "right" },
                                                format: webix.i18n.priceFormat,
                                                footer: { content: "summColumn", css: { "text-align": "right" } } // 2. Sumatoria automática
                                            },
                                            { 
                                                id: "mont_resico", 
                                                header: "RESICO", 
                                                width: 120, css: { "text-align": "right" },
                                                format: webix.i18n.priceFormat,
                                                footer: { content: "summColumn", css: { "text-align": "right" } } // 2. Sumatoria automática
                                            },
                                            { 
                                                id: "total", 
                                                header: "Total", 
                                                width: 200, css: { "text-align": "right" },
                                                format: webix.i18n.priceFormat,
                                                footer: { content: "summColumn", css: { "text-align": "right" } } // 3. Sumatoria automática
                                            }
                                        ],
                                        
                                        <%if(rows3.length>0){%>
                                        data: detaIniciales, 
                                        <%}%>
                                    },                                    
                                ]
                            }
                        },
                        {
                            header: "Datos dependencia",
                            body: {margin: 20,
                                rows: [
                                    {height:5},
                                    {
                                        cols: [
                                            { view: "text", id: "ures_depe", name: "ures_depe", label: "Código de URE", labelPosition: "top", readonly: true, required: true},
                                            { view: "text", id: "nomb_depe", name: "nomb_depe", label: "Dependencia del proyecto", labelPosition: "top", readonly: true, required: true},
                                            { view: "button", value: "Guardar datos dependencia", css: "webix_secondary", width: 150, click: actu_depe, <%=(rows2[0]?.estatus > 1?' disabled: true':'')%>},
                                        ]
                                    },
                                    {
                                        cols: [
                                            { view: "text", id: "tele_depe", name: "tele_depe", label: "Teléfono de la dependencia", labelPosition: "top", required: true, attributes: { maxlength: 50 }},
                                            { view: "textarea", id: "domi_depe", name: "domi_depe", label: "Dirección dependencia", labelPosition: "top", height: 80, required: true, attributes: { maxlength: 150 } },
                                        ]
                                    },
                                    {
                                        cols: [
                                            { view: "textarea", id: "nomb_elab", name: "nomb_elab", label: "Persona elaboro", labelPosition: "top", required: true, attributes: { maxlength: 1000 }},
                                            { view: "textarea", id: "nomb_auto", name: "nomb_auto", label: "Persona autoriza", labelPosition: "top", required: true, attributes: { maxlength: 1000 }},
                                            { view: "textarea", id: "nomb_vobo", name: "nomb_vobo", label: "Personas Vo. Bo.", labelPosition: "top", height: 80, required: true, attributes: { maxlength: 1000 } },
                                        ]
                                    },

        
                                    // Metemos la datatable dentro del array de elementos
                                ]
                            }
                        }
                    ]
                },
                {
                    margin: 10,
                    cols: [
                        { view: "button", value: "Imprimir Orden", css: "webix_primary", width: 150, click: imprimir },
                        {},
                        { view: "button", id:"cmbGuar_temp", value: "Guardar Borrador", value: "Guardar Borrador", css: "webix_secondary", width: 150, click: guardar, <%=(rows2[0]?.estatus > 1?' disabled: true':'')%>},
                        { view: "button", id:"cmdGuardar", value: "Generar Orden", css: "webix_primary", width: 150, click: generar, <%=(rows2[0]?.estatus > 1?' disabled: true':'')%> },
                        { view: "button", value: "Cancelar", css: "webix_danger", width: 100, <%=(rows2[0]?.estatus > 8?' disabled: true':'')%> }
                    ]
                }
            ],
            <%if(rows2.length>0){%>
            data: datosIniciales,
            <%}%>
        },        
        );
        //busc_depe(<%=rows[0].proyecto%>);
        });

        function busc_depe(nuevo) {
            
            //console.log(nuevo);
            webix.ajax().post("/api/fin/fin_norde_compx2", {proyecto:nuevo}).then((res)=>{
				res = res.json();
                //console.log(res)
                $$("ures_depe").setValue(res.cve_conv);
                $$("nomb_depe").setValue(res.dependen);
                $$("tele_depe").setValue(res.telefono);
                $$("domi_depe").setValue(res.direccion);
                $$("nomb_elab").setValue((!$$("nomb_elab").getValue()?'<%=nomb_usua%>':$$("nomb_elab").getValue()))
                $$("nomb_auto").setValue(res.nomb_dire);
                $$("nomb_vobo").setValue(res.nomb_secr);
                if($$("luga_entr").getValue() == '' || !$$("luga_entr").getValue()){
                    $$("luga_entr").setValue(res.direccion || "")
                }
			})

        }

        function deta_grup(id) {
            window.parent.$$("tbView").addView({
                header: "<span class='webix_icon mdi mdi-file-document-outline'></span>" + (id == undefined ? "Nuevo" : "Modifica") + " FOCAM",
                body: {
                    view: "iframe", src: "/progap/progap_nfocam?lnID=" + id,
                    type: {
                        height: 60
                    }
                },
                close: true
            });
            window.parent.$$("tbView").getTabbar().setValue(window.parent.$$("tbView").getTabbar().data.options[window.parent.$$("tbView").getTabbar().data.options.length - 1].id);
        }


        function agregar() {

            var checked = [];
            $$("dtable").data.each(function (obj) {
                if (obj.marcar == 1) checked.push(obj.id);
            });
            
            $$("dtable").remove(checked);
            window.parent.parent.carg_grupo(checked.toString());
        }

        function tipo(lnTipo){
            //console.log(lnTipo)
            let campoTexto = $$("luga_entr");
            let campoFecha = $$("fech_entr");
            if(lnTipo == 1){
                $$("fech_serv").hide();
                campoTexto.define("label", "Lugar de entrega");
                campoFecha.define("label", "Fecha de entrega");
            }
            else{
                $$("fech_serv").show();
                campoTexto.define("label", "Lugar prestación del servicio");
                campoFecha.define("label", "Fecha de pago");
            }
            campoTexto.refresh();
            campoFecha.refresh();
        }

        function parcialidad(lnTipo){
            //console.log(lnTipo)
            if(lnTipo == 1){
                $$("nume_parc").hide();
            }
            else {
                $$("nume_parc").show();
            }
            
        }

        function agregarArticulo() {
            // 1. Obtenemos los valores del formulario
            // Asegúrate de que tu formulario tenga id: "form_orden"
            var valores = $$("form_orden").getValues();
            // 2. Validaciones básicas para evitar filas vacías
            if (!valores.articulo || !valores.cantidad || !valores.cost_unit) {
                webix.message({ type: "error", text: "Complete: Artículo, Cantidad y Costo" });
                return;
            }

            // 3. Cálculos matemáticos
            var cant = parseFloat(valores.cantidad) || 0;
            var costo = parseFloat(valores.cost_unit) || 0;
            var tasaIva = parseFloat(valores.tasa_iva) || 0;

            // Cálculo del Subtotal (Cantidad * Costo)
            var subtotal = cant * costo;
            var resico   = (valores.apli_resico == 1?subtotal * 0.0125:0);
            var montoiva = subtotal * ((tasaIva / 100));
            
            // Cálculo del Total (Subtotal + el porcentaje de IVA)
            // Ejemplo: Si el IVA es 16, calcula: subtotal * 1.16
            var totalConIva = subtotal * (1 + (tasaIva / 100));

            // 4. Creamos el objeto con los nuevos IDs de las columnas
            var item = {
                articulo: valores.articulo,
                cantidad: cant,
                cost_unit: costo,
                tasa_iva: tasaIva,
                subtotal: subtotal,   // Monto sin IVA
                montoiva: montoiva,   // Monto del IVA
                mont_resico: resico,       //Monto RESICO
                total: totalConIva,    // Monto con IVA
                unidad: valores.unidad // Guardado internamente aunque no esté en la columna
            };

            // 5. Agregamos a la cuadrícula
            $$("detalles_tabla").add(item);

            // 6. Limpiamos los campos de captura para el siguiente artículo
            // Usamos true para no borrar los datos generales de la orden (como folio o proveedor)
            $$("form_orden").setValues({
                articulo: "",
                unidad: "N/A",
                cantidad: "",
                cost_unit: "",
                tasa_iva: ""
            }, true);

            webix.message("Artículo añadido a la lista");
        }

    function eliminarArticulo() {
        var id = $$("detalles_tabla").getSelectedId();
        if (id) {
            $$("detalles_tabla").remove(id);
        } else {
            webix.message({ type: "error", text: "Seleccione un artículo para eliminar" });
        }
    }

    function guardar(){
        
        var datosOrden = $$("form_orden").getValues();
    
        var partidas = $$("detalles_tabla").serialize();

        // 4. Consolidar el paquete de datos
        var payload = {
            encabezado: datosOrden,
            detalles: partidas
        };

        //console.log(datosOrden);
    
        webix.ajax().post("/api/fin/fin_norde_compx", payload, function(text, data) {
            var response = data.json();
            
            if (response.status === "success") {
                webix.alert({
                    title: "Éxito",
                    text: response.message,
                });

                if (response.id > 0 && datosOrden.id_orde_comp <= 0){
                    $$("id_orde_comp").setValue(response.id);
                }
            } else {
                webix.message({ type: "error", text: "Error al guardar: " + response.message });
            }
        });

    }

    function imprimir(){

 
    const lnID = $$("id_orde_comp").getValue()
    if(lnID <= 0){
        webix.message({type: "debug", text: "No puedes genear el documento hasta guardarlo por lo menos temporalmente", expire: 2500})
    }
    else {
        window.open(`/api/fin/fin_impr_oc?id=${lnID}`, '_blank');
    }
    


    }

    function generar(){

        // 1. Validar el formulario antes de enviar
        var formulario = $$("form_orden");
        if (!formulario.validate()) {
            webix.message({ type: "error", text: "Por favor, complete los campos obligatorios" });
            return;
        }

        // 2. Obtener datos generales del formulario (RFC, Proveedor, etc.)
        var datosOrden = formulario.getValues();

        // 3. Obtener los artículos de la datatable
        var partidas = $$("detalles_tabla").serialize();
        
        if (partidas.length === 0) {
            webix.message({ type: "error", text: "Debe agregar al menos un artículo a la orden" });
            return;
        }

        // 4. Consolidar el paquete de datos
        var payload = {
            encabezado: datosOrden,
            detalles: partidas,
            generar: true,
        };

        // 5. Envío mediante AJAX a tu ruta de Node.js
        webix.ajax().post("/api/fin/fin_norde_compx", payload, function(text, data) {
            var response = data.json();
            
            if (response.status === "success") {
                webix.alert({
                    title: "Éxito",
                    text: response.message,
                });

                if (response.id > 0 && datosOrden.id_orde_comp <= 0){
                    $$("id_orde_comp").setValue(response.id);
                }
                $$("cmbGuar_temp").disable();
                $$("cmdGuardar").disable();
            } else {
                webix.message({ type: "error", text: "Error al guardar: " + response.message });
            }
        });

    }

    function actu_depe(){

        const camb_depe = {
            ures_depe : $$("ures_depe").getValue(),
            nomb_depe : $$("nomb_depe").getValue(),
            tele_depe : $$("tele_depe").getValue(),
            domi_depe : $$("domi_depe").getValue(),
        }

        webix.ajax().post("/api/fin/fin_norde_compx3", camb_depe).then((res)=>{
            res = res.json();
            Swal.fire({text:res.message, icon:res.status== "success" ? "success":"error"});
            //console.log(res)
        });        
    }

    function actu_resico(valor) {
        var table = $$("detalles_tabla");

        if (table && table.count() > 0) {

            // Bloqueamos el dibujado para que sea más rápido
            table.blockEvent(); 

            table.eachRow(function(rowId) {
                var item = table.getItem(rowId);
                
                
                // 1. Actualizamos la tasa de IVA en el objeto
                if (valor == 1){
                    item.mont_resico = item.cantidad * item.cost_unit * 0.0125;
                }
                else 
                {
                    item.mont_resico = 0;
                }
                
                // 3. Guardamos los cambios en la fila
                table.updateItem(rowId, item);
            });

            table.unblockEvent();
            table.refresh(); // Refrescamos visualmente la tabla
            
            webix.message("El RESICO se actulizo en los artículos");
        }
    }

    </script>
</body>


</html>