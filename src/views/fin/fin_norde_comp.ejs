<%- include('../partials/header'); %>

<body>
    <script>
        var tip = 0
        var w1;
        var mygrid;

        //alert(tip);

        //function doOnLoad() {
    webix.ready(function()
    {
        webix.ui(

        {
            view: "form",
            id: "form_orden",
            labelPosition:"top",
            rules: {
                "corr_prov": webix.rules.isEmail // Valida formato de correo
            },
            elements: [
                {
                    view: "tabview",
                    cells: [
                        {
                            header: "Datos orden de compra",
                            body: {margin: 20,
                                rows: [
                                    {height:5},
                                    {
                                        cols: [
                                            {view: "text", name: "id_orde_comp", hidden: true},
                                            { view: "combo", name: "tipo_orde", label: "Tipo", labelWidth: 80, options: [{id:1, value:"Compra"}, {id:2, value:"Servicio"}], width: 400, required: true, 
                                            on: {
                                                    onChange: function(newv, oldv) {
                                                        // newv contiene el ID del elemento seleccionado (1 o 2)
                                                        if (newv) {
                                                            //console.log("ID seleccionado:", newv);
                                                            tipo(newv);
                                                        }
                                                    }
                                                }
                                            },
                                            {},
                                            { view: "datepicker", name: "fech_emis", label: "Fecha", labelWidth: 80, stringResult: true, width: 400, required: true, },
                                        ]
                                    },
                                    {
                                        cols: [
                                            {
                                                view: "combo", name: "proyecto", value:"<%=rows[0].proyecto%>", label:"Proyecto", labelWidth: 80, required: true,
                                                options: {
                                                    fitMaster: false,
                                                    width: 1000,
                                                    body: {
                                                        data: [
                                                    <%for (var i = 0; i < rows.length; i++) {%>
                                                    { id: "<%=rows[i].proyecto%>", value: "(<%=rows[i].campus%>-<%=rows[i].fondo%>) <%=rows[i].nombre%>" },
                                                    <%}%>

                                                ]
                                                    }
                                                },
                                                on: {
                                                    onChange: function(newv, oldv) {
                                                        // newv contiene el ID del elemento seleccionado (1 o 2)
                                                        if (newv) {
                                                            //console.log("ID seleccionado:", newv);
                                                            busc_depe(newv);
                                                        }
                                                    }
                                                    

                                                }
                                            },
                                        ]
                                    },
                                    {view:"fieldset", label:"Datos proveedor",  
                                        body:{
                                            rows: [
                                            {
                                            
                                                cols: [
                                                    { 
                                                        view: "text", 
                                                        id: "rfc", 
                                                        name: "rfc", 
                                                        label: "RFC", 
                                                        width: 280, required: true,
                                                        suggest: {
                                                            id: "rfc:suggestList",
                                                            view: "suggest",
                                                            keyPressTimeout: 1000,
                                                            body: {
                                                                template: "#value#",
                                                                dataFeed: "/api/gen/cmb_prov?lnTipo=1",
                                                                select: true
                                                            },
                                                            on: {
                                                                "onValueSuggest": function (obj) {
                                                                    if (obj) {
                                                                        if($$("tele_prov")) $$("tele_prov").setValue(obj.tele_prov || "");
                                                                        if($$("corr_prov")) $$("corr_prov").setValue(obj.corr_prov || "");
                                                                        if($$("rfc"))       $$("rfc").setValue(obj.rfc || "");
                                                                        if($$("proveedor")) $$("proveedor").setValue(obj.proveedor || "");
                                                                        if($$("domi_prov")) $$("domi_prov").setValue(obj.domi_prov || "");
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                    {width: 20},
                                                    { 
                                                        view: "text", 
                                                        id: "proveedor", 
                                                        name: "proveedor", 
                                                        label: "Nombre proveedor", 
                                                        labelWidth: 150, required: true,
                                                        suggest: {
                                                            id: "proveedor:suggestList",
                                                            view: "suggest",
                                                            keyPressTimeout: 1000,
                                                            body: {
                                                                template: "#value#",
                                                                dataFeed: "/api/gen/cmb_prov?lnTipo=2", // Tipo 2 para búsqueda por nombre
                                                                select: true
                                                            },
                                                            on: {
                                                                "onValueSuggest": function (obj) {

                                                                    if (obj) {
                                                                        // Llenado masivo de los campos del proveedor
                                                                        if($$("tele_prov")) $$("tele_prov").setValue(obj.tele_prov || "");
                                                                        if($$("corr_prov")) $$("corr_prov").setValue(obj.corr_prov || "");
                                                                        if($$("rfc"))       $$("rfc").setValue(obj.rfc || "");
                                                                        if($$("proveedor")) $$("proveedor").setValue(obj.proveedor || "");
                                                                        if($$("domi_prov")) $$("domi_prov").setValue(obj.domi_prov || "");
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                ]
                                            },
                                            {height: 10},
                                            {
                                            
                                                cols: [
                                                    { view: "text", id: "tele_prov", name: "tele_prov", label: "Teléfono proveedor", labelWidth: 150, placeholder: "  -    -    ", required: true,},
                                                    {width: 20},
                                                    { view: "text", id: "corr_prov", name: "corr_prov", label: "Correo proveedor", labelWidth: 150, placeholder: "correo@correo.com", required: true, invalidMessage: "El Correo es invalido"}
                                                ]
                                            }]
                                        },
                                    },
                                    {view:"fieldset", label:"Datos entrega y forma de pago",  
									body:{ 
                                        rows: [
                                            {
                                                cols: [
                                                    { view: "datepicker", name: "fech_entr", label: "Fecha de entrega", labelWidth: 120, width: 250, required: true },
                                                    {width: 20},
                                                    { view: "radio", name: "forma_pago", label: "Forma Pago", labelWidth: 100, options: [{id:1, value:"Contado"},{id:2, value:"Parcialidades"}], vertical: false, required: true,
                                                        on: {
                                                    onChange: function(newv, oldv) {
                                                                // newv contiene el ID del elemento seleccionado (1 o 2)
                                                                if (newv) {
                                                                    //console.log("ID seleccionado:", newv);
                                                                    parcialidad(newv);
                                                                }
                                                            }
                                                        }
                                                    },
                                                    {width: 20},
                                                    { view: "counter", id: "parcialidad", name: "parcialidad", label: "Parcialidades", labelWidth: 100, min: 0, max: 100, hidden: true, required: true },
                                                    {width: 20},
                                                    { view: "counter", name: "porce_parc", label: "% Anticipo", min: 0, max: 100, required: true }
                                                ]
                                            }, 
                                            { id:"fech_serv", hidden: true, 
                                                cols: [
                                                    { view: "datepicker", id: "inci_serv", name: "inci_serv", label: "Fecha de incio del servicio", labelWidth: 200},
                                                    {width: 20},
                                                    { view: "datepicker", id: "fin_serv", name: "fin_serv", label: "Fecha de fin del servicio", labelWidth: 200},
                                                ]
                                            },                                  
                                            {
                                                cols: [
                                                    { view: "textarea", id: "domi_prov", name: "domi_prov", label: "Dirección del proveedor", labelPosition: "top", height: 120, required: true},
                                                    {width: 20},
                                                    { view: "textarea", id: "luga_entr", name: "pres_serv", label: "Lugar de entrega", labelPosition: "top", height: 120, required: true},
                                                    {width: 20},
                                                    { view: "textarea", name: "observaciones", label: "Observaciones", labelPosition: "top", height: 120},
                                                ]
                                            },
                                        ]}
                                    }
                                ]
                            }
                        },
                        {
                            header: "Artículos y costos",
                            body: {
                                rows: [
                                    {height:5},
                                    {
                                        cols: [
                                            { view: "textarea", name: "articulo", label: "Artículo o servicio", labelPosition: "top", height: 80},
                                            {width: 20},
                                            { view: "combo", name: "unidad", label: "Unidad", labelWidth: 80, options: ["N/A","CAJA","KG","LITRO","METRO","OTRA","PIEZA"], width: 100, labelPosition: "top"},
                                            { view: "text", name: "cantidad", label: "Cantidad", labelPosition: "top", width: 130},
                                            {width: 20},
                                            { view: "text", name: "cost_unit", label: "Costo unitario", labelPosition: "top", width: 130},
                                            {width: 20},
                                            { view: "text", name: "tasa_iva", label: "Tasa IVA", labelPosition: "top", width: 130},
                                            
                                        ]
                                    },
                                    {
                                        cols: [
                                            {},
                                            { view: "button", value: "Agregar artículo", css: "webix_primary", click: agregarArticulo, width: 150 },
                                            { view: "button", value: "Elimina artículo", click: eliminarArticulo, width: 150}
                                        ]
                                    },
                                    {
                                        view: "datatable",
                                        id: "detalles_tabla",
                                        autoheight: true,
                                        minHeight: 200,
                                        select: true,
                                        footer: true, // 1. Habilitamos el pie de página
                                        columns: [
                                            { 
                                                id: "articulo", 
                                                header: "Producto", 
                                                fillspace: true,
                                                footer: { text: "Totales:", css: "footer_total_text" } // Etiqueta en el pie
                                            },
                                            { id: "cantidad", header: "Cantidad", width: 130, css: { "text-align": "right" } },
                                            { id: "cost_unit", header: "Costo", width: 150, css: { "text-align": "right" }, format: webix.i18n.priceFormat },
                                            { id: "tasa_iva", header: "IVA", width: 100, css: { "text-align": "right" } },
                                            { 
                                                id: "subtotal", 
                                                header: "Subtotal", 
                                                width: 200, css: { "text-align": "right" },
                                                format: webix.i18n.priceFormat,
                                                footer: { content: "summColumn", css: { "text-align": "right" } } // 2. Sumatoria automática
                                            },
                                            { 
                                                id: "total", 
                                                header: "Total", 
                                                width: 200, css: { "text-align": "right" },
                                                format: webix.i18n.priceFormat,
                                                footer: { content: "summColumn", css: { "text-align": "right" } } // 3. Sumatoria automática
                                            }
                                        ],
                                        data: [] 
                                    },                                    
                                ]
                            }
                        },
                        {
                            header: "Datos generales",
                            body: {margin: 20,
                                rows: [
                                    {height:5},
                                    {
                                        cols: [
                                            { view: "text", id: "ures_proy", name: "ures_proy", label: "Código de URE", labelPosition: "top", readonly: true, required: true},
                                            { view: "text", id: "depe_proy", name: "depe_proy", label: "Dependencia del proyecto", labelPosition: "top", readonly: true, required: true},
                                        ]
                                    },
                                    {
                                        cols: [
                                            { view: "text", id: "tele_depe", name: "tele_depe", label: "Teléfono de la dependencia", labelPosition: "top", required: true},
                                            { view: "textarea", id: "dire_depe", name: "dire_depe", label: "Dirección dependencia", labelPosition: "top", height: 80, required: true  },
                                        ]
                                    },
        
                                    // Metemos la datatable dentro del array de elementos
                                ]
                            }
                        }
                    ]
                },
                {
                    margin: 10,
                    cols: [
                        {},
                        { view: "button", value: "Guardar Borrador", css: "webix_secondary", width: 150, click: guardar },
                        { view: "button", value: "Generar Orden", css: "webix_primary", width: 150, click: generar },
                        { view: "button", value: "Cancelar", width: 100 }
                    ]
                }
            ]
        },        
        );
        busc_depe(<%=rows[0].proyecto%>);
        });

        function busc_depe(nuevo) {
            
            //console.log(nuevo);
            webix.ajax().post("/api/fin/fin_norde_compx2", {proyecto:nuevo}).then((res)=>{
				res = res.json();
                //console.log(res)
                $$("ures_proy").setValue(res.cve_conv);
                $$("depe_proy").setValue(res.dependen);
                $$("tele_depe").setValue(res.telefono);
                $$("dire_depe").setValue(res.direccion);
                if($$("luga_entr")) $$("luga_entr").setValue(res.direccion || "");
                
			})

        }

        function deta_grup(id) {
            window.parent.$$("tbView").addView({
                header: "<span class='webix_icon mdi mdi-file-document-outline'></span>" + (id == undefined ? "Nuevo" : "Modifica") + " FOCAM",
                body: {
                    view: "iframe", src: "/progap/progap_nfocam?lnID=" + id,
                    type: {
                        height: 60
                    }
                },
                close: true
            });
            window.parent.$$("tbView").getTabbar().setValue(window.parent.$$("tbView").getTabbar().data.options[window.parent.$$("tbView").getTabbar().data.options.length - 1].id);
        }


        function agregar() {

            var checked = [];
            $$("dtable").data.each(function (obj) {
                if (obj.marcar == 1) checked.push(obj.id);
            });
            
            $$("dtable").remove(checked);
            window.parent.parent.carg_grupo(checked.toString());
        }

        function tipo(lnTipo){
            //console.log(lnTipo)
            let campoTexto = $$("luga_entr");
            if(lnTipo == 1){
                $$("fech_serv").hide();
                campoTexto.define("label", "Lugar de entrega");
            }
            else{
                $$("fech_serv").show();
                campoTexto.define("label", "Lugar prestación del servicio");
            }
            campoTexto.refresh();
        }

        function parcialidad(lnTipo){
            //console.log(lnTipo)
            if(lnTipo == 1){
                $$("parcialidad").hide();
            }
            else {
                $$("parcialidad").show();
            }
            
        }

        function agregarArticulo() {
            // 1. Obtenemos los valores del formulario
            // Asegúrate de que tu formulario tenga id: "form_orden"
            var valores = $$("form_orden").getValues();

            // 2. Validaciones básicas para evitar filas vacías
            if (!valores.articulo || !valores.cantidad || !valores.cost_unit) {
                webix.message({ type: "error", text: "Complete: Artículo, Cantidad y Costo" });
                return;
            }

            // 3. Cálculos matemáticos
            var cant = parseFloat(valores.cantidad) || 0;
            var costo = parseFloat(valores.cost_unit) || 0;
            var tasaIva = parseFloat(valores.tasa_iva) || 0;

            // Cálculo del Subtotal (Cantidad * Costo)
            var subtotal = cant * costo;
            
            // Cálculo del Total (Subtotal + el porcentaje de IVA)
            // Ejemplo: Si el IVA es 16, calcula: subtotal * 1.16
            var totalConIva = subtotal * (1 + (tasaIva / 100));

            // 4. Creamos el objeto con los nuevos IDs de las columnas
            var item = {
                articulo: valores.articulo,
                cantidad: cant,
                cost_unit: costo,
                tasa_iva: tasaIva,
                subtotal: subtotal,   // Monto sin IVA
                total: totalConIva,    // Monto con IVA
                unidad: valores.unidad // Guardado internamente aunque no esté en la columna
            };

            // 5. Agregamos a la cuadrícula
            $$("detalles_tabla").add(item);

            // 6. Limpiamos los campos de captura para el siguiente artículo
            // Usamos true para no borrar los datos generales de la orden (como folio o proveedor)
            $$("form_orden").setValues({
                articulo: "",
                unidad: "N/A",
                cantidad: "",
                cost_unit: "",
                tasa_iva: ""
            }, true);

            webix.message("Artículo añadido a la lista");
        }

    function eliminarArticulo() {
        var id = $$("detalles_tabla").getSelectedId();
        if (id) {
            $$("detalles_tabla").remove(id);
        } else {
            webix.message({ type: "error", text: "Seleccione un artículo para eliminar" });
        }
    }

    function guardar(){
        
        var datos = formulario.getValues();

        console.log(lnOrden)


    }

    function generar(){
        // Buscamos el formulario por su ID
        var formulario = $$("form_orden");

        if (formulario.validate()) {
            // Si pasa la validación, procedemos a guardar en Node.js
            var datos = formulario.getValues();
            webix.message("Datos validados, guardando...");
        } else {
            // Si falla, Webix marcará los campos en rojo automáticamente
            webix.message({ type: "error", text: "Revise los campos obligatorios" });
        }
    }

    </script>
</body>


</html>